
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>packerlabimaging.AllOpticalMain &#8212; packerlabimaging 0.1-alpha documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for packerlabimaging.AllOpticalMain</h1><div class="highlight"><pre>
<span></span><span class="c1"># TODO update all 2p stim related attr&#39;s to naparm submodule</span>

<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy.stats</span> <span class="k">as</span> <span class="nn">stats</span>
<span class="kn">import</span> <span class="nn">tifffile</span> <span class="k">as</span> <span class="nn">tf</span>

<span class="kn">from</span> <span class="nn">packerlabimaging.utils.utils</span> <span class="kn">import</span> <span class="n">convert_to_8bit</span><span class="p">,</span> <span class="n">normalize_dff</span><span class="p">,</span> <span class="n">UnavailableOptionError</span>
<span class="kn">from</span> <span class="nn">.TwoPhotonImagingMain</span> <span class="kn">import</span> <span class="n">TwoPhotonImagingTrial</span>
<span class="kn">from</span> <span class="nn">.processing.TwoPstim</span> <span class="kn">import</span> <span class="n">Targets</span>
<span class="c1"># %%</span>
<span class="kn">from</span> <span class="nn">.processing.anndata</span> <span class="kn">import</span> <span class="n">AnnotatedData</span>

<span class="c1"># grabbing functions from .utils_funcs that are used in this script - Prajay&#39;s edits (review based on need)</span>

<span class="n">PLANE</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">BADFRAMESLOC</span> <span class="o">=</span> <span class="s1">&#39;/home/pshah/Documents/code/packerlabimaging/tests/&#39;</span>


<span class="k">def</span> <span class="nf">getTargetImage</span><span class="p">():</span>  <span class="c1"># TODO write this function and probably add to the Targets class</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="AllOpticalTrial"><a class="viewcode-back" href="../../reference.html#packerlabimaging.AllOpticalTrial">[docs]</a><span class="k">class</span> <span class="nc">AllOpticalTrial</span><span class="p">(</span><span class="n">TwoPhotonImagingTrial</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class provides methods for All Optical experiments&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metainfo</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">naparm_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">analysis_save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">microscope</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">paq_options</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">prestim_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">poststim_sec</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span> <span class="n">pre_stim_response_window</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.500</span><span class="p">,</span>
                 <span class="n">post_stim_response_window</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.500</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param tiff_path: path to t-series .tiff</span>
<span class="sd">        :param paq_path: path to .Paq file associated with current t-series</span>
<span class="sd">        :param naparm_path: path to folder containing photostimulation setup built by NAPARM</span>
<span class="sd">        :param analysis_save_path: path of where to save the experiment analysis object</span>
<span class="sd">        :param metainfo: dictionary containing any metainfo information field needed for this experiment. At minimum it needs to include prep #, t-series # and date of data collection.</span>
<span class="sd">        :param microscope: name of microscope used to record imaging (options: &quot;Bruker&quot; (default), &quot;Scientifica&quot;, &quot;other&quot;)</span>
<span class="sd">        :param suite2p_path: (optional) path to suite2p outputs folder associated with this t-series (plane0 file? or ops file? not sure yet)</span>
<span class="sd">        :param make_downsampled_tiff: flag to run generation and saving of downsampled tiff of t-series (saves to the analysis save location)</span>
<span class="sd">        :param prestim_sec:</span>
<span class="sd">        :param poststim_sec:</span>
<span class="sd">        :param pre_stim_response_window:</span>
<span class="sd">        :param post_stim_response_window:</span>
<span class="sd">        :kwargs (optional):</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        metainfo</span>
<span class="sd">        naparm_path</span>
<span class="sd">        analysis_save_path</span>
<span class="sd">        microscope</span>
<span class="sd">        paq_options</span>
<span class="sd">        prestim_sec</span>
<span class="sd">        poststim_sec</span>
<span class="sd">        pre_stim_response_window</span>
<span class="sd">        post_stim_response_window</span>
<span class="sd">        kwargs</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Initialize Attributes:</span>

        <span class="c1"># PHOTOSTIM PROTOCOL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stim_start_times</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nomulti_sig_units</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stim_channel</span> <span class="o">=</span> <span class="n">paq_options</span><span class="p">[</span><span class="s1">&#39;stim_channel&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;stim_channel&#39;</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="o">*</span><span class="n">paq_options</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;markpoints2packio&#39;</span>  <span class="c1"># channel on Paq file to read for determining stims</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">photostim_frames</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># imaging frames that are classified as overlapping with photostimulation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stim_start_frames</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># frame numbers from the start of each photostim trial</span>

        <span class="c1"># Paq file attr&#39;s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paq_rate</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># PackIO acquisition rate for .Paq file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_start_times</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>  <span class="c1"># Paq clock timestamps of the first imaging acquisition frame of t-series</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_end_times</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>  <span class="c1"># Paq clock timestamps of the last imaging acquisition frame of t-series</span>

        <span class="c1"># set photostim trial Flu trace snippet collection and response measurement analysis time windows</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prestim_sec</span> <span class="o">=</span> <span class="n">prestim_sec</span>  <span class="c1"># length of pre stim trace collected (in frames)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poststim_sec</span> <span class="o">=</span> <span class="n">poststim_sec</span>  <span class="c1"># length of post stim trace collected (in frames)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pre_stim_response_window_msec</span> <span class="o">=</span> <span class="n">pre_stim_response_window</span>  <span class="c1"># time window for collecting pre-stim measurement (units: msec)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">post_stim_response_window_msec</span> <span class="o">=</span> <span class="n">post_stim_response_window</span>  <span class="c1"># time window for collecting post-stim measurement (units: msec)</span>

        <span class="c1"># attr&#39;s for statistical analysis of photostim trials responses</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">photostimResponsesData</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># anndata object for collecting photostim responses and associated metadata for experiment and cells</span>

        <span class="c1">######## TODO update comment descriptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_trials</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># all trials for each cell, dff detrended</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_amplitudes</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># all amplitudes of response between dff test periods</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">stas</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># avg of all trials for each cell, dff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sta_amplitudes</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># avg amplitude of response between dff test periods</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">prob_response</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># probability of response of cell to photostim trial; obtained from single trial significance (ROB suggestion)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_tests</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># result from related samples t-test between dff test periods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wilcoxons</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># ROB to update</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_units</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># ROB to update</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trial_sig_dff</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># based on dff increase above std of baseline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trial_sig_dfsf</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># based on df/std(f) increase in test period post-stim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sta_sig</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># based on t-test between dff test periods</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sta_sig_nomulti</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># as above, no multiple comparisons correction</span>
        <span class="c1">########</span>

        <span class="c1">#### initializing data processing, data analysis and/or results associated attr&#39;s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_trials</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># number of photostimulation trials TODO change to assigning from array: cells x Flu frames x # of photostim trials</span>

        <span class="c1">## PHOTOSTIM SLM TARGETS</span>
        <span class="c1"># TODO add attr&#39;s related to numpy array&#39;s and pandas dataframes for photostim trials - SLM targets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">responses_SLMtargets</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># dF/prestimF responses for all SLM targets for each photostim trial</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">responses_SLMtargets_tracedFF</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># poststim dFF - prestim dFF responses for all SLM targets for each photostim trial</span>

        <span class="c1">## ALL CELLS (from suite2p ROIs)</span>
        <span class="c1"># TODO add attr&#39;s related to numpy array&#39;s and pandas dataframes for photostim trials - suite2p ROIs</span>

        <span class="c1">#### FUNCTIONS TO RUN AFTER init&#39;s of ALL ATTR&#39;S</span>

        <span class="c1"># 1) initialize object as TwoPhotonImagingTrial</span>
        <span class="n">TwoPhotonImagingTrial</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metainfo</span><span class="o">=</span><span class="n">metainfo</span><span class="p">,</span> <span class="n">analysis_save_path</span><span class="o">=</span><span class="n">analysis_save_path</span><span class="p">,</span>
                                       <span class="n">microscope</span><span class="o">=</span><span class="n">microscope</span><span class="p">,</span> <span class="n">paq_options</span><span class="o">=</span><span class="n">paq_options</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># 2) get stim timings from paq file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stim_start_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_paqProcessingAllOptical</span><span class="p">(</span><span class="n">stim_channel</span><span class="o">=</span><span class="n">paq_options</span><span class="p">[</span><span class="s1">&#39;stim_channel&#39;</span><span class="p">],</span>
                                                               <span class="n">paq_path</span><span class="o">=</span><span class="n">paq_options</span><span class="p">[</span><span class="s1">&#39;paq_path&#39;</span><span class="p">])</span>

        <span class="c1"># 3) process 2p stim protocol</span>
        <span class="c1"># set naparm path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__naparm_path</span> <span class="o">=</span> <span class="n">naparm_path</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">naparm_path</span><span class="p">)</span> <span class="k">else</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;naparm path not found, naparm_path: </span><span class="si">{</span><span class="n">naparm_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Targets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_duration_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stimProcessing</span><span class="p">(</span><span class="n">protocol</span><span class="o">=</span><span class="s1">&#39;naparm&#39;</span><span class="p">)</span>

        <span class="c1"># 4) determine bad frames in imaging data that correspond to photostim frames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">photostim_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_photostim_add_bad_framesnpy</span><span class="p">()</span>

        <span class="c1"># 5) collect Flu traces from SLM targets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw_SLMTargets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dFF_SLMTargets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">meanFluImg_registered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collect_traces_from_targets</span><span class="p">(</span>
            <span class="n">curr_trial_frames</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">trial_frames</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targets_dff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets_dff_avg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets_dfstdF</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets_dfstdF_avg</span><span class="p">,</span> \
        <span class="bp">self</span><span class="o">.</span><span class="n">targets_raw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets_raw_avg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_alltargets_stim_traces_norm</span><span class="p">(</span><span class="n">process</span><span class="o">=</span><span class="s1">&#39;trace dFF&#39;</span><span class="p">)</span>

        <span class="c1"># 6) Collect Flu traces from Suite2p ROIs:</span>
        <span class="c1">#   create:</span>
        <span class="c1">#       1) array of dFF pre + post stim Flu snippets for each stim and cell [num cells x num peri-stim frames collected x num stims]</span>
        <span class="c1">#       2) photostim response amplitudes in a dataframe for each cell and each photostim</span>
        <span class="c1">#       3) save photostim response amplitudes to AnnotatedData</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">photostimFluArray</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">photostimResponseAmplitudes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">photostimResponsesData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">photostimProcessingAllCells</span><span class="p">()</span>

        <span class="c1"># extend annotated imaging data object with imaging frames in photostim and stim_start_frames as additional keys in vars</span>
        <span class="n">__frames_in_stim</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">n_frames</span>
        <span class="n">__stim_start_frame</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">n_frames</span>
        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">photostim_frames</span><span class="p">:</span> <span class="n">__frames_in_stim</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_start_frames</span><span class="p">:</span> <span class="n">__stim_start_frame</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">add_var</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;photostim_frame&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">__frames_in_stim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">add_var</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;stim_start_frame&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">__stim_start_frame</span><span class="p">)</span>

        <span class="c1"># save final object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;\----- CREATED AllOpticalTrial data object for </span><span class="si">{</span><span class="n">metainfo</span><span class="p">[</span><span class="s2">&quot;t series id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkl_path</span><span class="p">:</span>
            <span class="n">lastmod</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pkl_path</span><span class="p">))</span>
            <span class="n">information</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_series_name</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">information</span><span class="si">}</span><span class="s2">) TwoPhotonImagingTrial.alloptical experimental trial object, last saved: </span><span class="si">{</span><span class="n">lastmod</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot; -- unsaved TwoPhotonImagingTrial.alloptical experimental trial object -- &quot;</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;TwoPhotonImagingTrial.alloptical experimental trial object&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">paths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;TODO returns a dictionary of all paths associated with trial&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">naparm_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;setting location of naparm files that specify the photostimulation experiment setup&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__naparm_path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__naparm_path</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__naparm_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pre_stim_response_frames_window</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;num frames for measuring Flu trace before each photostimulation trial during photostim response measurement (units: frames)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">fps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_stim_response_window_msec</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pre_stim_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;num frames for collecting Flu trace after each photostimulation trial (units: frames)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prestim_sec</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">fps</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">post_stim_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;num frames for collecting Flu trace after each photostimulation trial (units: frames)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poststim_sec</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">fps</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">post_stim_response_frames_window</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;num frames for collecting Flu trace after each photostimulation trial (units: frames)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">fps</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_stim_response_window_msec</span><span class="p">)</span>  <span class="c1"># length of the post stim response test window (in frames)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">timeVector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;vector of frame times in milliseconds rather than frames&quot;&quot;&quot;</span>
        <span class="n">time_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">prestim_sec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">poststim_sec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">n_frames</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">time_vector</span>

    <span class="c1">### ALLOPTICAL EXPERIMENT PHOTOSTIM PROTOCOL PROCESSING</span>

    <span class="k">def</span> <span class="nf">_paqProcessingAllOptical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stim_channel</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">paq_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">paqdata</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Paq</span><span class="o">.</span><span class="n">paq_read</span><span class="p">(</span><span class="n">paq_path</span><span class="o">=</span><span class="n">paq_path</span><span class="p">)</span>
        <span class="n">stim_start_frames</span><span class="p">,</span> <span class="n">stim_start_times</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Paq</span><span class="o">.</span><span class="n">paq_alloptical_stims</span><span class="p">(</span><span class="n">paq_data</span><span class="o">=</span><span class="n">paqdata</span><span class="p">,</span>
                                                                            <span class="n">frame_clock</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Paq</span><span class="o">.</span><span class="n">frame_clock</span><span class="p">,</span>
                                                                            <span class="n">stim_channel</span><span class="o">=</span><span class="n">stim_channel</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">stim_start_frames</span>

    <span class="k">def</span> <span class="nf">_stimProcessing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;naparm&#39;</span><span class="p">):</span>
        <span class="n">_available_protocols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;naparm&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">protocol</span> <span class="o">==</span> <span class="s1">&#39;naparm&#39;</span><span class="p">:</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="n">Targets</span><span class="p">(</span><span class="n">naparm_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">naparm_path</span><span class="p">,</span> <span class="n">frame_x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">frame_x</span><span class="p">,</span>
                              <span class="n">frame_y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">frame_y</span><span class="p">,</span>
                              <span class="n">pix_sz_x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">pix_sz_x</span><span class="p">,</span> <span class="n">pix_sz_y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">pix_sz_y</span><span class="p">)</span>

            <span class="c1"># correct the following based on txt file</span>
            <span class="n">duration_ms</span> <span class="o">=</span> <span class="n">targets</span><span class="o">.</span><span class="n">stim_dur</span>
            <span class="n">frame_rate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">fps</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">n_planes</span>
            <span class="n">duration_frames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">duration_ms</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="n">frame_rate</span><span class="p">)</span>
            <span class="n">stim_duration_frames</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">duration_frames</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">targets</span><span class="p">,</span> <span class="n">stim_duration_frames</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnavailableOptionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">protocol</span><span class="si">}</span><span class="s2"> is not available for 2p stim processing. Available options are: </span><span class="si">{</span><span class="n">_available_protocols</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_findTargetedS2pROIs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;finding s2p cell ROIs that were also SLM targets (or more specifically within the target areas as specified by _findTargetAreas - include 15um radius from center coordinate of spiral)</span>
<span class="sd">        Make a binary mask of the targets and multiply by an image of the cells</span>
<span class="sd">        to find cells that were targeted</span>

<span class="sd">        --- LAST UPDATED NOV 6 2021 - copied over from Vape ---</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">\----- Searching for targeted cells in Suite2p ROIs... [Vape version]&#39;</span><span class="p">)</span>

        <span class="c1">## TODO add necessary edits for multi-plane experiments</span>

        <span class="c1">##### IDENTIFYING S2P ROIs THAT ARE WITHIN THE SLM TARGET SPIRAL AREAS</span>
        <span class="c1"># make all target area coords in to a binary mask</span>
        <span class="n">targ_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">frame_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">frame_y</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint16&#39;</span><span class="p">)</span>
        <span class="n">target_areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Targets</span><span class="o">.</span><span class="n">target_areas</span><span class="p">)</span>
        <span class="n">targ_img</span><span class="p">[</span><span class="n">target_areas</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">target_areas</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># make an image of every cell area, filled with the index of that cell</span>
        <span class="n">cell_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">targ_img</span><span class="p">)</span>

        <span class="n">cell_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">cell_x</span><span class="p">)</span>
        <span class="n">cell_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">cell_y</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">cell_x</span><span class="p">,</span> <span class="n">cell_y</span><span class="p">)):</span>
            <span class="n">cell_img</span><span class="p">[</span><span class="n">coord</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># binary mask x cell image to get the cells that overlap with target areas</span>
        <span class="n">targ_cell</span> <span class="o">=</span> <span class="n">cell_img</span> <span class="o">*</span> <span class="n">targ_img</span>

        <span class="n">targ_cell_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">targ_cell</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># correct the cell id due to zero indexing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targeted_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">n_units</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targeted_cells</span><span class="p">[</span><span class="n">targ_cell_ids</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># self.s2p_cell_targets = [self.cell_id[i] for i, x in enumerate(self.targeted_cells) if x is True]  # get ls of s2p cells that were photostim targetted</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s2p_cell_targets</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">cell_id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targeted_cells</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>  <span class="c1"># get ls of s2p cells that were photostim targetted</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_targeted_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targeted_cells</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">|- Search completed.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">|- Number of targeted cells: &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_targeted_cells</span><span class="p">)</span>

        <span class="c1">##### IDENTIFYING S2P ROIs THAT ARE WITHIN THE EXCLUSION ZONES OF THE SLM TARGETS</span>
        <span class="c1"># make all target area coords in to a binary mask</span>
        <span class="n">targ_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">frame_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">frame_y</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint16&#39;</span><span class="p">)</span>
        <span class="n">target_areas_exclude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Targets</span><span class="o">.</span><span class="n">target_areas_exclude</span><span class="p">)</span>
        <span class="n">targ_img</span><span class="p">[</span><span class="n">target_areas_exclude</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">target_areas_exclude</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># make an image of every cell area, filled with the index of that cell</span>
        <span class="n">cell_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">targ_img</span><span class="p">)</span>

        <span class="n">cell_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">cell_x</span><span class="p">)</span>
        <span class="n">cell_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">cell_y</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">cell_x</span><span class="p">,</span> <span class="n">cell_y</span><span class="p">)):</span>
            <span class="n">cell_img</span><span class="p">[</span><span class="n">coord</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># binary mask x cell image to get the cells that overlap with target areas</span>
        <span class="n">targ_cell</span> <span class="o">=</span> <span class="n">cell_img</span> <span class="o">*</span> <span class="n">targ_img</span>

        <span class="n">targ_cell_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">targ_cell</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># correct the cell id due to zero indexing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exclude_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">n_units</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;bool&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exclude_cells</span><span class="p">[</span><span class="n">targ_cell_ids</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s2p_cells_exclude</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">cell_id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span>
                                  <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exclude_cells</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span>  <span class="c1"># get ls of s2p cells that were photostim targetted</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_exclude_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exclude_cells</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">|-Search completed.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">|-Number of exclude Suite2p ROIs: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_exclude_cells</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># define non targets from suite2p ROIs (exclude cells in the SLM targets exclusion - .s2p_cells_exclude)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">s2p_nontargets</span> <span class="o">=</span> <span class="p">[</span><span class="n">cell</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">cell_id</span> <span class="k">if</span>
                                       <span class="n">cell</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">s2p_cells_exclude</span><span class="p">]</span>  <span class="c1">## exclusion of cells that are classified as s2p_cell_targets</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">|-Number of good, s2p non-target ROIs: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">s2p_nontargets</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>

            <span class="n">targ_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">frame_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">frame_y</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint16&#39;</span><span class="p">)</span>
            <span class="n">target_areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Targets</span><span class="o">.</span><span class="n">target_areas</span><span class="p">)</span>
            <span class="n">targ_img</span><span class="p">[</span><span class="n">target_areas</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">target_areas</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">targ_img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys_r&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;SLM targets areas&#39;</span><span class="p">)</span>
            <span class="c1"># for (x, y) in self.Targets.target_coords_all:</span>
            <span class="c1">#     ax.scatter(x=x, y=y, edgecolors=&#39;white&#39;, facecolors=&#39;none&#39;, linewidths=1.0)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># add targets classification as observations annotation to .data anndata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">add_observation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s1">&#39;photostim_target&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targeted_cells</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_find_photostim_add_bad_framesnpy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;finds all photostim frames and saves them into the bad_frames attribute for the exp object and saves bad_frames.npy&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">\----- Finding photostimulation frames in imaging frames ...&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;# of photostim frames calculated per stim. trial: &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_duration_frames</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">photostim_frames</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_start_frames</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stim_duration_frames</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># usually need to remove 1 more frame than the stim duration, as the stim isn&#39;t perfectly aligned with the start of the imaging frame</span>
                <span class="n">photostim_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>

        <span class="c1"># print(photostim_frames)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">|- Original # of frames:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">n_frames</span><span class="p">,</span> <span class="s1">&#39;frames&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">|- # of Photostim frames:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">photostim_frames</span><span class="p">),</span> <span class="s1">&#39;frames&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">|- Minus photostim. frames total:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">n_frames</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">photostim_frames</span><span class="p">),</span> <span class="s1">&#39;frames&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">photostim_frames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="c1"># f&#39;***Saving a total of {len(self.photostim_frames)} photostim frames to bad_frames.npy at: {self.tiff_path_dir}/bad_frames.npy&#39;)</span>
                <span class="sa">f</span><span class="s1">&#39;***Saving a total of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">photostim_frames</span><span class="p">)</span><span class="si">}</span><span class="s1"> photostim frames to bad_frames.npy at: </span><span class="si">{</span><span class="n">BADFRAMESLOC</span><span class="si">}</span><span class="s1">/bad_frames.npy&#39;</span><span class="p">)</span>  <span class="c1"># TODO replace BADFRAMESLOC with self.tiff_path_dir</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">tiff_path_dir</span><span class="si">}</span><span class="s1">/bad_frames.npy&#39;</span><span class="p">,</span>
                    <span class="n">photostim_frames</span><span class="p">)</span>  <span class="c1"># save to npy file and remember to move npy file to tiff folder before running with suite2p</span>

        <span class="k">return</span> <span class="n">photostim_frames</span>

    <span class="c1">#### TODO review attr&#39;s and write docs from the following functions: // start</span>
    <span class="c1"># used for creating tiffs that remove artifacts from alloptical experiments with photostim artifacts</span>
    <span class="k">def</span> <span class="nf">rm_artifacts_tiffs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tiffs_loc</span><span class="p">,</span> <span class="n">new_tiffs</span><span class="p">):</span>
        <span class="c1">### make a new tiff file (not for suite2p) with the first photostim frame whitened, and save new tiff</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">-----making processed photostim .tiff from:&#39;</span><span class="p">)</span>
        <span class="n">tiff_path</span> <span class="o">=</span> <span class="n">tiffs_loc</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">tiff_path</span><span class="p">)</span>
        <span class="n">im_stack</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">tiff_path</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing experiment tiff of shape: &#39;</span><span class="p">,</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">frames_to_whiten</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_start_frames</span><span class="p">:</span>
            <span class="n">frames_to_whiten</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>

        <span class="c1"># number of photostim frames with artifacts</span>
        <span class="n">frames_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_start_frames</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">stim_duration_frames</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># usually need to remove 1 more frame than the stim duration, as the stim isn&#39;t perfectly aligned with the start of the imaging frame</span>
                <span class="n">frames_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;# of total photostim artifact frames:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">frames_to_remove</span><span class="p">))</span>

        <span class="n">im_stack_1</span> <span class="o">=</span> <span class="n">im_stack</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">im_stack_1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="mf">5000.</span>
        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames_to_whiten</span><span class="p">:</span>
            <span class="n">im_stack_1</span><span class="p">[</span><span class="n">frame</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_stack_1</span><span class="p">[</span><span class="n">frame</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span>
            <span class="n">im_stack_1</span><span class="p">[</span><span class="n">frame</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_stack_1</span><span class="p">[</span><span class="n">frame</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span>
            <span class="n">im_stack_1</span><span class="p">[</span><span class="n">frame</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_stack_1</span><span class="p">[</span><span class="n">frame</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shape&#39;</span><span class="p">,</span> <span class="n">im_stack_1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">im_stack_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">im_stack_1</span><span class="p">,</span> <span class="n">frames_to_remove</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;After delete shape artifactrem&#39;</span><span class="p">,</span> <span class="n">im_stack_1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">save_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_tiffs</span> <span class="o">+</span> <span class="s2">&quot;_artifactrm.tif&quot;</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">im_stack_1</span><span class="p">,</span> <span class="n">photometric</span><span class="o">=</span><span class="s1">&#39;minisblack&#39;</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">im_stack_1</span>

        <span class="c1"># draw areas on top of im_stack_1 where targets are:</span>
        <span class="n">im_stack_2</span> <span class="o">=</span> <span class="n">im_stack</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Shape&#39;</span><span class="p">,</span> <span class="n">im_stack_2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">stim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Targets</span><span class="o">.</span><span class="n">n_groups</span><span class="p">):</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">im_stack_2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">targets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Targets</span><span class="o">.</span><span class="n">target_areas</span><span class="p">[</span><span class="n">stim</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">b</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5000</span>

            <span class="n">all_stim_start_frames</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">stim_frame</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_start_frames</span><span class="p">[</span><span class="n">stim</span><span class="p">::</span><span class="bp">self</span><span class="o">.</span><span class="n">Targets</span><span class="o">.</span><span class="n">n_groups</span><span class="p">]:</span>
                <span class="n">all_stim_start_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stim_frame</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">all_stim_start_frames</span><span class="p">:</span>
                <span class="n">im_stack_2</span><span class="p">[</span><span class="n">frame</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_stack_2</span><span class="p">[</span><span class="n">frame</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span>

        <span class="n">im_stack_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">im_stack_2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">photostim_frames</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;After delete shape targetcells&#39;</span><span class="p">,</span> <span class="n">im_stack_2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="n">save_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_tiffs</span> <span class="o">+</span> <span class="s1">&#39;_targetcells.tif&#39;</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">im_stack_2</span><span class="p">,</span> <span class="n">photometric</span><span class="o">=</span><span class="s1">&#39;minisblack&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;done saving to: &#39;</span><span class="p">,</span> <span class="n">save_path</span><span class="p">)</span>

        <span class="k">del</span> <span class="n">im_stack_2</span>
        <span class="k">del</span> <span class="n">im_stack</span>

    <span class="k">def</span> <span class="nf">s2pMasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s2p_path</span><span class="p">,</span> <span class="n">cell_ids</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">s2p_path</span><span class="p">)</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;stat.npy&#39;</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ops</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;ops.npy&#39;</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">iscell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;iscell.npy&#39;</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">mask_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ops</span><span class="p">[</span><span class="s1">&#39;Ly&#39;</span><span class="p">],</span> <span class="n">ops</span><span class="p">[</span><span class="s1">&#39;Lx&#39;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">iscell</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">cell_ids</span><span class="p">:</span>
                <span class="n">ypix</span> <span class="o">=</span> <span class="n">stat</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;ypix&#39;</span><span class="p">]</span>
                <span class="n">xpix</span> <span class="o">=</span> <span class="n">stat</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;xpix&#39;</span><span class="p">]</span>
                <span class="n">mask_img</span><span class="p">[</span><span class="n">ypix</span><span class="p">,</span> <span class="n">xpix</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3000</span>

        <span class="c1"># s2p targets - all SLM targets</span>
        <span class="n">targets_s2p_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ops</span><span class="p">[</span><span class="s1">&#39;Ly&#39;</span><span class="p">],</span> <span class="n">ops</span><span class="p">[</span><span class="s1">&#39;Lx&#39;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">iscell</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">s2p_cell_targets</span><span class="p">:</span>
                <span class="n">ypix</span> <span class="o">=</span> <span class="n">stat</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;ypix&#39;</span><span class="p">]</span>
                <span class="n">xpix</span> <span class="o">=</span> <span class="n">stat</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">&#39;xpix&#39;</span><span class="p">]</span>
                <span class="n">targets_s2p_img</span><span class="p">[</span><span class="n">ypix</span><span class="p">,</span> <span class="n">xpix</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3000</span>

        <span class="c1"># # s2p targets - SLM group #1 targets</span>
        <span class="c1"># targets_s2p_img_1 = np.zeros((ops[&#39;Ly&#39;], ops[&#39;Lx&#39;]), dtype=&#39;uint8&#39;)</span>
        <span class="c1"># for n in range(0, len(iscell)):</span>
        <span class="c1">#     if n in obj.s2p_cell_targets_1:</span>
        <span class="c1">#         ypix = stat[n][&#39;ypix&#39;]</span>
        <span class="c1">#         xpix = stat[n][&#39;xpix&#39;]</span>
        <span class="c1">#         targets_s2p_img_1[ypix, xpix] = 3000</span>
        <span class="c1">#</span>
        <span class="c1"># # s2p targets - SLM group #2 targets</span>
        <span class="c1"># targets_s2p_img_2 = np.zeros((ops[&#39;Ly&#39;], ops[&#39;Lx&#39;]), dtype=&#39;uint8&#39;)</span>
        <span class="c1"># for n in range(0, len(iscell)):</span>
        <span class="c1">#     if n in obj.s2p_cell_targets_2:</span>
        <span class="c1">#         ypix = stat[n][&#39;ypix&#39;]</span>
        <span class="c1">#         xpix = stat[n][&#39;xpix&#39;]</span>
        <span class="c1">#         targets_s2p_img_2[ypix, xpix] = 3000</span>

        <span class="k">return</span> <span class="n">mask_img</span><span class="p">,</span> <span class="n">targets_s2p_img</span><span class="p">,</span>  <span class="c1"># targets_s2p_img_1, targets_s2p_img_2</span>

<div class="viewcode-block" id="AllOpticalTrial.s2pMaskStack"><a class="viewcode-back" href="../../reference.html#packerlabimaging.AllOpticalTrial.s2pMaskStack">[docs]</a>    <span class="k">def</span> <span class="nf">s2pMaskStack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pkl_list</span><span class="p">,</span> <span class="n">s2p_path</span><span class="p">,</span> <span class="n">parent_folder</span><span class="p">,</span> <span class="n">force_redo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;makes a TIFF stack with the s2p mean image, and then suite2p ROI masks for all cells detected, target cells, and also SLM targets as well?&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">pkl</span> <span class="ow">in</span> <span class="n">pkl_list</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Retrieving s2p masks for:&#39;</span><span class="p">,</span> <span class="n">pkl</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># with open(pkl, &#39;rb&#39;) as f:</span>
            <span class="c1">#     self = pickle.load(f)</span>

            <span class="c1"># ls of cell ids to filter s2p masks by</span>
            <span class="c1"># cell_id_list = [ls(range(1, 99999)),  # all</span>
            <span class="c1">#                 self.photostim_r.cell_id[0],  # cells</span>
            <span class="c1">#                 [self.photostim_r.cell_id[0][i] for i, b in enumerate(self.photostim_r.cell_s1[0]) if</span>
            <span class="c1">#                  b == False],  # s2 cells</span>
            <span class="c1">#                 [self.photostim_r.cell_id[0][i] for i, b in enumerate(self.photostim_r.is_target) if</span>
            <span class="c1">#                  b == 1],  # pr cells</span>
            <span class="c1">#                 [self.photostim_s.cell_id[0][i] for i, b in enumerate(self.photostim_s.is_target) if</span>
            <span class="c1">#                  b == 1],  # ps cells</span>
            <span class="c1">#                 ]</span>
            <span class="c1">#</span>
            <span class="n">cell_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">cell_id</span>

            <span class="c1"># empty stack to fill with images</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">frame_y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">frame_x</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;uint8&#39;</span><span class="p">)</span>

            <span class="n">s2p_path</span> <span class="o">=</span> <span class="n">s2p_path</span>

            <span class="c1"># mean image from s2p</span>
            <span class="n">mean_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">s2pMeanImage</span><span class="p">(</span><span class="n">s2p_path</span><span class="p">)</span>
            <span class="n">mean_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">mean_img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">mean_img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># mask images from s2p</span>
            <span class="n">mask_img</span><span class="p">,</span> <span class="n">targets_s2p_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s2pMasks</span><span class="p">(</span><span class="n">s2p_path</span><span class="o">=</span><span class="n">s2p_path</span><span class="p">,</span> <span class="n">cell_ids</span><span class="o">=</span><span class="n">cell_ids</span><span class="p">)</span>
            <span class="n">mask_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">mask_img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">targets_s2p_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">targets_s2p_img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># targets_s2p_img_1 = np.expand_dims(targets_s2p_img_1, axis=0)</span>
            <span class="c1"># targets_s2p_img_2 = np.expand_dims(targets_s2p_img_2, axis=0)</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">mask_img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">targets_s2p_img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1"># stack = np.append(stack, targets_s2p_img_1, axis=0)</span>
            <span class="c1"># stack = np.append(stack, targets_s2p_img_2, axis=0)</span>

            <span class="c1"># # sta images</span>
            <span class="c1"># for file in os.listdir(stam_save_path):</span>
            <span class="c1">#     if all(s in file for s in [&#39;AvgImage&#39;, self.photostim_r.tiff_path.split(&#39;/&#39;)[-1]]):</span>
            <span class="c1">#         pr_sta_img = tf.imread(os.path.join(stam_save_path, file))</span>
            <span class="c1">#         pr_sta_img = np.expand_dims(pr_sta_img, axis=0)</span>
            <span class="c1">#     elif all(s in file for s in [&#39;AvgImage&#39;, self.photostim_s.tiff_path.split(&#39;/&#39;)[-1]]):</span>
            <span class="c1">#         ps_sta_img = tf.imread(os.path.join(stam_save_path, file))</span>
            <span class="c1">#         ps_sta_img = np.expand_dims(ps_sta_img, axis=0)</span>

            <span class="c1"># stack = np.append(stack, pr_sta_img, axis=0)</span>
            <span class="c1"># stack = np.append(stack, ps_sta_img, axis=0)</span>

            <span class="c1"># target images</span>
            <span class="n">targ_img</span> <span class="o">=</span> <span class="n">getTargetImage</span><span class="p">()</span>
            <span class="n">targ_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">targ_img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">targ_img</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># targ_img_1 = np.expand_dims(targ_img_1, axis=0)</span>
            <span class="c1"># stack = np.append(stack, targ_img_1, axis=0)</span>
            <span class="c1">#</span>
            <span class="c1"># targ_img_2 = np.expand_dims(targ_img_2, axis=0)</span>
            <span class="c1"># stack = np.append(stack, targ_img_2, axis=0)</span>

            <span class="c1"># stack is now: mean_img, all_rois, all_cells, s2_cells, pr_cells, ps_cells,</span>
            <span class="c1"># (whisker,) pr_sta_img, ps_sta_img, pr_target_areas, ps_target_areas</span>
            <span class="c1"># c, x, y = stack.shape</span>
            <span class="c1"># stack.shape = 1, 1, c, x, y, 1  # dimensions in TZCYXS order</span>

            <span class="n">x_pix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">pix_sz_x</span>
            <span class="n">y_pix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">pix_sz_y</span>

            <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_folder</span><span class="p">,</span> <span class="n">pkl</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_s2p_masks.tif&#39;</span><span class="p">)</span>

            <span class="n">tf</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">stack</span><span class="p">,</span> <span class="n">photometric</span><span class="o">=</span><span class="s1">&#39;minisblack&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">s2p ROI + photostim targets masks saved in TIFF to: &#39;</span><span class="p">,</span> <span class="n">save_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="AllOpticalTrial.STAProcessing"><a class="viewcode-back" href="../../reference.html#packerlabimaging.AllOpticalTrial.STAProcessing">[docs]</a>    <span class="k">def</span> <span class="nf">STAProcessing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plane</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Make stimulus triggered average (STA) traces and calculate the STA amplitude</span>
<span class="sd">        of response</span>

<span class="sd">        Input:</span>
<span class="sd">            plane - imaging plane n</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># make stas, [plane x cell x frame]</span>
        <span class="n">stas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_trials</span><span class="p">[</span><span class="n">plane</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stas</span><span class="p">)</span>

        <span class="c1"># make sta amplitudes, [plane x cell]</span>
        <span class="n">pre_sta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">stas</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_stim_frames</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">post_sta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">stas</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_stim_frames</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">sta_amplitudes</span> <span class="o">=</span> <span class="n">post_sta</span> <span class="o">-</span> <span class="n">pre_sta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sta_amplitudes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sta_amplitudes</span><span class="p">)</span></div>

    <span class="c1">####                                                                    // end</span>

    <span class="c1">### ALLOPTICAL PROCESSING OF TRACES</span>
    <span class="c1">## ... no methods determined here yet...</span>

    <span class="c1">### ALLOPTICAL ANALYSIS - FOCUS ON SLM TARGETS RELATED METHODS</span>
<div class="viewcode-block" id="AllOpticalTrial.collect_traces_from_targets"><a class="viewcode-back" href="../../reference.html#packerlabimaging.AllOpticalTrial.collect_traces_from_targets">[docs]</a>    <span class="k">def</span> <span class="nf">collect_traces_from_targets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">curr_trial_frames</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">reg_tif_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">save</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;uses registered tiffs to collect raw traces from SLM target areas&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">reg_tif_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">s2pResultsPath</span><span class="p">:</span>
                <span class="n">reg_tif_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">s2pResultsPath</span> <span class="o">+</span> <span class="s1">&#39;/reg_tif/&#39;</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;\- trying to load registerred tiffs from: </span><span class="si">{</span><span class="n">reg_tif_folder</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Must provide reg_tif_folder path for loading registered tiffs&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">reg_tif_folder</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no registered tiffs found at path: </span><span class="si">{</span><span class="n">reg_tif_folder</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">collecting raw Flu traces from SLM target coord. areas from registered TIFFs from: </span><span class="si">{</span><span class="n">reg_tif_folder</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># read in registered tiff</span>
        <span class="n">reg_tif_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">reg_tif_folder</span><span class="p">)</span>
        <span class="n">reg_tif_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">curr_trial_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2000</span>  <span class="c1"># 2000 because that is the batch size for suite2p run</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">curr_trial_frames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2000</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">mean_img_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">frame_x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">frame_y</span><span class="p">])</span>
        <span class="c1"># collect mean traces from target areas of each target coordinate by reading in individual registered tiffs that contain frames for current trial</span>
        <span class="n">targets_trace_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Targets</span><span class="o">.</span><span class="n">target_coords_all</span><span class="p">),</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
            <span class="n">tif_path_save2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">s2pResultsPath</span> <span class="o">+</span> <span class="s1">&#39;/reg_tif/&#39;</span> <span class="o">+</span> <span class="n">reg_tif_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">TiffFile</span><span class="p">(</span><span class="n">tif_path_save2</span><span class="p">,</span> <span class="n">multifile</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">input_tif</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|- reading tiff: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">tif_path_save2</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">input_tif</span><span class="o">.</span><span class="n">asarray</span><span class="p">()</span>

            <span class="n">targets_trace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Targets</span><span class="o">.</span><span class="n">target_coords_all</span><span class="p">),</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Targets</span><span class="o">.</span><span class="n">target_coords_all</span><span class="p">)):</span>
                <span class="n">target_areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Targets</span><span class="o">.</span><span class="n">target_areas</span><span class="p">)</span>  <span class="c1"># TODO update this so that it doesn&#39;t include the extra exclusion zone</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">target_areas</span><span class="p">[</span><span class="n">coord</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">target_areas</span><span class="p">[</span><span class="n">coord</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]]</span>  <span class="c1"># = 1</span>
                <span class="n">targets_trace</span><span class="p">[</span><span class="n">coord</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">targets_trace_full</span><span class="p">[:,</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">:</span> <span class="p">((</span><span class="n">i</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">)</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span>
                <span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">targets_trace</span>  <span class="c1"># iteratively write to each successive segment of the targets_trace array based on the length of the reg_tiff that is read in.</span>

            <span class="n">mean_img_stack</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># final part, crop to the *exact* frames for current trial</span>
        <span class="n">raw_SLMTargets</span> <span class="o">=</span> <span class="n">targets_trace_full</span><span class="p">[:,</span>
                         <span class="n">curr_trial_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">start</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">:</span> <span class="n">curr_trial_frames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">start</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">)]</span>

        <span class="n">dFF_SLMTargets</span> <span class="o">=</span> <span class="n">normalize_dff</span><span class="p">(</span><span class="n">raw_SLMTargets</span><span class="p">,</span> <span class="n">threshold_pct</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="n">meanFluImg_registered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mean_img_stack</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">()</span> <span class="k">if</span> <span class="n">save</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">raw_SLMTargets</span><span class="p">,</span> <span class="n">dFF_SLMTargets</span><span class="p">,</span> <span class="n">meanFluImg_registered</span></div>

<div class="viewcode-block" id="AllOpticalTrial.get_alltargets_stim_traces_norm"><a class="viewcode-back" href="../../reference.html#packerlabimaging.AllOpticalTrial.get_alltargets_stim_traces_norm">[docs]</a>    <span class="k">def</span> <span class="nf">get_alltargets_stim_traces_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">targets_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">subselect_cells</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                        <span class="n">pre_stim</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">post_stim</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">filter_sz</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">stims</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        primary function to measure the dFF and dF/setdF trace SNIPPETS for photostimulated targets.</span>
<span class="sd">        :param stims:</span>
<span class="sd">        :param targets_idx: integer for the index of target cell to process</span>
<span class="sd">        :param subselect_cells: ls of cells to subset from the overall set of traces (use in place of targets_idx if desired)</span>
<span class="sd">        :param pre_stim: number of frames to use as pre-stim</span>
<span class="sd">        :param post_stim: number of frames to use as post-stim</span>
<span class="sd">        :param filter_sz: whether to filter out stims that are occuring seizures</span>
<span class="sd">        :return: lists of individual targets dFF traces, and averaged targets dFF over all stims for each target</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">stims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stim_timings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_start_frames</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stim_timings</span> <span class="o">=</span> <span class="n">stims</span>

        <span class="k">if</span> <span class="n">process</span> <span class="o">==</span> <span class="s1">&#39;trace raw&#39;</span><span class="p">:</span>  <span class="c1">## specify which data to process (i.e. do you want to process whole trace dFF traces?)</span>
            <span class="n">data_to_process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_SLMTargets</span>
        <span class="k">elif</span> <span class="n">process</span> <span class="o">==</span> <span class="s1">&#39;trace dFF&#39;</span><span class="p">:</span>
            <span class="n">data_to_process</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dFF_SLMTargets</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;need to provide `process` as either `trace raw` or `trace dFF`&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">subselect_cells</span><span class="p">:</span>
            <span class="n">num_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_to_process</span><span class="p">[</span><span class="n">subselect_cells</span><span class="p">])</span>
            <span class="n">targets_trace</span> <span class="o">=</span> <span class="n">data_to_process</span><span class="p">[</span><span class="n">subselect_cells</span><span class="p">]</span>  <span class="c1">## NOTE USING .raw traces</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_to_process</span><span class="p">)</span>
            <span class="n">targets_trace</span> <span class="o">=</span> <span class="n">data_to_process</span>

        <span class="c1"># collect photostim timed average dff traces of photostim targets</span>
        <span class="n">targets_dff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">[</span><span class="n">num_cells</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_start_frames</span><span class="p">),</span> <span class="n">pre_stim</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_duration_frames</span> <span class="o">+</span> <span class="n">post_stim</span><span class="p">])</span>
        <span class="c1"># SLMTargets_stims_dffAvg = np.zeros([num_cells, pre_stim_sec + post_stim_sec])</span>

        <span class="n">targets_dfstdF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">[</span><span class="n">num_cells</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_start_frames</span><span class="p">),</span> <span class="n">pre_stim</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_duration_frames</span> <span class="o">+</span> <span class="n">post_stim</span><span class="p">])</span>
        <span class="c1"># targets_dfstdF_avg = np.zeros([num_cells, pre_stim_sec + post_stim_sec])</span>

        <span class="n">targets_raw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="p">[</span><span class="n">num_cells</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_start_frames</span><span class="p">),</span> <span class="n">pre_stim</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_duration_frames</span> <span class="o">+</span> <span class="n">post_stim</span><span class="p">])</span>
        <span class="c1"># targets_raw_avg = np.zeros([num_cells, pre_stim_sec + post_stim_sec])</span>

        <span class="k">if</span> <span class="n">targets_idx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;collecting stim traces for cell &#39;</span><span class="p">,</span> <span class="n">targets_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">flu</span> <span class="o">=</span> <span class="p">[</span><span class="n">targets_trace</span><span class="p">[</span><span class="n">targets_idx</span><span class="p">][</span><span class="n">stim</span> <span class="o">-</span> <span class="n">pre_stim</span><span class="p">:</span> <span class="n">stim</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_duration_frames</span> <span class="o">+</span> <span class="n">post_stim</span><span class="p">]</span> <span class="k">for</span> <span class="n">stim</span> <span class="ow">in</span>
                   <span class="n">stim_timings</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flu</span><span class="p">)):</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">flu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">mean_pre</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">pre_stim</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">process</span> <span class="o">==</span> <span class="s1">&#39;trace raw&#39;</span><span class="p">:</span>
                    <span class="n">trace_dff</span> <span class="o">=</span> <span class="p">((</span><span class="n">trace</span> <span class="o">-</span> <span class="n">mean_pre</span><span class="p">)</span> <span class="o">/</span> <span class="n">mean_pre</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                <span class="k">elif</span> <span class="n">process</span> <span class="o">==</span> <span class="s1">&#39;trace dFF&#39;</span><span class="p">:</span>
                    <span class="n">trace_dff</span> <span class="o">=</span> <span class="p">(</span><span class="n">trace</span> <span class="o">-</span> <span class="n">mean_pre</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;not sure how to calculate peri-stim traces...&#39;</span><span class="p">)</span>
                <span class="n">std_pre</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">pre_stim</span><span class="p">])</span>
                <span class="n">dFstdF</span> <span class="o">=</span> <span class="p">(</span><span class="n">trace</span> <span class="o">-</span> <span class="n">mean_pre</span><span class="p">)</span> <span class="o">/</span> <span class="n">std_pre</span>  <span class="c1"># make dF divided by std of pre-stim F trace</span>

                <span class="n">targets_raw</span><span class="p">[</span><span class="n">targets_idx</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">trace</span>
                <span class="n">targets_dff</span><span class="p">[</span><span class="n">targets_idx</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">trace_dff</span>
                <span class="n">targets_dfstdF</span><span class="p">[</span><span class="n">targets_idx</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dFstdF</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;shape of targets_dff[targets_idx]: </span><span class="si">{</span><span class="n">targets_dff</span><span class="p">[</span><span class="n">targets_idx</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">targets_raw</span><span class="p">[</span><span class="n">targets_idx</span><span class="p">],</span> <span class="n">targets_dff</span><span class="p">[</span><span class="n">targets_idx</span><span class="p">],</span> <span class="n">targets_dfstdF</span><span class="p">[</span><span class="n">targets_idx</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cell_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_cells</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;collecting stim traces for cell </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">subselect_cells</span><span class="p">[</span><span class="n">cell_idx</span><span class="p">])</span> <span class="k">if</span> <span class="n">subselect_cells</span> <span class="k">else</span> <span class="kc">None</span>

                <span class="n">flu</span> <span class="o">=</span> <span class="p">[</span><span class="n">targets_trace</span><span class="p">[</span><span class="n">cell_idx</span><span class="p">][</span><span class="n">stim</span> <span class="o">-</span> <span class="n">pre_stim</span><span class="p">:</span> <span class="n">stim</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_duration_frames</span> <span class="o">+</span> <span class="n">post_stim</span><span class="p">]</span> <span class="k">for</span>
                       <span class="n">stim</span> <span class="ow">in</span> <span class="n">stim_timings</span><span class="p">]</span>

                <span class="c1"># flu_dfstdF = []</span>
                <span class="c1"># flu_dff = []</span>
                <span class="c1"># flu = []</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flu</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">flu</span><span class="p">)):</span>
                        <span class="n">trace</span> <span class="o">=</span> <span class="n">flu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">mean_pre</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">pre_stim</span><span class="p">])</span>
                        <span class="n">trace_dff</span> <span class="o">=</span> <span class="p">((</span><span class="n">trace</span> <span class="o">-</span> <span class="n">mean_pre</span><span class="p">)</span> <span class="o">/</span> <span class="n">mean_pre</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
                        <span class="n">std_pre</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">trace</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">pre_stim</span><span class="p">])</span>
                        <span class="n">dFstdF</span> <span class="o">=</span> <span class="p">(</span><span class="n">trace</span> <span class="o">-</span> <span class="n">mean_pre</span><span class="p">)</span> <span class="o">/</span> <span class="n">std_pre</span>  <span class="c1"># make dF divided by std of pre-stim F trace</span>

                        <span class="n">targets_raw</span><span class="p">[</span><span class="n">cell_idx</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">trace</span>
                        <span class="n">targets_dff</span><span class="p">[</span><span class="n">cell_idx</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">trace_dff</span>
                        <span class="n">targets_dfstdF</span><span class="p">[</span><span class="n">cell_idx</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dFstdF</span>
                        <span class="c1"># flu_dfstdF.append(dFstdF)</span>
                        <span class="c1"># flu_dff.append(trace_dff)</span>

                <span class="c1"># targets_dff.append(flu_dff)  # contains all individual dFF traces for all stim times</span>
                <span class="c1"># SLMTargets_stims_dffAvg.append(np.nanmean(flu_dff, axis=0))  # contains the dFF trace averaged across all stim times</span>

                <span class="c1"># targets_dfstdF.append(flu_dfstdF)</span>
                <span class="c1"># targets_dfstdF_avg.append(np.nanmean(flu_dfstdF, axis=0))</span>

                <span class="c1"># SLMTargets_stims_raw.append(flu)</span>
                <span class="c1"># targets_raw_avg.append(np.nanmean(flu, axis=0))</span>

            <span class="n">targets_dff_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">targets_dff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">targets_dfstdF_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">targets_dfstdF</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">targets_raw_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">targets_raw</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;shape of targets_dff_avg: </span><span class="si">{</span><span class="n">targets_dff_avg</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">targets_dff</span><span class="p">,</span> <span class="n">targets_dff_avg</span><span class="p">,</span> <span class="n">targets_dfstdF</span><span class="p">,</span> <span class="n">targets_dfstdF_avg</span><span class="p">,</span> <span class="n">targets_raw</span><span class="p">,</span> <span class="n">targets_raw_avg</span></div>

    <span class="c1"># calculate reliability of photostim responsiveness of all of the targeted cells (found in s2p output) TODO need to review this whole section</span>
<div class="viewcode-block" id="AllOpticalTrial.get_SLMTarget_responses_dff"><a class="viewcode-back" href="../../reference.html#packerlabimaging.AllOpticalTrial.get_SLMTarget_responses_dff">[docs]</a>    <span class="k">def</span> <span class="nf">get_SLMTarget_responses_dff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">process</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">stims_to_use</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        calculations of dFF responses to photostimulation of SLM Targets. Includes calculating reliability of slm targets,</span>
<span class="sd">        saving success stim locations, and saving stim response magnitudes as pandas dataframe.</span>

<span class="sd">        :param threshold: dFF threshold above which a response for a photostim trial is considered a success.</span>
<span class="sd">        :param stims_to_use: ls of stims to retrieve photostim trial dFF responses</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">stims_to_use</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stims_to_use</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_start_frames</span><span class="p">))</span>
            <span class="n">stims_idx</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_start_frames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span> <span class="k">for</span> <span class="n">stim</span> <span class="ow">in</span> <span class="n">stims_to_use</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">stims_to_use</span><span class="p">:</span>
            <span class="n">stims_idx</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_start_frames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">stim</span><span class="p">)</span> <span class="k">for</span> <span class="n">stim</span> <span class="ow">in</span> <span class="n">stims_to_use</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;no stims set to analyse [1]&#39;</span><span class="p">)</span>

        <span class="c1"># choose between .SLMTargets_stims_dff and .SLMTargets_stims_tracedFF for data to process</span>
        <span class="k">if</span> <span class="n">process</span> <span class="o">==</span> <span class="s1">&#39;dF/prestimF&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;SLMTargets_stims_dff&#39;</span><span class="p">):</span>
                <span class="n">targets_traces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SLMTargets_stims_dff</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;no SLMTargets_stims_dff attr. [2]&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">process</span> <span class="o">==</span> <span class="s1">&#39;trace dFF&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;SLMTargets_stims_dff&#39;</span><span class="p">):</span>
                <span class="n">targets_traces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SLMTargets_tracedFF_stims_dff</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;no SLMTargets_tracedFF_stims_dff attr. [2]&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;need to assign to process: dF/prestimF or trace dFF&#39;</span><span class="p">)</span>

        <span class="c1"># initializing pandas df that collects responses of stimulations</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;SLMTargets_stims_dff&#39;</span><span class="p">):</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">stim</span> <span class="ow">in</span> <span class="n">stims_idx</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="n">stim</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">targets_traces</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">targets_traces</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>  <span class="c1"># population dataframe</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;no SLMTargets_stims_dff attr. [2]&#39;</span><span class="p">)</span>

        <span class="c1"># initializing pandas df for binary showing of success and fails (1= success, 0= fails)</span>
        <span class="n">hits_slmtargets</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># to be converted in pandas df below - will contain 1 for every success stim, 0 for non success stims</span>
        <span class="k">for</span> <span class="n">stim</span> <span class="ow">in</span> <span class="n">stims_idx</span><span class="p">:</span>
            <span class="n">hits_slmtargets</span><span class="p">[</span><span class="n">stim</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">targets_traces</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># start with 0 for all stims</span>
        <span class="n">hits_slmtargets_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">hits_slmtargets</span><span class="p">,</span>
                                          <span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">targets_traces</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>  <span class="c1"># population dataframe</span>

        <span class="n">reliability_slmtargets</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># dict will be used to store the reliability results for each targeted cell</span>

        <span class="c1"># dFF response traces for successful photostim trials</span>
        <span class="n">traces_dff_successes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">cell_ids</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
        <span class="k">for</span> <span class="n">target_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cell_ids</span><span class="p">)):</span>
            <span class="n">traces_dff_successes_l</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">success</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">responses</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">stim_idx</span> <span class="ow">in</span> <span class="n">stims_idx</span><span class="p">:</span>
                <span class="n">dff_trace</span> <span class="o">=</span> <span class="n">targets_traces</span><span class="p">[</span><span class="n">target_idx</span><span class="p">][</span><span class="n">stim_idx</span><span class="p">]</span>
                <span class="n">response_result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dff_trace</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pre_stim</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_duration_frames</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">pre_stim</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_duration_frames</span> <span class="o">+</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">post_stim_response_frames_window</span><span class="p">])</span>  <span class="c1"># calculate the dF over pre-stim mean F response within the response window</span>
                <span class="n">responses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">response_result</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">response_result</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">:</span>
                    <span class="n">success</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">hits_slmtargets_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">target_idx</span><span class="p">,</span> <span class="n">stim_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">traces_dff_successes_l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dff_trace</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">hits_slmtargets_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">target_idx</span><span class="p">,</span> <span class="n">stim_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">target_idx</span><span class="p">,</span> <span class="n">stim_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">response_result</span>
                <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">reliability_slmtargets</span><span class="p">[</span><span class="n">target_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">success</span> <span class="o">/</span> <span class="n">counter</span> <span class="o">*</span> <span class="mf">100.</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">traces_dff_successes</span><span class="p">[</span><span class="n">target_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">traces_dff_successes_l</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">reliability_slmtargets</span><span class="p">,</span> <span class="n">hits_slmtargets_df</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">traces_dff_successes</span></div>

    <span class="c1"># retrieves photostim avg traces for each SLM target, also calculates the reliability % for each SLM target</span>
<div class="viewcode-block" id="AllOpticalTrial.calculate_SLMTarget_SuccessStims"><a class="viewcode-back" href="../../reference.html#packerlabimaging.AllOpticalTrial.calculate_SLMTarget_SuccessStims">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_SLMTarget_SuccessStims</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hits_df</span><span class="p">,</span> <span class="n">process</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stims_idx_l</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                                         <span class="n">exclude_stims_targets</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;uses outputs of calculate_SLMTarget_responses_dff to calculate overall successrate of the specified stims</span>

<span class="sd">        :param hits_df: pandas dataframe of targets x stims where 1 denotes successful stim response (0 is failure)</span>
<span class="sd">        :param stims_idx_l: ls of stims to use for this function (useful when needing to filter out certain stims for in/out of sz)</span>
<span class="sd">        :param exclude_stims_targets: dictionary of stims (keys) where the values for each stim contains the targets that should be excluded from counting in the analysis of Success/failure of trial</span>

<span class="sd">        :return</span>
<span class="sd">            reliability_slmtargets: dict; reliability (% of successful stims) for each SLM target</span>
<span class="sd">            traces_SLMtargets_successes_avg: np.array; photostims avg traces for each SLM target (successful stims only)</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># choose between .SLMTargets_stims_dff and .SLMTargets_stims_tracedFF for data to process</span>
        <span class="k">if</span> <span class="n">process</span> <span class="o">==</span> <span class="s1">&#39;dF/prestimF&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;SLMTargets_stims_dff&#39;</span><span class="p">):</span>
                <span class="n">targets_traces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SLMTargets_stims_dff</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;no SLMTargets_stims_dff attr. [2]&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">process</span> <span class="o">==</span> <span class="s1">&#39;trace dFF&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;SLMTargets_stims_dff&#39;</span><span class="p">):</span>
                <span class="n">targets_traces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">SLMTargets_tracedFF_stims_dff</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;no SLMTargets_tracedFF_stims_dff attr. [2]&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;need to assign to process: dF/prestimF or trace dFF&#39;</span><span class="p">)</span>

        <span class="n">traces_SLMtargets_successes_avg_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">traces_SLMtargets_failures_avg_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">reliability_slmtargets</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">target_idx</span> <span class="ow">in</span> <span class="n">hits_df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">traces_SLMtargets_successes_l</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">traces_SLMtargets_failures_l</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">success</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">stim_idx</span> <span class="ow">in</span> <span class="n">stims_idx_l</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">stim_idx</span> <span class="ow">in</span> <span class="n">exclude_stims_targets</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">target_idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_stims_targets</span><span class="p">[</span><span class="n">stim_idx</span><span class="p">]:</span>
                        <span class="n">continu_</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">continu_</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">continu_</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">continu_</span><span class="p">:</span>
                    <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">hits_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">target_idx</span><span class="p">,</span> <span class="n">stim_idx</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">success</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">dff_trace</span> <span class="o">=</span> <span class="n">targets_traces</span><span class="p">[</span><span class="n">target_idx</span><span class="p">][</span><span class="n">stim_idx</span><span class="p">]</span>
                        <span class="n">traces_SLMtargets_successes_l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dff_trace</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">success</span> <span class="o">+=</span> <span class="mi">0</span>
                        <span class="n">dff_trace</span> <span class="o">=</span> <span class="n">targets_traces</span><span class="p">[</span><span class="n">target_idx</span><span class="p">][</span><span class="n">stim_idx</span><span class="p">]</span>
                        <span class="n">traces_SLMtargets_failures_l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dff_trace</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">reliability_slmtargets</span><span class="p">[</span><span class="n">target_idx</span><span class="p">]</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">success</span> <span class="o">/</span> <span class="n">counter</span> <span class="o">*</span> <span class="mf">100.</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">success</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">traces_SLMtargets_successes_avg_dict</span><span class="p">[</span><span class="n">target_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">traces_SLMtargets_successes_l</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">success</span> <span class="o">&lt;</span> <span class="n">counter</span><span class="p">:</span>  <span class="c1"># this helps protect against cases where a trial is 100% successful (and there&#39;s no failures).</span>
                <span class="n">traces_SLMtargets_failures_avg_dict</span><span class="p">[</span><span class="n">target_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">traces_SLMtargets_failures_l</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">reliability_slmtargets</span><span class="p">,</span> <span class="n">traces_SLMtargets_successes_avg_dict</span><span class="p">,</span> <span class="n">traces_SLMtargets_failures_avg_dict</span></div>

    <span class="c1">### ALLOPTICAL ANALYSIS - FOR ALL CELLS FROM SUITE2P  # good progress on this, almost done reviewing</span>
    <span class="c1">#### TEMP - need to ask about these two functions from</span>

    <span class="c1">### TODO ROB: how important are these two functions? I also see that detrending is commented out in makeFluTrials - should we include or not?</span>

    <span class="k">def</span> <span class="nf">_baselineFluTrial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flu_trial</span><span class="p">,</span> <span class="n">stim_end</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Subtract baseline from dff trials to normalise across cells</span>

<span class="sd">        Inputs:</span>
<span class="sd">            flu_trial           - [cell x frame] dff trial for all cells</span>
<span class="sd">        Outputs:</span>
<span class="sd">            baselined_flu_trial - detrended dff trial with zeros replacing stim artifact</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># baseline the flu_trial using pre-stim period mean flu for each cell</span>
        <span class="n">baseline_flu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">flu_trial</span><span class="p">[:,</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">pre_stim_frames</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># repeat the baseline_flu value across all frames for each cell</span>
        <span class="n">baseline_flu_stack</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">baseline_flu</span><span class="p">,</span> <span class="n">flu_trial</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">flu_trial</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="c1"># subtract baseline values for each cell</span>
        <span class="n">baselined_flu_trial</span> <span class="o">=</span> <span class="n">flu_trial</span> <span class="o">-</span> <span class="n">baseline_flu_stack</span>

        <span class="c1"># set stim artifact period to 0</span>
        <span class="n">baselined_flu_trial</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_stim_frames</span><span class="p">:</span><span class="n">stim_end</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">baselined_flu_trial</span>

    <span class="k">def</span> <span class="nf">_detrendFluTrial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flu_trial</span><span class="p">,</span> <span class="n">stim_end</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Detrend dff trials to account for drift of signal over a trial</span>

<span class="sd">        Inputs:</span>
<span class="sd">            flu_trial           - [cell x frame] dff trial for all cells</span>
<span class="sd">            stim_end            - frame n of the stim end</span>
<span class="sd">        Outputs:</span>
<span class="sd">            detrended_flu_trial - detrended dff trial with zeros replacing stim artifact</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># set stim artifact period to 0</span>
        <span class="n">flu_trial</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_frames</span><span class="p">:</span><span class="n">stim_end</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># detrend and baseline-subtract the flu trial for all cells</span>
        <span class="n">detrended_flu_trial</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">baselined_flu_trial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_baselineFluTrial</span><span class="p">(</span><span class="n">detrended_flu_trial</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">baselined_flu_trial</span>

    <span class="c1">#### TEMP // end</span>

    <span class="k">def</span> <span class="nf">_makePhotostimTrialFluSnippets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plane_flu</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">plane</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                       <span class="n">stim_frames</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>  <span class="c1"># base code copied from Vape&#39;s _makeFluTrials</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make Flu snippets timed on photostimulation, for each cell, for each stim instance. [cells x Flu frames x stims]  # TODO triple check order of this array&#39;s dimensions</span>

<span class="sd">        Inputs:</span>
<span class="sd">            plane_flu   - array of dff traces for all cells for this plane only</span>
<span class="sd">            plane       - imaging plane corresponding to plane_flu, default = 0 (for one plane datasets)</span>
<span class="sd">            stim_frames - optional, if provided then only use these photostim frames to collect photostim_array</span>
<span class="sd">        Outputs:</span>
<span class="sd">            photostim_array     - dFF peri-photostim Flu array [cell x Flu frames x trial]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">\- Collecting peri-stim traces ...&#39;</span><span class="p">)</span>

        <span class="n">trial_array</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">_stims</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_start_frames</span> <span class="k">if</span> <span class="n">stim_frames</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">stim_frames</span>

        <span class="k">assert</span> <span class="n">plane_flu</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;plane_flu needs to be of ndim: 2&#39;</span>
        <span class="k">assert</span> <span class="n">_stims</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_start_frames</span><span class="p">,</span> <span class="s2">&quot;stims not found in the stim frames list of this plane&quot;</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">stim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">_stims</span><span class="p">):</span>
            <span class="c1"># get frame indices of entire trial from pre-stim start to post-stim end</span>
            <span class="n">trial_frames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span><span class="n">stim</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_stim_frames</span><span class="p">:</span> <span class="n">stim</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_stim_frames</span><span class="p">]</span>

            <span class="c1"># use trial frames to extract this trial for every cell</span>
            <span class="n">flu_trial</span> <span class="o">=</span> <span class="n">plane_flu</span><span class="p">[:,</span> <span class="n">trial_frames</span><span class="p">]</span>
            <span class="n">flu_trial_len</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_stim_frames</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_stim_frames</span>
            <span class="n">stim_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_stim_frames</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_duration_frames</span>

            <span class="c1"># catch timeseries which ended in the middle of an ongoing photostim instance</span>
            <span class="k">if</span> <span class="n">flu_trial</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">flu_trial_len</span><span class="p">:</span>
                <span class="n">flu_trial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_baselineFluTrial</span><span class="p">(</span><span class="n">flu_trial</span><span class="p">,</span> <span class="n">stim_end</span><span class="p">)</span>
                <span class="c1"># only append trials of the correct length - will catch corrupt/incomplete data and not include</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trial_array</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">trial_array</span> <span class="o">=</span> <span class="n">flu_trial</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">trial_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">trial_array</span><span class="p">,</span> <span class="n">flu_trial</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;**incomplete trial detected and not appended to trial_array**&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Finished collecting peri-stim traces, out shape: </span><span class="si">{</span><span class="n">trial_array</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">trial_array</span>

    <span class="k">def</span> <span class="nf">collectPhotostimResponses</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">photostimFluArray</span><span class="p">):</span>

        <span class="c1"># create parameters, slices, and subsets for making pre-stim and post-stim arrays to use in stats comparison</span>
        <span class="c1"># test_period = self.pre_stim_response_window / 1000  # sec</span>
        <span class="c1"># self.test_frames = int(self.imparams.fps * test_period)  # test period for stats</span>

        <span class="c1"># mean pre and post stimulus (within post-stim response window) flu trace values for all cells, all trials</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__analysis_array</span> <span class="o">=</span> <span class="n">photostimFluArray</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__pre_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__analysis_array</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_stim_test_slice</span><span class="p">,</span> <span class="p">:],</span>
                                   <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [cells x prestim frames] (avg&#39;d taken over all stims)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__post_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__analysis_array</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_stim_test_slice</span><span class="p">,</span> <span class="p">:],</span>
                                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [cells x poststim frames] (avg&#39;d taken over all stims)</span>

        <span class="c1"># Vape&#39;s version for collection photostim response amplitudes</span>
        <span class="c1"># calculate amplitude of response for all cells, all trials</span>
        <span class="n">all_amplitudes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__post_array</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">__pre_array</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">n_units</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_start_frames</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">all_amplitudes</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>

    <span class="k">def</span> <span class="nf">_allCellsPhotostimResponsesAnndata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">photostimResponseAmplitudes</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>  <span class="c1"># NOT TESTED!</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates annotated data (see anndata library) object based around the Ca2+ matrix of the imaging trial.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># try:</span>
        <span class="c1"># SETUP THE OBSERVATIONS (CELLS) ANNOTATIONS TO USE IN anndata</span>
        <span class="c1"># build dataframe for obs_meta from suite2p stat information</span>
        <span class="n">obs_meta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;original_index&#39;</span><span class="p">,</span> <span class="s1">&#39;photostim_target&#39;</span><span class="p">,</span> <span class="s1">&#39;photostim_exclusion_zone&#39;</span><span class="p">,</span> <span class="s1">&#39;prob_response&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;sig_responder&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">n_units</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">obs_meta</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="n">obs_meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="s1">&#39;original_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">stat</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="s1">&#39;original_index&#39;</span><span class="p">]</span>
        <span class="n">obs_meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;photostim_target&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">targeted_cells</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;targeted_cells&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">obs_meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;photostim_exclusion_zone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exclude_cells</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;exclude_cells&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">obs_meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;prob_response&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_response</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;prob_response&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">obs_meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">&#39;sig_responder&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig_units</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;sig_units&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="c1"># SETUP THE VARIABLES ANNOTATIONS TO USE IN anndata</span>
        <span class="c1"># build dataframe for var annot&#39;s from Paq file</span>
        <span class="n">var_meta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Paq</span><span class="o">.</span><span class="n">paq_channels</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_start_frames</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fr_idx</span><span class="p">,</span> <span class="n">fr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_start_frames</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="p">[</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">Paq</span><span class="o">.</span><span class="n">sparse_paq_data</span><span class="p">]:</span>
                <span class="n">var_meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">fr</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Paq</span><span class="o">.</span><span class="n">sparse_paq_data</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">fr_idx</span><span class="p">]</span>
        <span class="n">photostimResponseAmplitudes</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">var_meta</span><span class="o">.</span><span class="n">columns</span>
        <span class="c1"># var_meta.columns = photostimResponseAmplitudes.columns</span>

        <span class="c1"># BUILD LAYERS TO ADD TO anndata OBJECT</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;singleTrialSignificance&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">photostimResponseAmplitudes</span><span class="p">)</span>
                  <span class="c1"># PLACEHOLDER NOT IMPLEMENTED YET</span>
                  <span class="p">}</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">\----- CREATING annotated data object for photostim responses using AnnData:&quot;</span><span class="p">)</span>
        <span class="n">adata</span> <span class="o">=</span> <span class="n">AnnotatedData</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">photostimResponseAmplitudes</span><span class="p">),</span> <span class="n">obs</span><span class="o">=</span><span class="n">obs_meta</span><span class="p">,</span> <span class="n">var</span><span class="o">=</span><span class="n">var_meta</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="n">layers</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="si">{</span><span class="n">adata</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">adata</span>

        <span class="c1"># except Exception:</span>
        <span class="c1">#     raise Warning(&quot;could not create anndata. anndata creation only available if .photostimResponseAmplitudes have been collected (run .photostimProcessingAllCells())&#39;)&quot;)</span>

<div class="viewcode-block" id="AllOpticalTrial.photostimProcessingAllCells"><a class="viewcode-back" href="../../reference.html#packerlabimaging.AllOpticalTrial.photostimProcessingAllCells">[docs]</a>    <span class="k">def</span> <span class="nf">photostimProcessingAllCells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plane</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>  <span class="c1"># NOTE: not setup for multi-plane imaging processing yet...</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Take dfof trace for entire timeseries and break it up in to individual trials, calculate</span>
<span class="sd">        the mean amplitudes of response and statistical significance across all trials</span>

<span class="sd">        Inputs:</span>
<span class="sd">            plane             - imaging plane n</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">----------------------------------------------------------------&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;running trial Processing for all cells &#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;----------------------------------------------------------------&#39;</span><span class="p">)</span>

        <span class="c1"># make trial arrays from dff data shape: [cells x stims x frames]</span>

        <span class="n">photostimFluArray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_makePhotostimTrialFluSnippets</span><span class="p">(</span><span class="n">plane_flu</span><span class="o">=</span><span class="n">normalize_dff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">raw</span><span class="p">))</span>
        <span class="n">photostimResponseAmplitudes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collectPhotostimResponses</span><span class="p">(</span><span class="n">photostimFluArray</span><span class="p">)</span>

        <span class="c1">## create new anndata object for storing measured photostim responses from data, with other relevant data</span>
        <span class="n">photostim_responses_adata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allCellsPhotostimResponsesAnndata</span><span class="p">(</span>
            <span class="n">photostimResponseAmplitudes</span><span class="o">=</span><span class="n">photostimResponseAmplitudes</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">photostimFluArray</span><span class="p">,</span> <span class="n">photostimResponseAmplitudes</span><span class="p">,</span> <span class="n">photostim_responses_adata</span></div>

<div class="viewcode-block" id="AllOpticalTrial.statisticalProcessingAllCells"><a class="viewcode-back" href="../../reference.html#packerlabimaging.AllOpticalTrial.statisticalProcessingAllCells">[docs]</a>    <span class="k">def</span> <span class="nf">statisticalProcessingAllCells</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Runs statistical processing on photostim response arrays&quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">packerlabimaging.processing.stats</span> <span class="kn">import</span> <span class="n">AllOpticalStats</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wilcoxons</span> <span class="o">=</span> <span class="n">AllOpticalStats</span><span class="o">.</span><span class="n">runWilcoxonsTest</span><span class="p">(</span><span class="n">array1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__pre_array</span><span class="p">,</span> <span class="n">array2</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__post_array</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_units</span> <span class="o">=</span> <span class="n">AllOpticalStats</span><span class="o">.</span><span class="n">sigTestAvgResponse</span><span class="p">(</span><span class="bp">self</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">p_vals</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">wilcoxons</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pre_stim_test_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;num of prestim frames used for quantification of photostim responses&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pre_stim_frames</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_stim_response_frames_window</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_stim_frames</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">post_stim_test_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;num of poststim frames used for quantification of photostim responses&quot;&quot;&quot;</span>
        <span class="n">stim_end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_stim_frames</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_duration_frames</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">s_</span><span class="p">[</span><span class="n">stim_end</span><span class="p">:</span> <span class="n">stim_end</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_stim_response_frames_window</span><span class="p">]</span>

    <span class="c1">## NOT REVIEWED FOR USAGE YET</span>
    <span class="k">def</span> <span class="nf">_probResponse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plane</span><span class="p">,</span>
                      <span class="n">trial_sig_calc</span><span class="p">):</span>  <span class="c1">## FROM VAPE&#39;S CODE, TODO NEED TO CHOOSE BETWEEN HERE AND BOTTOM RELIABILITY CODE</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the response probability, i.e. proportion of trials that each cell responded on</span>

<span class="sd">        Inputs:</span>
<span class="sd">            plane          - imaging plane n</span>
<span class="sd">            trial_sig_calc - indicating which calculation was used for significance testing (&#39;dff&#39;/&#39;dfsf&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_trials</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_trials</span>

        <span class="c1"># get the number of responses for each across all trials</span>
        <span class="k">if</span> <span class="n">trial_sig_calc</span> <span class="o">==</span> <span class="s1">&#39;dff&#39;</span><span class="p">:</span>
            <span class="n">num_respond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trial_sig_dff</span><span class="p">[</span><span class="n">plane</span><span class="p">])</span>  <span class="c1"># trial_sig_dff is [plane][cell][trial]</span>
        <span class="k">elif</span> <span class="n">trial_sig_calc</span> <span class="o">==</span> <span class="s1">&#39;dfsf&#39;</span><span class="p">:</span>
            <span class="n">num_respond</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trial_sig_dfsf</span><span class="p">[</span><span class="n">plane</span><span class="p">])</span>

        <span class="c1"># calculate the proportion of all trials that each cell responded on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prob_response</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">num_respond</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_trials</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cellStaProcessing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test</span><span class="o">=</span><span class="s1">&#39;t_test&#39;</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_start_frames</span><span class="p">:</span>

            <span class="c1"># this is the key parameter for the sta, how many frames before and after the stim onset do you want to use</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pre_frames</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">fps</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">))</span>  <span class="c1"># 500 ms pre-stim period</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">post_frames</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">fps</span> <span class="o">*</span> <span class="mi">3</span><span class="p">))</span>  <span class="c1"># 3000 ms post-stim period</span>

            <span class="c1"># ls of cell pixel intensity values during each stim on each trial</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_trials</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># ls 1 = cells, ls 2 = trials, ls 3 = dff vector</span>

            <span class="c1"># the average of every trial</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stas</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># ls 1 = cells, ls 2 = sta vector</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">all_amplitudes</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sta_amplitudes</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">t_tests</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wilcoxons</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">n_planes</span><span class="p">):</span>

                <span class="n">all_trials</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># ls 1 = cells, ls 2 = trials, ls 3 = dff vector</span>

                <span class="n">stas</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># ls 1 = cells, ls 2 = sta vector</span>

                <span class="n">all_amplitudes</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">sta_amplitudes</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">t_tests</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">wilcoxons</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="c1"># loop through each cell</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">unit</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="p">[</span><span class="n">plane</span><span class="p">]):</span>

                    <span class="n">trials</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">amplitudes</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">df</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="c1"># a flat ls of all observations before stim occured</span>
                    <span class="n">pre_obs</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># a flat ls of all observations after stim occured</span>
                    <span class="n">post_obs</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">for</span> <span class="n">stim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_start_frames</span><span class="p">:</span>
                        <span class="c1"># get baseline values from pre_stim_sec</span>
                        <span class="n">pre_stim_f</span> <span class="o">=</span> <span class="n">unit</span><span class="p">[</span><span class="n">stim</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_frames</span><span class="p">:</span> <span class="n">stim</span><span class="p">]</span>
                        <span class="n">baseline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pre_stim_f</span><span class="p">)</span>

                        <span class="c1"># the whole trial and dfof using baseline</span>
                        <span class="n">trial</span> <span class="o">=</span> <span class="n">unit</span><span class="p">[</span><span class="n">stim</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_frames</span><span class="p">:</span> <span class="n">stim</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_frames</span><span class="p">]</span>
                        <span class="n">trial</span> <span class="o">=</span> <span class="p">[((</span><span class="n">f</span> <span class="o">-</span> <span class="n">baseline</span><span class="p">)</span> <span class="o">/</span> <span class="n">baseline</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">trial</span><span class="p">]</span>  <span class="c1"># dff calc</span>
                        <span class="n">trials</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span>

                        <span class="c1"># calc amplitude of response</span>
                        <span class="n">pre_f</span> <span class="o">=</span> <span class="n">trial</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_frames</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="n">pre_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pre_f</span><span class="p">)</span>

                        <span class="n">avg_post_start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_frames</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stim_duration_frames</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">avg_post_end</span> <span class="o">=</span> <span class="n">avg_post_start</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">fps</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">))</span>  <span class="c1"># post-stim period of 500 ms</span>

                        <span class="n">post_f</span> <span class="o">=</span> <span class="n">trial</span><span class="p">[</span><span class="n">avg_post_start</span><span class="p">:</span> <span class="n">avg_post_end</span><span class="p">]</span>
                        <span class="n">post_f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">post_f</span><span class="p">)</span>
                        <span class="n">amplitude</span> <span class="o">=</span> <span class="n">post_f</span> <span class="o">-</span> <span class="n">pre_f</span>
                        <span class="n">amplitudes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">amplitude</span><span class="p">)</span>

                        <span class="c1"># append to flat lists</span>
                        <span class="n">pre_obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pre_f</span><span class="p">)</span>
                        <span class="n">post_obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">post_f</span><span class="p">)</span>

                    <span class="n">trials</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trials</span><span class="p">)</span>
                    <span class="n">all_trials</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trials</span><span class="p">)</span>

                    <span class="c1"># average amplitudes across trials</span>
                    <span class="n">amplitudes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">amplitudes</span><span class="p">)</span>
                    <span class="n">all_amplitudes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">amplitudes</span><span class="p">)</span>
                    <span class="n">sta_amplitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">amplitudes</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">sta_amplitudes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sta_amplitude</span><span class="p">)</span>

                    <span class="c1"># average across all trials</span>
                    <span class="n">sta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">stas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sta</span><span class="p">)</span>

                    <span class="c1"># remove nans from flat lists</span>
                    <span class="n">pre_obs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pre_obs</span> <span class="k">if</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
                    <span class="n">post_obs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">post_obs</span> <span class="k">if</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>

                    <span class="c1"># t_test and man whit test pre and post stim (any other test could also be used here)</span>
                    <span class="n">t_test</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">ttest_rel</span><span class="p">(</span><span class="n">pre_obs</span><span class="p">,</span> <span class="n">post_obs</span><span class="p">)</span>
                    <span class="n">t_tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t_test</span><span class="p">)</span>

                    <span class="n">wilcoxon</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">wilcoxon</span><span class="p">(</span><span class="n">pre_obs</span><span class="p">,</span> <span class="n">post_obs</span><span class="p">)</span>
                    <span class="n">wilcoxons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wilcoxon</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">all_trials</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_trials</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stas</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">all_amplitudes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_amplitudes</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sta_amplitudes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sta_amplitudes</span><span class="p">))</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">t_tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t_tests</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wilcoxons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">wilcoxons</span><span class="p">))</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">avg_post_start</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">avg_post_end</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">pre_frames</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stas</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stas</span><span class="p">[</span><span class="mi">10</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stas</span><span class="p">[</span><span class="mi">15</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">staSignificance</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">singleTrialSignificance</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">staSignificance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sta_sig</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">n_planes</span><span class="p">):</span>

            <span class="c1"># set this to true if you want to multiple comparisons correct for the number of cells</span>
            <span class="n">multi_comp_correction</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">multi_comp_correction</span><span class="p">:</span>
                <span class="n">divisor</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">divisor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_units</span><span class="p">[</span><span class="n">plane</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">test</span> <span class="o">==</span> <span class="s1">&#39;t_test&#39;</span><span class="p">:</span>
                <span class="n">p_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_tests</span><span class="p">[</span><span class="n">plane</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">test</span> <span class="o">==</span> <span class="s1">&#39;wilcoxon&#39;</span><span class="p">:</span>
                <span class="n">p_vals</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wilcoxons</span><span class="p">[</span><span class="n">plane</span><span class="p">]]</span>

            <span class="k">if</span> <span class="n">multi_comp_correction</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;performing t-test on cells with mutliple comparisons correction&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;performing t-test on cells without mutliple comparisons correction&#39;</span><span class="p">)</span>

            <span class="n">sig_units</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">p_vals</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mf">0.05</span> <span class="o">/</span> <span class="n">divisor</span><span class="p">):</span>
                    <span class="n">unit_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span><span class="p">[</span><span class="n">plane</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                    <span class="c1"># print(&#39;stimulation has significantly changed fluoresence of s2p unit {}, its P value is {}&#39;.format(unit_index, p))</span>
                    <span class="n">sig_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit_index</span><span class="p">)</span>  <span class="c1"># significant units</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">sta_sig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sig_units</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">singleTrialSignificance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">single_sig</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># single trial significance value for each trial for each cell in each plane</span>

        <span class="k">for</span> <span class="n">plane</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">n_planes</span><span class="p">):</span>

            <span class="n">single_sigs</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">cell</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span><span class="p">[</span><span class="n">plane</span><span class="p">]):</span>

                <span class="n">single_sig</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_trials</span><span class="p">):</span>

                    <span class="n">pre_f_trial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_trials</span><span class="p">[</span><span class="n">plane</span><span class="p">][</span><span class="n">cell</span><span class="p">][</span><span class="n">trial</span><span class="p">][:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_frames</span><span class="p">]</span>
                    <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">pre_f_trial</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_amplitudes</span><span class="p">[</span><span class="n">plane</span><span class="p">][</span><span class="n">cell</span><span class="p">][</span><span class="n">trial</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">std</span><span class="p">:</span>
                        <span class="n">single_sig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">single_sig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

                <span class="n">single_sigs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">single_sig</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">single_sig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">single_sigs</span><span class="p">)</span>

    <span class="c1">## NOT REVIEWED FOR USAGE YET</span>

    <span class="c1"># other useful functions for all-optical analysis</span>
    <span class="k">def</span> <span class="nf">whiten_photostim_frame</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tiff_path</span><span class="p">,</span> <span class="n">save_as</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="n">im_stack</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">tiff_path</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">n_frames</span><span class="p">))</span>

        <span class="n">frames_to_whiten</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_start_frames</span><span class="p">:</span>
            <span class="n">frames_to_whiten</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>

        <span class="n">im_stack_1</span> <span class="o">=</span> <span class="n">im_stack</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">im_stack_1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="mf">5000.</span>
        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames_to_whiten</span><span class="p">:</span>
            <span class="n">im_stack_1</span><span class="p">[</span><span class="n">frame</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_stack_1</span><span class="p">[</span><span class="n">frame</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span>
            <span class="n">im_stack_1</span><span class="p">[</span><span class="n">frame</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_stack_1</span><span class="p">[</span><span class="n">frame</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span>
            <span class="n">im_stack_1</span><span class="p">[</span><span class="n">frame</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">im_stack_1</span><span class="p">[</span><span class="n">frame</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span>

        <span class="n">frames_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_start_frames</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">stim_duration_frames</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>  <span class="c1"># usually need to remove 1 more frame than the stim duration, as the stim isn&#39;t perfectly aligned with the start of the imaging frame</span>
                <span class="n">frames_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>

        <span class="n">im_stack_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span> <span class="n">frames_to_remove</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">tf</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">save_as</span><span class="p">,</span> <span class="n">im_stack_1</span><span class="p">,</span> <span class="n">photometric</span><span class="o">=</span><span class="s1">&#39;minisblack&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="AllOpticalTrial.avg_stim_images"><a class="viewcode-back" href="../../reference.html#packerlabimaging.AllOpticalTrial.avg_stim_images">[docs]</a>    <span class="k">def</span> <span class="nf">avg_stim_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peri_frames</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">stim_timings</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">save_img</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">to_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">force_redo</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Outputs (either by saving or plotting, or both) images from raw t-series TIFF for a trial around each individual</span>
<span class="sd">        stim timings.</span>

<span class="sd">        :param peri_frames:</span>
<span class="sd">        :param stim_timings:</span>
<span class="sd">        :param save_img:</span>
<span class="sd">        :param to_plot:</span>
<span class="sd">        :param force_redo:</span>
<span class="sd">        :param verbose:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">force_redo</span><span class="p">:</span>
            <span class="n">continu</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;avgstimimages_r&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">avgstimimages_r</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">continu</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">continu</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">continu</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">continu</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;making stim images...&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;stim_images&#39;</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">stim</span> <span class="ow">in</span> <span class="n">stim_timings</span> <span class="k">if</span> <span class="n">stim</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_images</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stim_images</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim_timings</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                <span class="n">tiffs_loc</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/*Ch3.tif&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">tiff_path_dir</span>
                <span class="n">tiff_path</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">tiffs_loc</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;working on loading up </span><span class="si">%s</span><span class="s1"> tiff from: &#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">metainfo</span><span class="p">[</span><span class="s1">&#39;trial_id&#39;</span><span class="p">],</span> <span class="n">tiff_path</span><span class="p">)</span>
                <span class="n">im_stack</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">tiff_path</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">n_frames</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Processing seizures from experiment tiff (wait for all seizure comparisons to be processed), </span><span class="se">\n</span><span class="s1"> &#39;</span>
                      <span class="s1">&#39;total tiff shape: &#39;</span><span class="p">,</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">stim</span> <span class="ow">in</span> <span class="n">stim_timings</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;|- stim # </span><span class="si">%s</span><span class="s1"> out of </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">stim_timings</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">stim</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim_timings</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_images</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">avg_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stim_images</span><span class="p">[</span><span class="n">stim</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">stim</span> <span class="o">&lt;</span> <span class="n">peri_frames</span><span class="p">:</span>
                        <span class="n">peri_frames</span> <span class="o">=</span> <span class="n">stim</span>
                    <span class="n">im_sub</span> <span class="o">=</span> <span class="n">im_stack</span><span class="p">[</span><span class="n">stim</span> <span class="o">-</span> <span class="n">peri_frames</span><span class="p">:</span> <span class="n">stim</span> <span class="o">+</span> <span class="n">peri_frames</span><span class="p">]</span>
                    <span class="n">avg_sub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">im_sub</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">stim_images</span><span class="p">[</span><span class="n">stim</span><span class="p">]</span> <span class="o">=</span> <span class="n">avg_sub</span>

                <span class="k">if</span> <span class="n">save_img</span><span class="p">:</span>
                    <span class="c1"># save in a subdirectory under the ANALYSIS folder path from whence t-series TIFF came from</span>
                    <span class="n">save_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analysis_save_dir</span> <span class="o">+</span> <span class="s1">&#39;avg_stim_images&#39;</span>
                    <span class="n">save_path_stim</span> <span class="o">=</span> <span class="n">save_path</span> <span class="o">+</span> <span class="s1">&#39;/</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_stim-</span><span class="si">%s</span><span class="s1">.tif&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">metainfo</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">metainfo</span><span class="p">[</span><span class="s1">&#39;trial_id&#39;</span><span class="p">],</span> <span class="n">stim</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_path</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;saving stim_img tiff to... </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">save_path_stim</span><span class="p">)</span> <span class="k">if</span> <span class="n">verbose</span> <span class="k">else</span> <span class="kc">None</span>
                        <span class="n">avg_sub8</span> <span class="o">=</span> <span class="n">convert_to_8bit</span><span class="p">(</span><span class="n">avg_sub</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
                        <span class="n">tf</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">save_path_stim</span><span class="p">,</span>
                                   <span class="n">avg_sub8</span><span class="p">,</span> <span class="n">photometric</span><span class="o">=</span><span class="s1">&#39;minisblack&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;making new directory for saving images at:&#39;</span><span class="p">,</span> <span class="n">save_path</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;saving as... </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">save_path_stim</span><span class="p">)</span>
                        <span class="n">avg_sub8</span> <span class="o">=</span> <span class="n">convert_to_8bit</span><span class="p">(</span><span class="n">avg_sub</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>
                        <span class="n">tf</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">save_path_stim</span><span class="p">,</span>
                                   <span class="n">avg_sub</span><span class="p">,</span> <span class="n">photometric</span><span class="o">=</span><span class="s1">&#39;minisblack&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">to_plot</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">avg_sub</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;avg image from </span><span class="si">%s</span><span class="s1"> frames around stim_start_frame </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">peri_frames</span><span class="p">,</span> <span class="n">stim</span><span class="p">))</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># just plot for now to make sure that you are doing things correctly so far</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;pkl_path&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_pkl</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;note: pkl not saved yet...&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">avgstimimages_r</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;skipping remaking of avg stim images&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AllOpticalTrial.run_stamm_nogui"><a class="viewcode-back" href="../../reference.html#packerlabimaging.AllOpticalTrial.run_stamm_nogui">[docs]</a>    <span class="k">def</span> <span class="nf">run_stamm_nogui</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numDiffStims</span><span class="p">,</span> <span class="n">startOnStim</span><span class="p">,</span> <span class="n">everyXStims</span><span class="p">,</span> <span class="n">preSeconds</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">postSeconds</span><span class="o">=</span><span class="mf">1.25</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;run STAmoviemaker for the self&#39;s trial&quot;&quot;&quot;</span>
        <span class="n">qnap_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;/home/pshah/mnt/qnap&#39;</span><span class="p">)</span>

        <span class="c1"># data path</span>
        <span class="n">movie_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tiff_path</span>
        <span class="n">sync_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_paq_path</span>

        <span class="c1"># stamm save path</span>
        <span class="n">stam_save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">qnap_path</span><span class="p">,</span> <span class="s1">&#39;Analysis&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">metainfo</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="s1">&#39;STA_Movies&#39;</span><span class="p">,</span>
                                      <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metainfo</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">metainfo</span><span class="p">[</span><span class="s1">&#39;exp_id&#39;</span><span class="p">],</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">metainfo</span><span class="p">[</span><span class="s1">&#39;trial_id&#39;</span><span class="p">]))</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">stam_save_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1">##</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">stam_save_path</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;QNAP_path:&#39;</span><span class="p">,</span> <span class="n">qnap_path</span><span class="p">,</span>
              <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">data path:&#39;</span><span class="p">,</span> <span class="n">movie_path</span><span class="p">,</span>
              <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">sync path:&#39;</span><span class="p">,</span> <span class="n">sync_path</span><span class="p">,</span>
              <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">STA movie save s2pResultsPath:&#39;</span><span class="p">,</span> <span class="n">stam_save_path</span><span class="p">)</span>

        <span class="c1"># define STAmm parameters</span>
        <span class="n">frameRate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">fps</span><span class="p">)</span>

        <span class="n">arg_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;moviePath&#39;</span><span class="p">:</span> <span class="n">movie_path</span><span class="p">,</span>  <span class="c1"># hard-code this</span>
                    <span class="s1">&#39;savePath&#39;</span><span class="p">:</span> <span class="n">stam_save_path</span><span class="p">,</span>
                    <span class="s1">&#39;syncFrameChannel&#39;</span><span class="p">:</span> <span class="s1">&#39;frame_clock&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;syncStimChannel&#39;</span><span class="p">:</span> <span class="s1">&#39;packio2markpoints&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;syncStartSec&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s1">&#39;syncStopSec&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s1">&#39;numDiffStims&#39;</span><span class="p">:</span> <span class="n">numDiffStims</span><span class="p">,</span>
                    <span class="s1">&#39;startOnStim&#39;</span><span class="p">:</span> <span class="n">startOnStim</span><span class="p">,</span>
                    <span class="s1">&#39;everyXStims&#39;</span><span class="p">:</span> <span class="n">everyXStims</span><span class="p">,</span>
                    <span class="s1">&#39;preSeconds&#39;</span><span class="p">:</span> <span class="n">preSeconds</span><span class="p">,</span>
                    <span class="s1">&#39;postSeconds&#39;</span><span class="p">:</span> <span class="n">postSeconds</span><span class="p">,</span>
                    <span class="s1">&#39;frameRate&#39;</span><span class="p">:</span> <span class="n">frameRate</span><span class="p">,</span>
                    <span class="s1">&#39;averageImageStart&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                    <span class="s1">&#39;averageImageStop&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
                    <span class="s1">&#39;methodDF&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;methodDFF&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;methodZscore&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;syncPath&#39;</span><span class="p">:</span> <span class="n">sync_path</span><span class="p">,</span>
                    <span class="s1">&#39;zPlanes&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;useStimOrder&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;stimOrder&#39;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s1">&#39;useSingleTrials&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;doThreshold&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;threshold&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s1">&#39;colourByTime&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;useCorrelationImage&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;blurHandS&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="s1">&#39;makeMaxImage&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;makeColourImage&#39;</span><span class="p">:</span> <span class="kc">False</span>
                    <span class="p">}</span>

        <span class="c1"># # run STAmm</span>
        <span class="c1"># STAMM.STAMovieMaker(arg_dict)</span>

        <span class="c1"># show the MaxResponseImage</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">stam_save_path</span> <span class="o">+</span> <span class="s1">&#39;/*MaxResponseImage.tif&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>
        <span class="c1"># plot_single_tiff(img, frame_num=0)</span>

    <span class="k">def</span> <span class="nf">_targetSpread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Find the mean Euclidean distance of responding targeted cells (trial-wise and trial average)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># for each trial find targeted cells that responded</span>
        <span class="n">trial_responders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_sig_dff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">targeted_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targeted_cells</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">],</span>
                                   <span class="n">trial_responders</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># [..., None] is a quick way to expand_dims</span>
        <span class="n">targeted_responders</span> <span class="o">=</span> <span class="n">targeted_cells</span> <span class="o">&amp;</span> <span class="n">trial_responders</span>

        <span class="n">cell_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">cell_med</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_trials</span><span class="p">)</span>

        <span class="c1"># for each trial, find the spread of responding targeted cells</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">trial</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_trials</span><span class="p">)):</span>
            <span class="n">resp_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">targeted_responders</span><span class="p">[:,</span> <span class="n">trial</span><span class="p">])</span>
            <span class="n">resp_positions</span> <span class="o">=</span> <span class="n">cell_positions</span><span class="p">[</span><span class="n">resp_cell</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">resp_positions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># need more than 1 cell to measure spread...</span>
                <span class="n">dists</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_euclidDist</span><span class="p">(</span><span class="n">resp_positions</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dists</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">trial_euclid_dist</span> <span class="o">=</span> <span class="n">dists</span>

        <span class="c1"># find spread of targets that statistically significantly responded over all trials</span>
        <span class="n">responder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sta_sig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">targeted_responders</span> <span class="o">=</span> <span class="n">responder</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">targeted_cells</span>

        <span class="n">resp_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">targeted_responders</span><span class="p">)</span>
        <span class="n">resp_positions</span> <span class="o">=</span> <span class="n">cell_positions</span><span class="p">[</span><span class="n">resp_cell</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">resp_positions</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># need more than 1 cell to measure spread...</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_euclidDist</span><span class="p">(</span><span class="n">resp_positions</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sta_euclid_dist</span> <span class="o">=</span> <span class="n">dist</span></div>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">packerlabimaging</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quick-start-guide.html">Quick start guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../reference.html">API Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2022, Packer Lab.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.4.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>