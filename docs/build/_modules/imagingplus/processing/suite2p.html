
<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>imagingplus.processing.suite2p — imaging+ 0.2-beta documentation</title>
<link href="../../../_static/pygments.css" rel="stylesheet" type="text/css"/>
<link href="../../../_static/sphinxdoc.css" rel="stylesheet" type="text/css"/>
<link href="../../../_static/sg_gallery.css" rel="stylesheet" type="text/css"/>
<script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
<script src="../../../_static/jquery.js"></script>
<script src="../../../_static/underscore.js"></script>
<script src="../../../_static/doctools.js"></script>
<script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
<link href="../../../genindex.html" rel="index" title="Index"/>
<link href="../../../search.html" rel="search" title="Search"/>
</head><body>
<div aria-label="related navigation" class="related" role="navigation">
<h3>Navigation</h3>
<ul>
<li class="right" style="margin-right: 10px">
<a accesskey="I" href="../../../genindex.html" title="General Index">index</a></li>
<li class="right">
<a href="../../../py-modindex.html" title="Python Module Index">modules</a> |</li>
<li class="nav-item nav-item-0"><a href="../../../index.html">imaging+ 0.2-beta documentation</a> »</li>
<li class="nav-item nav-item-1"><a accesskey="U" href="../../index.html">Module code</a> »</li>
<li class="nav-item nav-item-this"><a href="">imagingplus.processing.suite2p</a></li>
</ul>
</div>
<div class="document">
<div class="documentwrapper">
<div class="bodywrapper">
<div class="body" role="main">
<h1>Source code for imagingplus.processing.suite2p</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">suite2p</span>
<span class="c1"># todo add type hinting controls for expobj</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">imagingplus.main.subcore</span> <span class="kn">import</span> <span class="n">CellAnnotations</span><span class="p">,</span> <span class="n">ImagingData</span>
<span class="kn">from</span> <span class="nn">suite2p</span> <span class="kn">import</span> <span class="n">run_s2p</span>
<span class="kn">import</span> <span class="nn">tifffile</span> <span class="k">as</span> <span class="nn">tf</span>

<span class="kn">from</span> <span class="nn">imagingplus.utils.classes</span> <span class="kn">import</span> <span class="n">UnavailableOptionError</span>
<span class="kn">from</span> <span class="nn">imagingplus.utils.images</span> <span class="kn">import</span> <span class="n">ImportTiff</span><span class="p">,</span> <span class="n">SaveDownsampledTiff</span><span class="p">,</span> <span class="n">WriteTiff</span><span class="p">,</span> <span class="n">make_tiff_stack</span>


<span class="c1"># suite2p methods</span>
<div class="viewcode-block" id="s2pRun"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.suite2p.s2pRun">[docs]</a><span class="k">def</span> <span class="nf">s2pRun</span><span class="p">(</span><span class="n">expobj</span><span class="p">,</span> <span class="n">trialsSuite2P</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'all'</span><span class="p">):</span>
    <span class="sd">"""run suite2p for an Experiment object, using trials specified in current experiment object, using the attributes</span>
<span class="sd">    determined directly from the experiment object.</span>

<span class="sd">    :param expobj: a imagingplus.main.Experiment object</span>
<span class="sd">    :param trialsSuite2P: list of trialIDs from experiment to use in running suite2p</span>
<span class="sd">    """</span>

    <span class="n">_suite2p_save_path</span> <span class="o">=</span> <span class="n">expobj</span><span class="o">.</span><span class="n">saveDir</span> <span class="o">+</span> <span class="s1">'/suite2p/'</span>  <span class="c1">#: default location to save Suite2p output results of current experiment</span>

    <span class="n">expobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">trials</span> <span class="o">=</span> <span class="n">trialsSuite2P</span> <span class="k">if</span> <span class="n">trialsSuite2P</span> <span class="o">!=</span> <span class="s1">'all'</span> <span class="k">else</span> <span class="n">expobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">trials</span>

    <span class="n">tiffs_paths_to_use_s2p</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="n">expobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">trials</span><span class="p">:</span>
        <span class="n">tiffs_paths_to_use_s2p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expobj</span><span class="o">.</span><span class="n">TrialsInformation</span><span class="p">[</span><span class="n">trial</span><span class="p">][</span><span class="s1">'tiff_path'</span><span class="p">])</span>

    <span class="n">expobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">tiffs_paths_to_use_s2p</span> <span class="o">=</span> <span class="n">tiffs_paths_to_use_s2p</span>

    <span class="c1"># setup db dict</span>
    <span class="n">expobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s1">'batch_size'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">expobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s1">'batch_size'</span><span class="p">])</span>
    <span class="n">db</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'fs'</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">expobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s1">'fs'</span><span class="p">]),</span> <span class="s1">'diameter'</span><span class="p">:</span> <span class="n">expobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s1">'diameter'</span><span class="p">],</span>
          <span class="s1">'batch_size'</span><span class="p">:</span> <span class="n">expobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s1">'batch_size'</span><span class="p">],</span>
          <span class="s1">'nimg_init'</span><span class="p">:</span> <span class="n">expobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s1">'batch_size'</span><span class="p">],</span> <span class="s1">'nplanes'</span><span class="p">:</span> <span class="n">expobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s1">'nplanes'</span><span class="p">],</span>
          <span class="s1">'nchannels'</span><span class="p">:</span> <span class="n">expobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s1">'nchannels'</span><span class="p">],</span>
          <span class="s1">'tiff_list'</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">tiffs_paths_to_use_s2p</span><span class="p">),</span> <span class="s1">'data_path'</span><span class="p">:</span> <span class="n">expobj</span><span class="o">.</span><span class="n">dataPath</span><span class="p">,</span> <span class="s1">'save_folder'</span><span class="p">:</span> <span class="n">_suite2p_save_path</span>
          <span class="p">}</span>

    <span class="n">expobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="n">db</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">'RUNNING Suite2p:'</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'-- .Suite2p.db: '</span><span class="p">)</span>  <span class="c1"># \n\t{expobj.Suite2p.db}\n\n')</span>

    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">opsEnd</span> <span class="o">=</span> <span class="n">run_s2p</span><span class="p">(</span><span class="n">ops</span><span class="o">=</span><span class="n">expobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">ops</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">expobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">db</span><span class="p">)</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">'Total time to run suite2p was </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="p">))</span>

    <span class="c1"># update expobj.Suite2p.ops and db</span>
    <span class="n">expobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">ops</span> <span class="o">=</span> <span class="n">opsEnd</span>

    <span class="n">expobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">s2pResultExists</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">expobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">s2pResultsPath</span> <span class="o">=</span> <span class="n">_suite2p_save_path</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="se">\n\n</span><span class="s1">Completed Suite2p run. </span><span class="se">\n\t</span><span class="s1"> Results are saved to: </span><span class="si">{</span><span class="n">expobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">s2pResultsPath</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>

    <span class="n">expobj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></div>


<div class="viewcode-block" id="s2p_loader"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.suite2p.s2p_loader">[docs]</a><span class="k">def</span> <span class="nf">s2p_loader</span><span class="p">(</span><span class="n">s2p_path</span><span class="p">,</span> <span class="n">subtract_neuropil</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">neuropil_coeff</span><span class="o">=</span><span class="mf">0.7</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Load suite2p results from file path at `s2p_path`.</span>

<span class="sd">    :param s2p_path: file path from which to load suite2p results</span>
<span class="sd">    :param subtract_neuropil: if True, use neuropil cooefficient to subtract neuropil signal from raw fluorescence signal.</span>
<span class="sd">    :param neuropil_coeff: neuropil coefficient to subtract neuropil signal.</span>
<span class="sd">    :return: Raw signal array (optionally neuropil corrected), deconvolved spikes, stat output, neuropil signal array</span>
<span class="sd">    """</span>
    <span class="n">found_stat</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">s2p_path</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">file</span> <span class="o">==</span> <span class="s1">'F.npy'</span><span class="p">:</span>
                <span class="n">all_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">),</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">file</span> <span class="o">==</span> <span class="s1">'Fneu.npy'</span><span class="p">:</span>
                <span class="n">neuropil</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">),</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">file</span> <span class="o">==</span> <span class="s1">'iscell.npy'</span><span class="p">:</span>
                <span class="n">is_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">),</span>
                                   <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">is_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">is_cells</span><span class="p">,</span> <span class="s1">'bool'</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">'Loading </span><span class="si">{}</span><span class="s1"> traces labelled as cells'</span>
                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">is_cells</span><span class="p">)))</span>
            <span class="k">elif</span> <span class="n">file</span> <span class="o">==</span> <span class="s1">'spks.npy'</span><span class="p">:</span>
                <span class="n">spks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">),</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">file</span> <span class="o">==</span> <span class="s1">'stat.npy'</span><span class="p">:</span>
                <span class="n">stat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">),</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">found_stat</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">found_stat</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">'Could not find stat, '</span>
                                <span class="s1">'this is likely not a suit2p folder, path: '</span><span class="p">,</span> <span class="n">s2p_path</span><span class="p">)</span>

    <span class="c1"># for i, s in enumerate(stat):</span>
    <span class="c1">#     s['original_index'] = i</span>

    <span class="n">all_cells</span> <span class="o">=</span> <span class="n">all_cells</span><span class="p">[</span><span class="n">is_cells</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">neuropil</span> <span class="o">=</span> <span class="n">neuropil</span><span class="p">[</span><span class="n">is_cells</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">spks</span> <span class="o">=</span> <span class="n">spks</span><span class="p">[</span><span class="n">is_cells</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">stat</span> <span class="o">=</span> <span class="n">stat</span><span class="p">[</span><span class="n">is_cells</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">subtract_neuropil</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">all_cells</span><span class="p">,</span> <span class="n">spks</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">neuropil</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">'Subtracting neuropil with a coefficient of </span><span class="si">{}</span><span class="s1">'</span>
              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">neuropil_coeff</span><span class="p">))</span>
        <span class="n">neuropil_corrected</span> <span class="o">=</span> <span class="n">all_cells</span> <span class="o">-</span> <span class="n">neuropil</span> <span class="o">*</span> <span class="n">neuropil_coeff</span>
        <span class="k">return</span> <span class="n">neuropil_corrected</span><span class="p">,</span> <span class="n">spks</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">neuropil</span></div>


<span class="c1"># utility funcs</span>
<span class="c1"># quick workaround (patch of suite2p code) because of suite2p internal error for these methods in ROI class</span>
<div class="viewcode-block" id="from_stat_dict"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.suite2p.from_stat_dict">[docs]</a><span class="k">def</span> <span class="nf">from_stat_dict</span><span class="p">(</span><span class="n">stat</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">suite2p</span><span class="o">.</span><span class="n">ROI</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Overloading function from suite2p source code.</span>

<span class="sd">    :param stat: suite2p results output stat dict</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">suite2p</span><span class="o">.</span><span class="n">ROI</span><span class="p">(</span><span class="n">ypix</span><span class="o">=</span><span class="n">stat</span><span class="p">[</span><span class="s1">'ypix'</span><span class="p">],</span> <span class="n">xpix</span><span class="o">=</span><span class="n">stat</span><span class="p">[</span><span class="s1">'xpix'</span><span class="p">],</span> <span class="n">lam</span><span class="o">=</span><span class="n">stat</span><span class="p">[</span><span class="s1">'lam'</span><span class="p">],</span> <span class="n">med</span><span class="o">=</span><span class="n">stat</span><span class="p">[</span><span class="s1">'med'</span><span class="p">],</span> <span class="n">do_crop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>


<div class="viewcode-block" id="to_array_"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.suite2p.to_array_">[docs]</a><span class="k">def</span> <span class="nf">to_array_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Ly</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Lx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">"""Returns a 2D boolean array of shape (Ly x Lx) indicating where the roi is located.</span>
<span class="sd">    Overloading function from suite2p source code.</span>
<span class="sd">    """</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Ly</span><span class="p">,</span> <span class="n">Lx</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">arr</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ypix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xpix</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">arr</span></div>


<div class="viewcode-block" id="stats_dicts_to_3d_array_"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.suite2p.stats_dicts_to_3d_array_">[docs]</a><span class="k">def</span> <span class="nf">stats_dicts_to_3d_array_</span><span class="p">(</span><span class="n">stat_dict</span><span class="p">,</span> <span class="n">output_ops</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Overloading function from suite2p source code.</span>
<span class="sd">    """</span>
    <span class="n">arrays</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">stat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stat_dict</span><span class="p">):</span>
        <span class="n">array</span> <span class="o">=</span> <span class="n">to_array_</span><span class="p">(</span><span class="n">from_stat_dict</span><span class="p">(</span><span class="n">stat</span><span class="o">=</span><span class="n">stat</span><span class="p">),</span> <span class="n">Ly</span><span class="o">=</span><span class="n">output_ops</span><span class="p">[</span><span class="s1">'Ly'</span><span class="p">],</span> <span class="n">Lx</span><span class="o">=</span><span class="n">output_ops</span><span class="p">[</span><span class="s1">'Lx'</span><span class="p">])</span>
        <span class="n">array</span> <span class="o">*=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">arrays</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">arrays</span><span class="p">)</span></div>


<span class="c1"># todo have suite2p run return a cells annotations (and maybe even imaging cellsdata set??) that can get added to trials' cells and imdata attr's immediately</span>

<div class="viewcode-block" id="Suite2pExperiment"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.suite2p.Suite2pExperiment">[docs]</a><span class="k">class</span> <span class="nc">Suite2pExperiment</span><span class="p">:</span>
    <span class="sd">"""used to run and further process suite2p processed cellsdata, and analysis associated with suite2p processed cellsdata."""</span>

    <span class="c1"># default ops dict for suite2p experiment run</span>
    <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'batch_size'</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span>  <span class="c1"># reduce if running out of RAM</span>
        <span class="s1">'delete_bin'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># whether to delete binary file after processing</span>
        <span class="c1"># main settings</span>
        <span class="s1">'nplanes'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># each tiff has these many planes in sequence</span>
        <span class="s1">'nchannels'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># each tiff has these many channels per plane</span>
        <span class="s1">'functional_chan'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># this channel is used to extract functional ROIs (1-based)</span>
        <span class="s1">'diameter'</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
        <span class="c1"># this is the main parameter for cell detection, 2-dimensional if Y and X are different (e.g. [6 12])</span>
        <span class="c1"># 'tau': 1.26,  # this is the main parameter for deconvolution (1.25-1.5 for gcamp6s)</span>
        <span class="c1"># 'fs': 30,  # sampling rate (total across planes)</span>
        <span class="c1"># output settings</span>
        <span class="s1">'save_mat'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># whether to save output as matlab files</span>
        <span class="s1">'combined'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># combine multiple planes into a single result /single canvas for GUI</span>
        <span class="c1"># parallel settings</span>
        <span class="s1">'num_workers'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># 0 to select num_cores, -1 to disable parallelism, N to enforce value</span>
        <span class="s1">'num_workers_roi'</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># 0 to select number of planes, -1 to disable parallelism, N to enforce value</span>
        <span class="c1"># registration settings</span>
        <span class="s1">'do_registration'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># whether to register cellsdata</span>
        <span class="s1">'nimg_init'</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>  <span class="c1"># subsampled key_frames for finding reference image</span>
        <span class="s1">'maxregshift'</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>  <span class="c1"># max allowed registration shift, as a fraction of frame max(width and height)</span>
        <span class="s1">'align_by_chan'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># when multi-channel, you can align by non-functional channel (1-based)</span>
        <span class="s1">'reg_tif'</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># whether to save registered tiffs</span>
        <span class="s1">'subpixel'</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>  <span class="c1"># precision of subpixel registration (1/subpixel steps)</span>
        <span class="c1"># cell detection settings</span>
        <span class="s1">'connected'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># whether or not to keep ROIs fully connected (set to 0 for dendrites)</span>
        <span class="s1">'navg_frames_svd'</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span>  <span class="c1"># max number of binned key_frames for the SVD</span>
        <span class="s1">'nsvd_for_roi'</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>  <span class="c1"># max number of SVD components to keep for ROI detection</span>
        <span class="s1">'max_iterations'</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>  <span class="c1"># maximum number of iterations to do cell detection</span>
        <span class="s1">'ratio_neuropil'</span><span class="p">:</span> <span class="mf">6.</span><span class="p">,</span>  <span class="c1"># ratio between neuropil basis size and cell radius</span>
        <span class="s1">'ratio_neuropil_to_cell'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># minimum ratio between neuropil radius and cell radius</span>
        <span class="s1">'tile_factor'</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>  <span class="c1"># use finer (&gt;1) or coarser (&lt;1) tiles for neuropil estimation during cell detection</span>
        <span class="s1">'threshold_scaling'</span><span class="p">:</span> <span class="mf">1.</span><span class="p">,</span>  <span class="c1"># adjust the automatically determined threshold by this scalar multiplier</span>
        <span class="s1">'max_overlap'</span><span class="p">:</span> <span class="mf">0.75</span><span class="p">,</span>  <span class="c1"># cells with more overlap than this get removed during triage, before refinement</span>
        <span class="s1">'inner_neuropil_radius'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>  <span class="c1"># number of pixels to keep between ROI and neuropil donut</span>
        <span class="s1">'outer_neuropil_radius'</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span>  <span class="c1"># maximum neuropil radius</span>
        <span class="s1">'min_neuropil_pixels'</span><span class="p">:</span> <span class="mi">350</span><span class="p">,</span>  <span class="c1"># minimum number of pixels in the neuropil</span>
        <span class="c1"># deconvolution settings</span>
        <span class="s1">'baseline'</span><span class="p">:</span> <span class="s1">'maximin'</span><span class="p">,</span>  <span class="c1"># baselining mode</span>
        <span class="s1">'win_baseline'</span><span class="p">:</span> <span class="mf">60.</span><span class="p">,</span>  <span class="c1"># window for maximin</span>
        <span class="s1">'sig_baseline'</span><span class="p">:</span> <span class="mf">10.</span><span class="p">,</span>  <span class="c1"># smoothing constant for gaussian filter</span>
        <span class="s1">'prctile_baseline'</span><span class="p">:</span> <span class="mf">8.</span><span class="p">,</span>  <span class="c1"># optional (whether to use a percentile baseline)</span>
        <span class="s1">'neucoeff'</span><span class="p">:</span> <span class="mf">.7</span><span class="p">,</span>  <span class="c1"># neuropil coefficient</span>
    <span class="p">}</span>

<div class="viewcode-block" id="Suite2pExperiment.update_ops"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.suite2p.Suite2pExperiment.update_ops">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">update_ops</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">new_ops_entries</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Add or update existing ops fields before running suite2p pipeline.</span>

<span class="sd">        :param new_ops_entries: dict specificying new or updated ops fields.</span>
<span class="sd">        """</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Updating </span><span class="si">{</span><span class="p">[</span><span class="o">*</span><span class="n">new_ops_entries</span><span class="p">]</span><span class="si">}</span><span class="s1"> keys in ops prior to Suite2p run.'</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">new_ops_entries</span><span class="p">:</span>
            <span class="bp">cls</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_ops_entries</span><span class="p">[</span><span class="n">key</span><span class="p">]</span></div>

<div class="viewcode-block" id="Suite2pExperiment.__init__"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.suite2p.Suite2pExperiment.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trialsTiffsSuite2p</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">s2pResultsPath</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Submodule for connecting an Experiment to Suite2p for the specified trials/data_tiffs.</span>

<span class="sd">        :param trialsTiffsSuite2p:</span>
<span class="sd">        :param s2pResultsPath: optional, if suite2p already run then here provide path to plane0 folder of existing suite2p results</span>
<span class="sd">        :param subtract_neuropil:</span>
<span class="sd">        :param dataPath:</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__s2pResultExists</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bad_frames</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1">#: list of key_frames to discard during Suite2p ROI detection procedure</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"\- ADDING .Suite2p module to Experiment object ... "</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">'</span><span class="se">\r</span><span class="s1">'</span><span class="p">)</span>

        <span class="c1">## initialize attr's</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># total number of imaging key_frames in the Suite2p run</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># cell ROI # id per plane</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_units</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># num of ROIs in suite2p result per plane</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_med</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># y, x pixel location of each cell in the imaging frame</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_x</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># x pixel location of cell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_y</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># y pixel location of cell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># [cells x num key_frames], raw traces for each cell from suite2p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stat</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># stat output from suite2p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spks</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># deconvolved spikes output from suite2p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neuropil</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># neuropil output from suite2p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean_img</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># mean img output from suite2p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean_imgE</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># mean img Enhanced output from suite2p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># cell radius from suite2p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xoff</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># motion correction info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yoff</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># motion correction info</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">neuropil_coeff</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">s2pResultsPath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># initialize needed variables and attr's for future calling of s2pRun</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__s2pResultsPath</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s2pResultExists</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__s2pResultsPath</span> <span class="o">=</span> <span class="n">s2pResultsPath</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_retrieveSuite2pData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s2pResultsPath</span><span class="p">,</span> <span class="n">neuropil_coeff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">neuropil_coeff</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">'Something went wrong while trying to load suite2p processed cellsdata from: </span><span class="si">{</span><span class="n">s2pResultsPath</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">s2pResultExists</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># set trials to run together in suite2p for Experiment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trials</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tiff_paths_to_use_s2p</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">trialsTiffsSuite2p</span>
        <span class="k">for</span> <span class="n">trial</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">tiff_paths_to_use_s2p</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s2pResultExists</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">'output_ops'</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_ops</span><span class="p">[</span><span class="s1">'filelist'</span><span class="p">]:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="se">\t</span><span class="s1">WARNING: Path for </span><span class="si">{</span><span class="n">trial</span><span class="si">}</span><span class="s1">, (</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s1">) was not found in suite2p results output_ops filelist.'</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trials</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tiff_paths_to_use_s2p</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">trial</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tiff_paths_to_use_s2p</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">tiff_paths_to_use_s2p</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trials</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">"Failed adding trials to suite2p module. </span><span class="se">\n</span><span class="s2">"</span> \
                                     <span class="s2">"</span><span class="se">\t</span><span class="s2"> - Ensure that correct trials are provided."</span> \
                                     <span class="s2">"</span><span class="se">\t</span><span class="s2"> - Ensure that file paths provided for each trial correspond to filepaths in output_ops."</span> \

        <span class="bp">self</span><span class="o">.</span><span class="n">db</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># finish</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"|- ADDED .Suite2p module to Experiment object. "</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">s2pResultsPath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Path to the saved suite2p results output.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__s2pResultsPath</span>

    <span class="nd">@s2pResultsPath</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">s2pResultsPath</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Setter for path to the saved suite2p results output.</span>
<span class="sd">        :param val: file path</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__s2pResultsPath</span> <span class="o">=</span> <span class="n">val</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">s2pResultExists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Return true if s2p results exist for current trial.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__s2pResultExists</span>

    <span class="nd">@s2pResultExists</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">s2pResultExists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Set if s2p results exist for current trial.</span>
<span class="sd">        :param val:</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__s2pResultExists</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s2pResultExists</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">'Suite2p Results (Experiment level) Object, containing trials: </span><span class="se">\n\t</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trials</span><span class="si">}</span><span class="s1">'</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">'Suite2p Results (Experiment level) Object, containing trials: </span><span class="se">\n\t</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trials</span><span class="si">}</span><span class="s1">. No Suite2p results loaded.'</span>

    <span class="c1"># noinspection PyTypeChecker</span>
    <span class="k">def</span> <span class="nf">_retrieveSuite2pData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s2p_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">neuropil_coeff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span><span class="p">):</span>
        <span class="sd">"""processing of suite2p cellsdata from the current t-series</span>
<span class="sd">        :param s2p_path: s2pResultsPath to the directory containing suite2p outputs</span>
<span class="sd">        :param neuropil_coeff: choose to subtract neuropil or not when loading s2p traces</span>
<span class="sd">        :param save: choose to save cellsdata object or not</span>
<span class="sd">        """</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'\----- Adding Suite2p results to .Suite2p module ...'</span><span class="p">)</span>

        <span class="n">s2p_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s2pResultsPath</span> <span class="k">if</span> <span class="n">s2p_path</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">s2p_path</span>

        <span class="c1"># extract suite2p stat.npy and neuropil-subtracted F</span>
        <span class="n">subtract_neuropil</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">neuropil_coeff</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="n">FminusFneu</span><span class="p">,</span> <span class="n">spks</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">neuropil</span> <span class="o">=</span> <span class="n">s2p_loader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s2pResultsPath</span><span class="p">,</span> <span class="n">subtract_neuropil</span><span class="o">=</span><span class="n">subtract_neuropil</span><span class="p">,</span>
                                                      <span class="n">neuropil_coeff</span><span class="o">=</span><span class="n">neuropil_coeff</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">FminusFneu</span><span class="p">)</span>  <span class="c1"># raw F of each suite2p ROI (neuropil corrected if neuropil_coeff &gt; 0)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">spks</span><span class="p">)</span>  <span class="c1"># deconvolved spikes each suite2p ROI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neuropil</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">neuropil</span><span class="p">)</span>  <span class="c1"># neuropil value of each suite2p ROI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stat</span><span class="p">)</span>  <span class="c1"># stat dictionary for each suite2p ROI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span> <span class="o">=</span> <span class="n">spks</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s2p_path</span><span class="p">,</span> <span class="s1">'ops.npy'</span><span class="p">),</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean_img</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s1">'meanImg'</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean_imgE</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s1">'meanImgE'</span><span class="p">])</span>  <span class="c1"># enhanced mean image from suite2p</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s1">'xoff'</span><span class="p">]</span>  <span class="c1"># motion correction info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s1">'yoff'</span><span class="p">]</span>

        <span class="n">cell_id</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cell_med</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cell_x</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cell_y</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># stat is an np array of dictionaries</span>
        <span class="k">for</span> <span class="n">cell</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stat</span><span class="p">):</span>
            <span class="n">cell_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
            <span class="n">cell_med</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">'med'</span><span class="p">])</span>

            <span class="n">cell_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">'xpix'</span><span class="p">])</span>
            <span class="n">cell_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="s1">'ypix'</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_med</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_med</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_y</span><span class="p">)</span>

        <span class="n">num_units</span> <span class="o">=</span> <span class="n">FminusFneu</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">'|- Loaded </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_units</span><span class="si">}</span><span class="s1"> suite2p classified cells from plane 0, recorded for </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s2">"fs"</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s1"> secs total, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span><span class="si">}</span><span class="s1"> frames total'</span><span class="p">)</span>

        <span class="c1"># TODO consider replacing this and use returning properties</span>
        <span class="c1"># print(f'*** plane 0 cellsdata ***')</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">raw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">neuropil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neuropil</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_img</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mean_imgE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mean_imgE</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xoff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">yoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">yoff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_units</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_med</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_med</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spks</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># print(f'n_frames', self.n_frames)</span>

        <span class="c1"># read in other files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_ops</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s2pResultsPath</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">'ops.npy'</span><span class="p">),</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">stats_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s2pResultsPath</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">'stat.npy'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iscell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s2pResultsPath</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">'iscell.npy'</span><span class="p">),</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">stats_file</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">im</span> <span class="o">=</span> <span class="n">stats_dicts_to_3d_array_</span><span class="p">(</span><span class="n">stat_dict</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="p">,</span> <span class="n">output_ops</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">output_ops</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

<div class="viewcode-block" id="Suite2pExperiment.stitch_reg_tiffs"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.suite2p.Suite2pExperiment.stitch_reg_tiffs">[docs]</a>    <span class="k">def</span> <span class="nf">stitch_reg_tiffs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first_frame</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">last_frame</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">reg_tif_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">s2p_run_batch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Stitches together registered tiffs outputs from suite2p from the provided imaging frame start and end values.</span>

<span class="sd">        :param first_frame: first frame from the overall s2p run to start stitching from</span>
<span class="sd">        :param last_frame: last frame from the overall s2p run to end stitching at</span>
<span class="sd">        :param s2p_run_batch: batch size for suite2p run (defaults to 2000 because that is usually the batch size while running suite2p processing)</span>
<span class="sd">        """</span>

        <span class="k">if</span> <span class="n">reg_tif_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s2pResultsPath</span><span class="p">:</span>
                <span class="n">reg_tif_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s2pResultsPath</span> <span class="o">+</span> <span class="s1">'/reg_tif/'</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"|____ trying to load registered tiffs from: </span><span class="si">{</span><span class="n">reg_tif_folder</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Must provide reg_tif_folder s2pResultsPath for loading registered tiffs"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">reg_tif_folder</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"no registered tiffs found at s2pResultsPath: </span><span class="si">{</span><span class="n">reg_tif_folder</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="n">frame_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">first_frame</span><span class="p">,</span> <span class="n">last_frame</span><span class="p">]</span>

        <span class="n">start</span> <span class="o">=</span> <span class="n">first_frame</span> <span class="o">//</span> <span class="n">s2p_run_batch</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">last_frame</span> <span class="o">//</span> <span class="n">s2p_run_batch</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># set tiff paths to save registered tiffs:</span>
        <span class="n">tif_path_save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s2pResultsPath</span> <span class="o">+</span> <span class="s1">'reg_tiff.tif'</span>
        <span class="n">reg_tif_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">reg_tif_folder</span><span class="p">)</span>
        <span class="n">reg_tif_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">sorted_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">reg_tif_folder</span> <span class="o">+</span> <span class="n">tif</span> <span class="k">for</span> <span class="n">tif</span> <span class="ow">in</span> <span class="n">reg_tif_list</span><span class="p">][</span><span class="n">start</span><span class="p">:</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">tif_path_save</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sorted_paths</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tif_path_save</span><span class="p">):</span>
            <span class="n">make_tiff_stack</span><span class="p">(</span><span class="n">sorted_paths</span><span class="p">,</span> <span class="n">save_as</span><span class="o">=</span><span class="n">tif_path_save</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reg_tiff_path</span> <span class="o">=</span> <span class="n">tif_path_save</span></div>

<div class="viewcode-block" id="Suite2pExperiment.s2pMeanImage"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.suite2p.Suite2pExperiment.s2pMeanImage">[docs]</a>    <span class="k">def</span> <span class="nf">s2pMeanImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Return array of the s2p mean image.</span>
<span class="sd">        :param s2p_path: (optional) s2pResultsPath to location of s2p cellsdata</span>
<span class="sd">        :param plot: (optional) option to plot the s2p mean image</span>
<span class="sd">        :return:</span>
<span class="sd">        """</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Plotting s2p mean image .. </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">s2pResultsPath</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">s2pResultsPath</span><span class="p">)</span>

        <span class="n">ops</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">'ops.npy'</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>

        <span class="n">mean_img</span> <span class="o">=</span> <span class="n">ops</span><span class="p">[</span><span class="s1">'meanImg'</span><span class="p">]</span>

        <span class="n">mean_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mean_img</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'uint16'</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mean_img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">'s2p mean image'</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">mean_img</span></div>

<div class="viewcode-block" id="Suite2pExperiment.subSuite2p"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.suite2p.Suite2pExperiment.subSuite2p">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">subSuite2p</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">trialsTiffs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">s2pResultsPath</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Alternative constructor for Suite2pExperiment class. Inputs a specific # of trials to use for loading up Suite2p.</span>

<span class="sd">        :param trialsTiffs: dictionary of trial ID and associated tiff path to use for creating new Suite2p instance.</span>
<span class="sd">        :param s2pResultsPath: path to save suite2p results outputs.</span>
<span class="sd">        :return: Suite2p instance</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">trialsTiffsSuite2p</span><span class="o">=</span><span class="n">trialsTiffs</span><span class="p">,</span> <span class="n">s2pResultsPath</span><span class="o">=</span><span class="n">s2pResultsPath</span><span class="p">)</span></div>

<div class="viewcode-block" id="Suite2pExperiment.add_bad_frames"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.suite2p.Suite2pExperiment.add_bad_frames">[docs]</a>    <span class="k">def</span> <span class="nf">add_bad_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frames</span><span class="p">,</span> <span class="n">bad_frames_npy_loc</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Add frames to bad_frames.npy file that will be excluded by Suite2p during ROI segmentation.</span>

<span class="sd">        :param frames: frames to add as bad_frames.</span>
<span class="sd">        :param bad_frames_npy_loc: directory to save bad_frame.npy file</span>
<span class="sd">        """</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bad_frames</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bad_frames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bad_frames</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bad_frames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">'\- Appending a total of '</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">frames</span><span class="p">),</span> <span class="s1">'to bad_frames.npy'</span><span class="p">,</span>
                  <span class="sa">f</span><span class="s2">"</span><span class="se">\n\t</span><span class="s2"> total bad_frames: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bad_frames</span><span class="p">)</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">'</span><span class="si">%s</span><span class="s1">/bad_frames.npy'</span> <span class="o">%</span> <span class="n">bad_frames_npy_loc</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bad_frames</span><span class="p">)</span>  <span class="c1"># save to npy file and remember to move npy file to tiff folder before running with suite2p</span></div>

<div class="viewcode-block" id="Suite2pExperiment.setupForSuite2p"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.suite2p.Suite2pExperiment.setupForSuite2p">[docs]</a>    <span class="k">def</span> <span class="nf">setupForSuite2p</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trialsSuite2P</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">TrialsInformation</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Run housekeeping tasks to organize fields prior to running Suite2p pipeline.</span>
<span class="sd">        </span>
<span class="sd">        :param trialsSuite2P: list of trials to use for Suite2p setup</span>
<span class="sd">        :param TrialsInformation: dictionary mapping trial ID to tiff_path to use for Suite2p processing of that trial</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">            :fs:</span>
<span class="sd">            :nplanes:</span>
<span class="sd">            :pix_sz_x:</span>
<span class="sd">            :pix_sz_y:</span>
<span class="sd">            :frame_x:</span>
<span class="sd">            :frame_y:</span>
<span class="sd">            :n_channels:</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="n">trialsSuite2P</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trials</span><span class="p">:</span>

            <span class="n">trialsTiffs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="n">trialsSuite2P</span><span class="p">:</span>
                <span class="n">trialsTiffs</span><span class="p">[</span><span class="n">trial</span><span class="p">]</span> <span class="o">=</span> <span class="n">TrialsInformation</span><span class="p">[</span><span class="n">trial</span><span class="p">][</span><span class="s1">'tiff_path'</span><span class="p">]</span>

            <span class="n">Suite2p_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subSuite2p</span><span class="p">(</span><span class="n">trialsTiffs</span><span class="o">=</span><span class="n">trialsTiffs</span><span class="p">,</span> <span class="n">s2pResultsPath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">s2pResultsPath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Suite2p_obj</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="c1"># self.trials = trialsSuite2P if trialsSuite2P else self.trials</span>

        <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="n">Suite2p_obj</span><span class="o">.</span><span class="n">trials</span><span class="p">:</span>
            <span class="n">Suite2p_obj</span><span class="o">.</span><span class="n">tiff_paths_to_use_s2p</span><span class="p">[</span><span class="n">trial</span><span class="p">]</span> <span class="o">=</span> <span class="n">TrialsInformation</span><span class="p">[</span><span class="n">trial</span><span class="p">][</span><span class="s1">'tiff_path'</span><span class="p">]</span>

        <span class="c1"># load the first tiff in Suite2p_obj.trials to collect default metainformation about imaging setup parameters</span>
        <span class="n">trial</span> <span class="o">=</span> <span class="n">Suite2p_obj</span><span class="o">.</span><span class="n">trials</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="kn">from</span> <span class="nn">imagingplus</span> <span class="kn">import</span> <span class="n">import_obj</span>
        <span class="kn">from</span> <span class="nn">imagingplus.main.core</span> <span class="kn">import</span> <span class="n">ImagingTrial</span>
        <span class="n">trialobj</span><span class="p">:</span> <span class="n">ImagingTrial</span> <span class="o">=</span> <span class="n">import_obj</span><span class="p">(</span><span class="n">TrialsInformation</span><span class="p">[</span><span class="n">trial</span><span class="p">][</span><span class="s1">'analysis_object_information'</span><span class="p">][</span><span class="s1">'pkl path'</span><span class="p">])</span>

        <span class="c1"># set imaging parameters using defaults or kwargs if provided</span>
        <span class="n">fps</span> <span class="o">=</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">fps</span> <span class="k">if</span> <span class="s1">'fs'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'fs'</span><span class="p">]</span>
        <span class="n">n_planes</span> <span class="o">=</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">n_planes</span> <span class="k">if</span> <span class="s1">'n_planes'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'n_planes'</span><span class="p">]</span>
        <span class="n">pix_sz_x</span> <span class="o">=</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">pix_sz_x</span> <span class="k">if</span> <span class="s1">'pix_sz_x'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'pix_sz_x'</span><span class="p">]</span>
        <span class="n">pix_sz_y</span> <span class="o">=</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">pix_sz_y</span> <span class="k">if</span> <span class="s1">'pix_sz_y'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'pix_sz_y'</span><span class="p">]</span>
        <span class="n">frame_x</span> <span class="o">=</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">frame_x</span> <span class="k">if</span> <span class="s1">'frame_x'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'frame_x'</span><span class="p">]</span>
        <span class="n">frame_y</span> <span class="o">=</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">frame_y</span> <span class="k">if</span> <span class="s1">'frame_y'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'frame_y'</span><span class="p">]</span>
        <span class="n">n_channels</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'n_channels'</span><span class="p">]</span> <span class="k">if</span> <span class="s1">'n_channels'</span> <span class="ow">in</span> <span class="p">[</span><span class="o">*</span><span class="n">kwargs</span><span class="p">]</span> <span class="k">else</span> <span class="mi">1</span>  <span class="c1"># default is 1 channel imaging in .tiffs for suite2p</span>

        <span class="c1"># setup ops dictionary</span>
        <span class="n">Suite2p_obj</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s1">'fs'</span><span class="p">]</span> <span class="o">=</span> <span class="n">fps</span> <span class="o">/</span> <span class="n">n_planes</span>
        <span class="n">diameter_x</span> <span class="o">=</span> <span class="mi">13</span> <span class="o">/</span> <span class="n">pix_sz_x</span>
        <span class="n">diameter_y</span> <span class="o">=</span> <span class="mi">13</span> <span class="o">/</span> <span class="n">pix_sz_y</span>
        <span class="n">Suite2p_obj</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s1">'diameter'</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">diameter_x</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">diameter_y</span><span class="p">)</span> <span class="k">if</span> <span class="n">diameter_y</span> <span class="o">!=</span> <span class="n">diameter_x</span> <span class="k">else</span> <span class="n">diameter_x</span>

        <span class="c1"># set other ops parameters if provided in kwargs:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">[</span><span class="o">*</span><span class="n">Suite2p_obj</span><span class="o">.</span><span class="n">ops</span><span class="p">]:</span>
                <span class="n">Suite2p_obj</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># calculate batch size to use in Suite2p run</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="n">Suite2p_obj</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s1">'batch_size'</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">262144</span> <span class="o">/</span> <span class="p">(</span>
                <span class="n">frame_x</span> <span class="o">*</span> <span class="n">frame_y</span><span class="p">))</span>  <span class="c1"># larger key_frames will be more RAM intensive, scale user batch size based on num pixels in 512x512 images</span>

        <span class="c1"># setup db dict</span>
        <span class="n">Suite2p_obj</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'fs'</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">Suite2p_obj</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s1">'fs'</span><span class="p">]),</span> <span class="s1">'diameter'</span><span class="p">:</span> <span class="n">Suite2p_obj</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s1">'diameter'</span><span class="p">],</span>
                          <span class="s1">'batch_size'</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">batch_size</span><span class="p">),</span>
                          <span class="s1">'nimg_init'</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">Suite2p_obj</span><span class="o">.</span><span class="n">ops</span><span class="p">[</span><span class="s1">'batch_size'</span><span class="p">]),</span> <span class="s1">'nplanes'</span><span class="p">:</span> <span class="n">n_planes</span><span class="p">,</span> <span class="s1">'nchannels'</span><span class="p">:</span> <span class="n">n_channels</span><span class="p">,</span>
                          <span class="s1">'tiff_list'</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">Suite2p_obj</span><span class="o">.</span><span class="n">tiff_paths_to_use_s2p</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
                          <span class="s1">'data_path'</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">trialobj</span><span class="o">.</span><span class="n">dataPath</span><span class="p">),</span>
                          <span class="s1">'save_folder'</span><span class="p">:</span> <span class="n">Suite2p_obj</span><span class="o">.</span><span class="n">s2pResultsPath</span><span class="p">}</span></div>

<div class="viewcode-block" id="Suite2pExperiment.s2pRun"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.suite2p.Suite2pExperiment.s2pRun">[docs]</a>    <span class="k">def</span> <span class="nf">s2pRun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expobj</span><span class="p">,</span> <span class="n">trialsSuite2P</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'all'</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Run suite2p pipeline.</span>
<span class="sd">        </span>
<span class="sd">        :param expobj: experiment object to run Suite2p on.</span>
<span class="sd">        :param trialsSuite2P: list of trials to run for Suite2p</span>
<span class="sd">        """</span>
        <span class="n">s2pRun</span><span class="p">(</span><span class="n">expobj</span><span class="p">,</span> <span class="n">trialsSuite2P</span><span class="o">=</span><span class="n">trialsSuite2P</span><span class="p">)</span></div>

<div class="viewcode-block" id="Suite2pExperiment.s2pROIsTiff"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.suite2p.Suite2pExperiment.s2pROIsTiff">[docs]</a>    <span class="k">def</span> <span class="nf">s2pROIsTiff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_path</span><span class="p">,</span> <span class="n">cell_ids</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'all'</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Save a TIFF image of the suite2p ROIs masks.</span>
<span class="sd">        # todo test function</span>

<span class="sd">        :param save_path: path to save to</span>
<span class="sd">        :param cell_ids: IDs of Suite2p ROI masks to show in image (use 'all' (default) to plot all ROI masks)</span>
<span class="sd">        """</span>

        <span class="n">mask_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">output_ops</span><span class="p">[</span><span class="s1">'Ly'</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_ops</span><span class="p">[</span><span class="s1">'Lx'</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'uint8'</span><span class="p">)</span>

        <span class="n">cell_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id</span> <span class="k">if</span> <span class="n">cell_ids</span> <span class="o">==</span> <span class="s1">'all'</span> <span class="k">else</span> <span class="n">cell_ids</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iscell</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">cell_ids</span><span class="p">:</span>
                <span class="n">ypix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">'ypix'</span><span class="p">]</span>
                <span class="n">xpix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s1">'xpix'</span><span class="p">]</span>
                <span class="n">mask_img</span><span class="p">[</span><span class="n">ypix</span><span class="p">,</span> <span class="n">xpix</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

        <span class="n">WriteTiff</span><span class="p">(</span><span class="n">save_path</span><span class="o">=</span><span class="n">save_path</span><span class="p">,</span> <span class="n">stack</span><span class="o">=</span><span class="n">mask_img</span><span class="p">)</span></div></div>


<span class="c1"># noinspection DuplicatedCode</span>
<div class="viewcode-block" id="Suite2pResultsTrial"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.suite2p.Suite2pResultsTrial">[docs]</a><span class="k">class</span> <span class="nc">Suite2pResultsTrial</span><span class="p">(</span><span class="n">CellAnnotations</span><span class="p">,</span> <span class="n">ImagingData</span><span class="p">):</span>
    <span class="sd">"""Class to collect and store suite2p processed cellsdata for one trial - out of overall experiment."""</span>

<div class="viewcode-block" id="Suite2pResultsTrial.__init__"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.suite2p.Suite2pResultsTrial.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s2pExp</span><span class="p">:</span> <span class="n">Suite2pExperiment</span><span class="p">,</span> <span class="n">trial_frames</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Connecting Suite2p results from a specific trial (which spans trial_frames out of the overall Suite2p run) to that trial.</span>

<span class="sd">        :param s2pExp:</span>
<span class="sd">        :param trial_frames:</span>


<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__s2pResultExists</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s2pResultsPath</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1">#: path where s2p results were loaded from</span>
        <span class="c1"># self.raw: np.ndarray  #: array of raw Flu values from suite2p output [num cells x length of imaging acquisition], one per plane</span>
        <span class="c1"># self.spks: np.ndarray  #: array of deconvolved spks values from suite2p output [num cells x length of imaging acquisition], one per plane</span>
        <span class="c1"># self.neuropil: np.ndarray  #: array of neuropil Flu values from suite2p output [num cells x length of imaging acquisition], one per plane</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iscell</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_units</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_ops</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stat</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># self.cell_id = None</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">\----- ADDING .Suite2p module to trial ... "</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">'</span><span class="se">\r</span><span class="s1">'</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">trial_frames</span> <span class="o">=</span> <span class="n">trial_frames</span>  <span class="c1"># tuple of first and last frame (out of the overall suite2p run) corresponding to the present trial</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">"</span><span class="se">\t</span><span class="s2">|- current trial key_frames: </span><span class="si">{</span><span class="n">trial_frames</span><span class="si">}</span><span class="s2"> out of </span><span class="si">{</span><span class="n">s2pExp</span><span class="o">.</span><span class="n">n_frames</span><span class="si">}</span><span class="s2"> total key_frames processed through suite2p"</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s2pExp</span><span class="o">.</span><span class="n">s2pResultsPath</span><span class="p">:</span>
            <span class="n">raw</span><span class="p">,</span> <span class="n">spks</span><span class="p">,</span> <span class="n">neuropil</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_suite2pResults</span><span class="p">(</span><span class="n">s2pExp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'cannot create s2p results trial without existing results in the input s2pExperiment.'</span><span class="p">)</span>

        <span class="n">cells_data</span><span class="p">,</span> <span class="n">cells_multidim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getCellsAnnotations</span><span class="p">()</span>
        <span class="c1"># super(Suite2pResultsTrial, self).__init__(cells_array=cells_data.index, annotations=cells_data.columns, cellsdata=cells_data, multidim_data=cells_multidim)</span>

        <span class="n">CellAnnotations</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cells_array</span><span class="o">=</span><span class="n">cells_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iscell</span><span class="p">],</span> <span class="n">annotations</span><span class="o">=</span><span class="n">cells_data</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                                 <span class="n">cellsdata</span><span class="o">=</span><span class="n">cells_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iscell</span><span class="p">],</span> <span class="n">multidim_data</span><span class="o">=</span><span class="n">cells_multidim</span><span class="p">)</span>

        <span class="n">ImagingData</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imdata</span><span class="o">=</span><span class="n">raw</span><span class="p">,</span> <span class="n">spks</span><span class="o">=</span><span class="n">spks</span><span class="p">,</span> <span class="n">neuropil</span><span class="o">=</span><span class="n">neuropil</span><span class="p">,</span> <span class="n">data_label</span><span class="o">=</span><span class="s1">''</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">\----- ADDED .Suite2p module to trial. "</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s1">'</span><span class="se">\r</span><span class="s1">'</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s2pResultExists</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">'Suite2p Results (trial level) Object, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trial_frames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> key_frames x </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rois</span><span class="si">}</span><span class="s1"> s2p ROIs'</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">'Suite2p Results (trial level) Object, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trial_frames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> key_frames. No Suite2p Results loaded.'</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s2pResultExists</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">'Suite2p Results (trial level) Object, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trial_frames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> key_frames x </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rois</span><span class="si">}</span><span class="s1"> s2p ROIs'</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s1">'Suite2p Results (trial level) Object, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trial_frames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s1"> key_frames. No Suite2p Results loaded.'</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">s2pResultExists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Return true if suite2p results exist for current trial.</span>
<span class="sd">        """</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__s2pResultExists</span>

    <span class="nd">@s2pResultExists</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">s2pResultExists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Set true if suite2p results exist for current trial.</span>
<span class="sd">        :param val:</span>
<span class="sd">        """</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__s2pResultExists</span> <span class="o">=</span> <span class="n">val</span>

    <span class="k">def</span> <span class="nf">_get_suite2pResults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s2pExp</span><span class="p">:</span> <span class="n">Suite2pExperiment</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Get suite2p results for current trial's key_frames.</span>
<span class="sd">        </span>
<span class="sd">        :param s2pExp:</span>
<span class="sd">        :return:</span>
<span class="sd">        """</span>

        <span class="c1"># self.cell_id = s2pExp.cell_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stat</span> <span class="o">=</span> <span class="n">s2pExp</span><span class="o">.</span><span class="n">stat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_ops</span> <span class="o">=</span> <span class="n">s2pExp</span><span class="o">.</span><span class="n">output_ops</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_units</span> <span class="o">=</span> <span class="n">s2pExp</span><span class="o">.</span><span class="n">n_units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iscell</span> <span class="o">=</span> <span class="n">s2pExp</span><span class="o">.</span><span class="n">iscell</span>

        <span class="n">raw</span> <span class="o">=</span> <span class="n">s2pExp</span><span class="o">.</span><span class="n">raw</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="bp">self</span><span class="o">.</span><span class="n">trial_frames</span><span class="p">[</span>
            <span class="mi">1</span><span class="p">]]</span>
        <span class="n">spks</span> <span class="o">=</span> <span class="n">s2pExp</span><span class="o">.</span><span class="n">spks</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="bp">self</span><span class="o">.</span><span class="n">trial_frames</span><span class="p">[</span>
            <span class="mi">1</span><span class="p">]]</span>
        <span class="n">neuropil</span> <span class="o">=</span> <span class="n">s2pExp</span><span class="o">.</span><span class="n">neuropil</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="bp">self</span><span class="o">.</span><span class="n">trial_frames</span><span class="p">[</span>
            <span class="mi">1</span><span class="p">]]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">s2pResultExists</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">im</span> <span class="o">=</span> <span class="n">stats_dicts_to_3d_array_</span><span class="p">(</span><span class="n">stat_dict</span><span class="o">=</span><span class="n">s2pExp</span><span class="o">.</span><span class="n">stat</span><span class="p">,</span> <span class="n">output_ops</span><span class="o">=</span><span class="n">s2pExp</span><span class="o">.</span><span class="n">output_ops</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">s2pResultsPath</span> <span class="o">=</span> <span class="n">s2pExp</span><span class="o">.</span><span class="n">s2pResultsPath</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">raw</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">spks</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">neuropil</span><span class="p">)</span>

<div class="viewcode-block" id="Suite2pResultsTrial.makeFrameAverageTiff"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.suite2p.Suite2pResultsTrial.makeFrameAverageTiff">[docs]</a>    <span class="k">def</span> <span class="nf">makeFrameAverageTiff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_tif_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">frames</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">],</span> <span class="n">peri_frames</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                             <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">to_plot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">"""Creates, plots and/or saves an average image of the specified number of peri-key_frames around the given frame from the suite2p registered TIFF file.</span>

<span class="sd">        :param reg_tif_dir: registered tiff directory (from Suite2p results directory)</span>
<span class="sd">        :param frames: key frames to plot average image</span>
<span class="sd">        :param peri_frames: number of frames to collect pre- and post- from key frame</span>
<span class="sd">        :param save_dir: directory to save tiff images to</span>
<span class="sd">        :param to_plot: if true, show peri-frame average image</span>
<span class="sd">        :param kwargs: see kwargs under imagingplus.plotting.plotting.plotImg</span>
<span class="sd">        :return: peri-frame averaged array images</span>
<span class="sd">        """</span>

        <span class="c1"># read in registered tiff</span>
        <span class="n">reg_tif_folder</span> <span class="o">=</span> <span class="n">reg_tif_dir</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">reg_tif_dir</span><span class="p">),</span> <span class="s1">'`reg_tif_dir` could not be found.'</span>
        <span class="n">reg_tif_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">reg_tif_dir</span><span class="p">)</span>
        <span class="n">reg_tif_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">frames</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">frames</span> <span class="o">=</span> <span class="p">[</span><span class="n">frames</span><span class="p">]</span>

        <span class="n">frames_s2prun_num</span> <span class="o">=</span> <span class="p">[(</span><span class="n">frame</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">]</span>

        <span class="n">imgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frames_s2prun_num</span><span class="p">):</span>
            <span class="n">batch_num</span> <span class="o">=</span> <span class="n">frame</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_ops</span><span class="p">[</span><span class="s1">'batch_size'</span><span class="p">]</span>

            <span class="n">tif_path</span> <span class="o">=</span> <span class="n">reg_tif_folder</span> <span class="o">+</span> <span class="n">reg_tif_list</span><span class="p">[</span><span class="n">batch_num</span><span class="p">]</span>

            <span class="c1"># im_batch_reg = tf.imread(tif_path, key=range(0, self.output_ops['batch_size']))</span>
            <span class="n">im_batch_reg</span> <span class="o">=</span> <span class="n">ImportTiff</span><span class="p">(</span><span class="n">tif_path</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_ops</span><span class="p">[</span><span class="s1">'batch_size'</span><span class="p">]))</span>

            <span class="n">frame_num_batch</span> <span class="o">=</span> <span class="n">frame</span> <span class="o">-</span> <span class="p">(</span><span class="n">batch_num</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_ops</span><span class="p">[</span><span class="s1">'batch_size'</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">frame_num_batch</span> <span class="o">&lt;</span> <span class="n">peri_frames</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">peri_frames_low</span> <span class="o">=</span> <span class="n">frame_num_batch</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">peri_frames_low</span> <span class="o">=</span> <span class="n">peri_frames</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">peri_frames_high</span> <span class="o">=</span> <span class="n">peri_frames</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">im_sub_reg</span> <span class="o">=</span> <span class="n">im_batch_reg</span><span class="p">[</span><span class="n">frame_num_batch</span> <span class="o">-</span> <span class="n">peri_frames_low</span><span class="p">:</span> <span class="n">frame_num_batch</span> <span class="o">+</span> <span class="n">peri_frames_high</span><span class="p">]</span>

            <span class="n">avg_sub</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">im_sub_reg</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># convert to 8-bit</span>
            <span class="kn">from</span> <span class="nn">imagingplus.utils.images</span> <span class="kn">import</span> <span class="n">convert_to_8bit</span>
            <span class="n">avg_sub</span> <span class="o">=</span> <span class="n">convert_to_8bit</span><span class="p">(</span><span class="n">avg_sub</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">save_dir</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">'.tif'</span> <span class="ow">in</span> <span class="n">save_dir</span><span class="p">:</span>
                    <span class="n">save_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">save_dir</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'/'</span>
                <span class="n">save_path</span> <span class="o">=</span> <span class="n">save_dir</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">'/</span><span class="si">{</span><span class="n">frames</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="si">}</span><span class="s1">_s2preg_frame_avg.tif'</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t</span><span class="s2">\- Saving averaged s2p registered tiff for frame: </span><span class="si">{</span><span class="n">frames</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="si">}</span><span class="s2">, to: </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
                <span class="n">tf</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">avg_sub</span><span class="p">,</span> <span class="n">photometric</span><span class="o">=</span><span class="s1">'minisblack'</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">to_plot</span><span class="p">:</span>  <span class="c1"># todo replace with proper plotting average tiff frame code</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">peri_frames</span><span class="si">}</span><span class="s1"> key_frames avg from s2p reg tif, frame: </span><span class="si">{</span><span class="n">frames</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="si">}</span><span class="s1">'</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span> <span class="k">else</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span>
                <span class="kn">from</span> <span class="nn">imagingplus.plotting.plotting</span> <span class="kn">import</span> <span class="n">plotImg</span>
                <span class="n">plotImg</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="n">avg_sub</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">imgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg_sub</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Suite2pResultsTrial.makeDownSampledTiff"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.suite2p.Suite2pResultsTrial.makeDownSampledTiff">[docs]</a>    <span class="k">def</span> <span class="nf">makeDownSampledTiff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">group_by</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">reg_tif_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frameNum</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="s1">'all'</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Makes downsampled TIFF of current suite2p trial imaging series</span>
<span class="sd">        </span>
<span class="sd">        :param save_path: path to save downsampled TIFF.</span>
<span class="sd">        :param group_by: number of frames to created grouped average output.</span>
<span class="sd">        :param reg_tif_folder: registered tiff directory</span>
<span class="sd">        :param frameNum: frame numbers (start and end) to create downsampled tiff for (use 'all' (default) to create downsampled tiff for all frames).</span>
<span class="sd">        """</span>
        <span class="n">reg_tif_folder</span> <span class="o">=</span> <span class="n">reg_tif_folder</span> <span class="k">if</span> <span class="n">reg_tif_folder</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">s2pResultsPath</span> <span class="o">+</span> <span class="s1">'/reg_tif/'</span>

        <span class="n">sorted_paths</span><span class="p">,</span> <span class="n">first_tiff_offset</span><span class="p">,</span> <span class="n">last_tiff_offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getRegTiffPaths</span><span class="p">(</span><span class="n">reg_tif_folder</span><span class="o">=</span><span class="n">reg_tif_folder</span><span class="p">,</span> <span class="n">frameNum</span><span class="o">=</span><span class="n">frameNum</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">make_tiff_stack</span><span class="p">(</span><span class="n">sorted_paths</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">trial_frames_cropped</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">first_tiff_offset</span><span class="p">:</span> <span class="o">-</span><span class="n">last_tiff_offset</span><span class="p">]</span>
        <span class="n">SaveDownsampledTiff</span><span class="p">(</span><span class="n">stack</span><span class="o">=</span><span class="n">trial_frames_cropped</span><span class="p">,</span> <span class="n">group_by</span><span class="o">=</span><span class="n">group_by</span><span class="p">,</span> <span class="n">save_as</span><span class="o">=</span><span class="n">save_path</span><span class="p">)</span></div>

<div class="viewcode-block" id="Suite2pResultsTrial.getRegTiffPaths"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.suite2p.Suite2pResultsTrial.getRegTiffPaths">[docs]</a>    <span class="k">def</span> <span class="nf">getRegTiffPaths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reg_tif_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frameNum</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'all'</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Return current imaging trial's suite2p output registered tiff paths for a certain frame number (default is for all trial frames). note that suite2p uses batched registration and creates batched motion registered tiffs.</span>

<span class="sd">        :param reg_tif_folder: registered tiff directory</span>
<span class="sd">        :param frameNum: frame numbers (start and end) to create downsampled tiff for (use 'all' (default) to create downsampled tiff for all frames).</span>
<span class="sd">        """</span>
        <span class="n">reg_tif_folder</span> <span class="o">=</span> <span class="n">reg_tif_folder</span> <span class="k">if</span> <span class="n">reg_tif_folder</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">s2pResultsPath</span> <span class="o">+</span> <span class="s1">'/reg_tif/'</span>
        <span class="n">reg_tif_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">reg_tif_folder</span><span class="p">)</span>
        <span class="n">reg_tif_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">tif_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">reg_tif_list</span> <span class="k">if</span> <span class="s1">'.tif'</span> <span class="ow">in</span> <span class="n">file</span><span class="p">]</span>

        <span class="n">curr_trial_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_frames</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_ops</span><span class="p">[</span><span class="s1">'batch_size'</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">frameNum</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="n">s2p_frame</span> <span class="o">=</span> <span class="n">curr_trial_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">frameNum</span>

            <span class="n">idx</span> <span class="o">=</span> <span class="n">s2p_frame</span> <span class="o">//</span> <span class="n">batch_size</span>
            <span class="n">tiff_path</span> <span class="o">=</span> <span class="n">reg_tif_folder</span> <span class="o">+</span> <span class="n">tif_list</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

            <span class="n">offsetFrameNum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">s2p_frame</span> <span class="o">%</span> <span class="n">batch_size</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">tiff_path</span><span class="p">,</span> <span class="n">offsetFrameNum</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">frameNum</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">frameNum</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">tuple</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">curr_trial_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">frameNum</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">))</span>
            <span class="n">end</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">curr_trial_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">frameNum</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">start</span> <span class="o">==</span> <span class="n">end</span><span class="p">:</span>  <span class="c1"># i.e. if the frames selected for crop are in the same batch .tif</span>
                <span class="n">stacks</span> <span class="o">=</span> <span class="p">[</span><span class="n">start</span><span class="p">]</span>
                <span class="n">last_tiff_offset</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="n">frameNum</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stacks</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">end</span><span class="p">))</span> <span class="k">if</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="p">[</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">]</span>
                <span class="n">last_tiff_offset</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="o">-</span> <span class="nb">int</span><span class="p">((</span><span class="n">curr_trial_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">frameNum</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">%</span> <span class="n">batch_size</span><span class="p">)</span>

            <span class="n">reg_tif_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">reg_tif_folder</span><span class="p">)</span>
            <span class="n">reg_tif_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">tif_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">reg_tif_list</span> <span class="k">if</span> <span class="s1">'.tif'</span> <span class="ow">in</span> <span class="n">file</span><span class="p">]</span>

            <span class="n">tiff_paths_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">reg_tif_folder</span> <span class="o">+</span> <span class="n">tif_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stacks</span><span class="p">]</span>

            <span class="n">first_tiff_offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">curr_trial_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">frameNum</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">start</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">))</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">tiff_paths_list</span><span class="p">,</span> <span class="n">first_tiff_offset</span><span class="p">,</span> <span class="n">last_tiff_offset</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">tiff_paths_list</span><span class="p">,</span> <span class="n">first_tiff_offset</span><span class="p">,</span> <span class="n">last_tiff_offset</span>
        <span class="k">elif</span> <span class="n">frameNum</span> <span class="o">==</span> <span class="s1">'all'</span><span class="p">:</span>
            <span class="n">reg_tif_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">reg_tif_folder</span><span class="p">)</span>
            <span class="n">reg_tif_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">tif_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">reg_tif_list</span> <span class="k">if</span> <span class="s1">'.tif'</span> <span class="ow">in</span> <span class="n">file</span><span class="p">]</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">curr_trial_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">batch_size</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">curr_trial_frames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="n">batch_size</span>

            <span class="n">tiff_paths_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">reg_tif_folder</span> <span class="o">+</span> <span class="n">tif_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)]</span>

            <span class="n">first_tiff_offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">curr_trial_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">start</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">))</span>
            <span class="n">last_tiff_offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">curr_trial_frames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">%</span> <span class="n">batch_size</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">tiff_paths_list</span><span class="p">,</span> <span class="n">first_tiff_offset</span><span class="p">,</span> <span class="n">last_tiff_offset</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">'frameNum must be `all` or an int of a frame number.'</span><span class="p">)</span></div>

<div class="viewcode-block" id="Suite2pResultsTrial.getCellsAnnotations"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.suite2p.Suite2pResultsTrial.getCellsAnnotations">[docs]</a>    <span class="k">def</span> <span class="nf">getCellsAnnotations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Get cell annotations from Suite2p output to use in creating anndata structure.</span>
<span class="sd">        """</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s2pResultExists</span><span class="p">:</span>
            <span class="c1"># SETUP THE OBSERVATIONS (CELLS) ANNOTATIONS TO USE IN anndata</span>
            <span class="c1"># build dataframe for obs_meta from suite2p stat information</span>
            <span class="n">obs_meta</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="p">)))[</span><span class="bp">self</span><span class="o">.</span><span class="n">iscell</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">__stat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">__column</span> <span class="ow">in</span> <span class="p">[</span><span class="o">*</span><span class="n">__stat</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">__column</span> <span class="ow">in</span> <span class="n">obs_meta</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">obs_meta</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">__column</span><span class="p">]</span> <span class="o">=</span> <span class="n">__stat</span><span class="p">[</span><span class="n">__column</span><span class="p">]</span>

            <span class="n">obs_m</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'ypix'</span><span class="p">:</span> <span class="p">[],</span>
                     <span class="s1">'xpix'</span><span class="p">:</span> <span class="p">[]}</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="o">*</span><span class="n">obs_m</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">__stat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stat</span><span class="p">):</span>
                    <span class="n">obs_m</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">__stat</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
                <span class="n">obs_m</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">obs_m</span><span class="p">[</span><span class="n">col</span><span class="p">])[</span><span class="bp">self</span><span class="o">.</span><span class="n">iscell</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">obs_meta</span><span class="p">,</span> <span class="n">obs_m</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'cannot get cell annotations. no s2p results found in trial.'</span><span class="p">)</span></div>

<div class="viewcode-block" id="Suite2pResultsTrial.stitch_s2p_reg_tiff"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.suite2p.Suite2pResultsTrial.stitch_s2p_reg_tiff">[docs]</a>    <span class="k">def</span> <span class="nf">stitch_s2p_reg_tiff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">reg_tif_folder</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Concatenate suite2p registered tiffs into a single stack.</span>

<span class="sd">        :param save_path: path to save stack.</span>
<span class="sd">        :param reg_tif_folder: folder to retrieve suite2p registered tiffs from.</span>
<span class="sd">        """</span>
        <span class="c1"># TODO test out</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">s2pResultExists</span><span class="p">,</span> <span class="n">UnavailableOptionError</span><span class="p">(</span><span class="s1">'stitch_s2p_reg_tiff'</span><span class="p">)</span>

        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">save_path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">tif_path_save2</span> <span class="o">=</span> <span class="n">save_path</span> <span class="k">if</span> <span class="n">save_path</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_ops</span><span class="p">[</span>
            <span class="s1">'batch_size'</span><span class="p">]</span>  <span class="c1"># 2000 because that is the batch size for suite2p run</span>
        <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_frames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_ops</span><span class="p">[</span><span class="s1">'batch_size'</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">reg_tif_folder</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">s2pResultsPath</span><span class="p">:</span>
                <span class="n">reg_tif_folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">s2pResultsPath</span> <span class="o">+</span> <span class="s1">'/reg_tif/'</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"|____ trying to load registered tiffs from: </span><span class="si">{</span><span class="n">reg_tif_folder</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"Must provide reg_tif_folder s2pResultsPath for loading registered tiffs"</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">reg_tif_folder</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"no registered tiffs found at s2pResultsPath: </span><span class="si">{</span><span class="n">reg_tif_folder</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># set tiff paths to save registered tiffs:</span>
        <span class="n">tif_path_save</span> <span class="o">=</span> <span class="n">tif_path_save2</span>
        <span class="n">reg_tif_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">reg_tif_folder</span><span class="p">)</span>
        <span class="n">reg_tif_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">sorted_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">reg_tif_folder</span> <span class="o">+</span> <span class="n">tif</span> <span class="k">for</span> <span class="n">tif</span> <span class="ow">in</span> <span class="n">reg_tif_list</span><span class="p">][</span><span class="n">start</span><span class="p">:</span><span class="n">end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">tif_path_save</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">sorted_paths</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tif_path_save</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">make_tiff_stack</span><span class="p">(</span><span class="n">sorted_paths</span><span class="p">,</span> <span class="n">save_path</span><span class="o">=</span><span class="n">tif_path_save</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tif_path_save2</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">TiffWriter</span><span class="p">(</span><span class="n">tif_path_save2</span><span class="p">,</span> <span class="n">bigtiff</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">tif</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">TiffFile</span><span class="p">(</span><span class="n">tif_path_save2</span><span class="p">,</span> <span class="n">multifile</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">input_tif</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">'cropping registered tiff'</span><span class="p">)</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">input_tif</span><span class="o">.</span><span class="n">asarray</span><span class="p">()</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">'shape of stitched tiff: '</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

                <span class="c1"># todo test and debug and fix</span>
                <span class="n">reg_tif_crop</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">trial_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">start</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_ops</span><span class="p">[</span><span class="s1">'batch_size'</span><span class="p">]:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">trial_frames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">trial_frames</span> <span class="o">-</span> <span class="n">start</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_ops</span><span class="p">[</span><span class="s1">'batch_size'</span><span class="p">])]</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">'saving cropped tiff '</span><span class="p">,</span> <span class="n">reg_tif_crop</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">tif</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">reg_tif_crop</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cell_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""Return X and Y coordinates of cells</span>
<span class="sd">        """</span>
        <span class="k">assert</span> <span class="s1">'med'</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cellsdata</span><span class="p">,</span> <span class="s1">'med cannot be found in cells annotations under cellsdata'</span>
        <span class="n">coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n_cells</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">cell</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cellsdata</span><span class="p">[</span><span class="s1">'med'</span><span class="p">]):</span>
            <span class="n">coordinates</span><span class="p">[</span><span class="n">cell</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">coordinates</span><span class="p">[</span><span class="n">cell</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">coordinates</span>

<div class="viewcode-block" id="Suite2pResultsTrial.collectTiffList"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.suite2p.Suite2pResultsTrial.collectTiffList">[docs]</a>    <span class="k">def</span> <span class="nf">collectTiffList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">curr_trial_frames</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span> <span class="n">reg_tif_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Collects list of tiffs from registered tiff output folder for current trial of suite2p processed dataset.</span>

<span class="sd">        :param curr_trial_frames: frame start and end for current trial (relative to total suite2p experiment results).</span>
<span class="sd">        :param reg_tif_folder: folder to retrieve suite2p registered tiffs from.</span>
<span class="sd">        :return: list of tiffs</span>
<span class="sd">        """</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">reg_tif_folder</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"no registered tiffs found at path: </span><span class="si">{</span><span class="n">reg_tif_folder</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="c1"># collect list of registered tiffs associated with current trial</span>
        <span class="n">reg_tif_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">reg_tif_folder</span><span class="p">)</span>
        <span class="n">reg_tif_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">curr_trial_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_ops</span><span class="p">[</span><span class="s1">'batch_size'</span><span class="p">]</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">curr_trial_frames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_ops</span><span class="p">[</span><span class="s1">'batch_size'</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">tiffs_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
            <span class="n">tiff_path</span> <span class="o">=</span> <span class="n">reg_tif_folder</span> <span class="o">+</span> <span class="n">reg_tif_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">tiffs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tiff_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tiffs_list</span></div>

<div class="viewcode-block" id="Suite2pResultsTrial.collectSignalFromCoords"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.suite2p.Suite2pResultsTrial.collectSignalFromCoords">[docs]</a>    <span class="k">def</span> <span class="nf">collectSignalFromCoords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_coords_masks</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">reg_tif_folder</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">"""</span>
<span class="sd">        Collect average fluorescence signal from input coordinates (and their masks).</span>

<span class="sd">        uses registered tiffs to collect raw traces from provided target masks target areas</span>
<span class="sd">        :param target_coords_masks: array of masks of coordinates to collect signal from (for each cell).</span>
<span class="sd">        :param reg_tif_folder: folder to retrieve suite2p registered tiffs from.</span>
<span class="sd">        """</span>

        <span class="n">reg_tif_folder</span> <span class="o">=</span> <span class="n">reg_tif_folder</span> <span class="k">if</span> <span class="n">reg_tif_folder</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">s2pResultsPath</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_ops</span><span class="p">[</span><span class="s1">'batch_size'</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">reg_tif_folder</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">"no registered tiffs found at path: </span><span class="si">{</span><span class="n">reg_tif_folder</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="n">num_coords</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_coords_masks</span><span class="p">)</span>
        <span class="n">target_areas</span> <span class="o">=</span> <span class="n">target_coords_masks</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">'</span><span class="se">\n\n</span><span class="s1">collecting raw Flu traces from SLM target coord. areas from registered TIFFs from: </span><span class="si">{</span><span class="n">reg_tif_folder</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="c1"># read in registered tiff</span>
        <span class="n">reg_tif_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">reg_tif_folder</span><span class="p">)</span>
        <span class="n">reg_tif_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="n">tif_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">file</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">reg_tif_list</span> <span class="k">if</span> <span class="s1">'.tif'</span> <span class="ow">in</span> <span class="n">file</span><span class="p">]</span>
        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">batch_size</span>
        <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_frames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="n">batch_size</span>

        <span class="c1"># collect mean traces from target areas of each target coordinate by reading in individual registered tiffs that contain frames for current trial</span>
        <span class="c1"># targets_trace_full = np.zeros([num_coords, (end - start) * batch_size], dtype='float32')</span>
        <span class="n">targets_trace_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">num_coords</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'float32'</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tiff_path</span> <span class="o">=</span> <span class="n">reg_tif_folder</span> <span class="o">+</span> <span class="n">tif_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'|- reading tiff: </span><span class="si">{</span><span class="n">tiff_path</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">break</span>

            <span class="kn">import</span> <span class="nn">cv2</span>
            <span class="n">ret</span><span class="p">,</span> <span class="n">images</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imreadmulti</span><span class="p">(</span><span class="n">tiff_path</span><span class="p">,</span> <span class="p">[],</span> <span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_ANYCOLOR</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="se">\t</span><span class="s1">\- shape: </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
            <span class="n">targets_trace</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">num_coords</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'float32'</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_coords</span><span class="p">):</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">target_areas</span><span class="p">[</span><span class="n">coord</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">target_areas</span><span class="p">[</span><span class="n">coord</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
                <span class="n">targets_trace</span><span class="p">[</span><span class="n">coord</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">targets_trace_full</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">targets_trace_full</span><span class="p">,</span> <span class="n">targets_trace</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># targets_trace_full[:, (i - start) * batch_size: ((i - start) * batch_size) + data.shape[</span>
            <span class="c1">#     0]] = targets_trace  # iteratively write to each successive segment of the targets_trace array based on the length of the reg_tiff that is read in.</span>

        <span class="c1"># final part, crop to the *exact* frames for current trial</span>
        <span class="n">start_crop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">start</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">)</span>
        <span class="n">end_crop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">start</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trial_frames</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">trial_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">raw_coords_signal</span> <span class="o">=</span> <span class="n">targets_trace_full</span><span class="p">[:,</span> <span class="n">start_crop</span><span class="p">:</span> <span class="n">end_crop</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">raw_coords_signal</span></div></div>

<span class="c1">#### archiving away for now - trying to switch to an approach that doesn't inherit from parent suite2p obj.</span>
<span class="c1"># class Suite2PTrial_(Suite2pExperiment):</span>
<span class="c1">#     """used to collect and store suite2p processed cellsdata for one trial - out of overall experiment."""</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, trialsTiffsSuite2p: dict, trial_frames: tuple, s2pResultsPath: Optional[str] = None):</span>
<span class="c1">#         """</span>
<span class="c1">#         Connecting Suite2p results from a specific trial (which spans trial_frames out of the overall Suite2p run) to that trial.</span>
<span class="c1">#</span>
<span class="c1">#         :param trialsTiffsSuite2p:</span>
<span class="c1">#         :param dataPath:</span>
<span class="c1">#         :param trial_frames:</span>
<span class="c1">#         :param s2pResultsPath:</span>
<span class="c1">#         :param subtract_neuropil:</span>
<span class="c1">#         """</span>
<span class="c1">#         # todo need to reconsider this heirarchy; it saves in the entire suite2p result for every trial....</span>
<span class="c1">#         super().__init__(trialsTiffsSuite2p,</span>
<span class="c1">#                          s2pResultsPath)  # - TODO it really is confusing to be passing in all trials for a s2p results obj that should be restricted to just one trial</span>
<span class="c1">#</span>
<span class="c1">#         print(f"\n\----- ADDING .Suite2p module to trial ... ", end='\r')</span>
<span class="c1">#</span>
<span class="c1">#         ## initializing attributes to collect Suite2p results for this specific trial</span>
<span class="c1">#         # self.dfof: list(np.ndarray) = []  # array of dFF normalized Flu values from suite2p output [num cells x length of imaging acquisition], one per plane</span>
<span class="c1">#         # self.__raw: List[np.ndarray] = self.raw</span>
<span class="c1">#         # self.__spks: List[np.ndarray] = self.spks</span>
<span class="c1">#         # self.__neuropil: List[np.ndarray] = self.neuropil</span>
<span class="c1">#</span>
<span class="c1">#         self.trial_frames = trial_frames  # tuple of first and last frame (out of the overall suite2p run) corresponding to the present trial</span>
<span class="c1">#</span>
<span class="c1">#         # self.suite2p_overall = suite2p_experiment_obj</span>
<span class="c1">#         print(</span>
<span class="c1">#             f"\t|- current trial key_frames: {trial_frames} out of {self.n_frames} total key_frames processed through suite2p")</span>
<span class="c1">#         self._get_suite2pResults() if self.s2pResultsPath else None</span>
<span class="c1">#</span>
<span class="c1">#         # s2pResultsPath = suite2p_experiment_obj.s2pResultsPath if hasattr(suite2p_experiment_obj, 's2pResultsPath') else None</span>
<span class="c1">#         # Suite2pExperiment.__init__(self, trialsSuite2p = suite2p_experiment_obj.trials, s2pResultsPath=s2pResultsPath,</span>
<span class="c1">#         #                                   subtract_neuropil=suite2p_experiment_obj.subtract_neuropil)</span>
<span class="c1">#</span>
<span class="c1">#         print(f"\n\----- ADDED .Suite2p module to trial. ", end='\r')</span>
<span class="c1">#</span>
<span class="c1">#     def __repr__(self):</span>
<span class="c1">#         if self.s2pResultExists:</span>
<span class="c1">#             return f'Suite2p Results (trial level) Object, {self.trial_frames[1] - self.trial_frames[0]} key_frames x {self.n_units} s2p ROIs'</span>
<span class="c1">#         else:</span>
<span class="c1">#             return f'Suite2p Results (trial level) Object, {self.trial_frames[1] - self.trial_frames[0]} key_frames. No Suite2p Results loaded.'</span>
<span class="c1">#</span>
<span class="c1">#     def _get_suite2pResults(self):  # TODO complete code for getting suite2p results for trial</span>
<span class="c1">#         """crop suite2p cellsdata for key_frames only for the present trial"""</span>
<span class="c1">#</span>
<span class="c1">#         # for attr in ['n_units', 'cell_id', 'cell_plane', 'cell_x', 'cell_y', 'xoff', 'yoff', 'raw', 'spks', 'neuropil', 'stat']:</span>
<span class="c1">#         #     try:</span>
<span class="c1">#         #         setattr(self, attr, getattr(self.suite2p_overall, attr))</span>
<span class="c1">#         #     except AttributeError:</span>
<span class="c1">#         #         pass</span>
<span class="c1">#</span>
<span class="c1">#         if self.n_planes == 1:</span>
<span class="c1">#             self.cell_id = self.cell_id</span>
<span class="c1">#             self.stat = self.stat[0]</span>
<span class="c1">#</span>
<span class="c1">#             self.raw = self.raw[:, self.trial_frames[0]:self.trial_frames[</span>
<span class="c1">#                 1]]  # array of raw Flu values from suite2p output [num cells x length of imaging acquisition], one per plane</span>
<span class="c1">#             self.spks = self.spks[:, self.trial_frames[0]:self.trial_frames[</span>
<span class="c1">#                 1]]  # array of deconvolved spks values from suite2p output [num cells x length of imaging acquisition], one per plane</span>
<span class="c1">#             self.neuropil = self.neuropil[:, self.trial_frames[0]:self.trial_frames[</span>
<span class="c1">#                 1]]  # array of neuropil Flu values from suite2p output [num cells x length of imaging acquisition], one per plane</span>
<span class="c1">#</span>
<span class="c1">#             self.s2pResultExists = True</span>
<span class="c1">#</span>
<span class="c1">#         else:</span>
<span class="c1">#             for plane in range(self.n_planes):</span>
<span class="c1">#                 self.raw.append(self.raw[plane][:, self.trial_frames[0]:self.trial_frames[1]])</span>
<span class="c1">#                 self.spks.append(self.spks[plane][:, self.trial_frames[0]:self.trial_frames[1]])</span>
<span class="c1">#                 self.neuropil.append(self.neuropil[plane][:, self.trial_frames[0]:self.trial_frames[1]])</span>
<span class="c1">#</span>
<span class="c1">#                 # self.dfof.append(normalize_dff(self.raw[plane]))  # calculate df/f based on relevant key_frames</span>
<span class="c1">#                 self.s2pResultExists = True</span>
<span class="c1">#</span>
<span class="c1">#     def makeFrameAverageTiff(self, reg_tif_dir: str, frames: Union[int, list], peri_frames: int = 100,</span>
<span class="c1">#                              save_dir: str = None,</span>
<span class="c1">#                              to_plot=False):</span>
<span class="c1">#         """Creates, plots and/or saves an average image of the specified number of peri-key_frames around the given frame from the suite2p registered TIFF file.</span>
<span class="c1">#         """</span>
<span class="c1">#</span>
<span class="c1">#         # read in registered tiff</span>
<span class="c1">#         reg_tif_folder = reg_tif_dir</span>
<span class="c1">#         assert os.path.exists(reg_tif_dir), '`reg_tif_dir` could not be found.'</span>
<span class="c1">#         reg_tif_list = os.listdir(reg_tif_dir)</span>
<span class="c1">#         reg_tif_list.sort()</span>
<span class="c1">#</span>
<span class="c1">#         if type(frames) == int:</span>
<span class="c1">#             frames = [frames]</span>
<span class="c1">#</span>
<span class="c1">#         frames_s2prun_num = [(frame + self.trial_frames[0]) for frame in frames]</span>
<span class="c1">#</span>
<span class="c1">#         for idx, frame in enumerate(frames_s2prun_num):</span>
<span class="c1">#             batch_num = frame // self.ops['batch_size']</span>
<span class="c1">#</span>
<span class="c1">#             tif_path = reg_tif_folder + reg_tif_list[batch_num]</span>
<span class="c1">#</span>
<span class="c1">#             im_batch_reg = tf.imread(tif_path, key=range(0, self.ops['batch_size']))</span>
<span class="c1">#</span>
<span class="c1">#             frame_num_batch = frame - (batch_num * self.ops['batch_size'])</span>
<span class="c1">#</span>
<span class="c1">#             if frame_num_batch &lt; peri_frames // 2:</span>
<span class="c1">#                 peri_frames_low = frame_num_batch</span>
<span class="c1">#             else:</span>
<span class="c1">#                 peri_frames_low = peri_frames // 2</span>
<span class="c1">#             peri_frames_high = peri_frames // 2</span>
<span class="c1">#             im_sub_reg = im_batch_reg[frame_num_batch - peri_frames_low: frame_num_batch + peri_frames_high]</span>
<span class="c1">#</span>
<span class="c1">#             avg_sub = np.mean(im_sub_reg, axis=0)</span>
<span class="c1">#</span>
<span class="c1">#             # convert to 8-bit</span>
<span class="c1">#             from imagingplus.utils.utils import convert_to_8bit</span>
<span class="c1">#             avg_sub = convert_to_8bit(avg_sub, 0, 255)</span>
<span class="c1">#</span>
<span class="c1">#             if save_dir:</span>
<span class="c1">#                 if '.tif' in save_dir:</span>
<span class="c1">#                     from imagingplus.utils.utils import return_parent_dir</span>
<span class="c1">#                     save_dir = return_parent_dir(save_dir) + '/'</span>
<span class="c1">#                 save_path = save_dir + f'/{frames[idx]}_s2preg_frame_avg.tif'</span>
<span class="c1">#                 os.makedirs(save_dir, exist_ok=True)</span>
<span class="c1">#</span>
<span class="c1">#                 print(f"\t\- Saving averaged s2p registered tiff for frame: {frames[idx]}, to: {save_path}")</span>
<span class="c1">#                 tf.imwrite(save_path, avg_sub, photometric='minisblack')</span>
<span class="c1">#</span>
<span class="c1">#             if to_plot:</span>
<span class="c1">#                 plt.imshow(avg_sub, cmap='gray')</span>
<span class="c1">#                 plt.suptitle(f'{peri_frames} key_frames avg from s2p reg tif, frame: {frames[idx]}')</span>
<span class="c1">#                 plt.show()  # just plot for now to make sure that you are doing things correctly so far</span>


<span class="c1"># noinspection DuplicatedCode</span>
<div class="viewcode-block" id="add_suite2p_results"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.suite2p.add_suite2p_results">[docs]</a><span class="k">def</span> <span class="nf">add_suite2p_results</span><span class="p">(</span><span class="n">expobj</span><span class="p">,</span> <span class="n">s2p_trials</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'all'</span><span class="p">,</span> <span class="n">s2pResultsPath</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    todo: probably want to split up the bottom</span>
<span class="sd">    todo: test moving function to suite2p file.</span>
<span class="sd">    Wrapper for adding suite2p results to Experiment. Can only be run after adding trials to Experiment.</span>

<span class="sd">    :param expobj: Experiment object to add suite2p results to</span>
<span class="sd">    :param s2p_trials: list of trials to use for Suite2p processing/analysis pipeline, default = 'all' to use all trials of Experiment</span>
<span class="sd">    :param s2pResultsPath: optional, if suite2p already run then here provide path existing suite2p results</span>
<span class="sd">    """</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'\- Adding suite2p module to experiment. Located under .Suite2p'</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">([</span><span class="o">*</span><span class="n">expobj</span><span class="o">.</span><span class="n">TrialsInformation</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">imagingplus.utils.classes</span> <span class="kn">import</span> <span class="n">UnavailableOptionError</span>
        <span class="k">raise</span> <span class="n">UnavailableOptionError</span><span class="p">(</span><span class="s1">'need to add at least 1 trial to Experiment before adding Suite2p functionality.'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">s2p_trials</span> <span class="o">==</span> <span class="s1">'all'</span><span class="p">:</span> <span class="n">s2p_trials</span> <span class="o">=</span> <span class="n">expobj</span><span class="o">.</span><span class="n">trialIDs</span>
    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">s2p_trials</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">s2p_trials</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">'no s2p trials given in list form.'</span>
    <span class="n">_trialsTiffsSuite2p</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="n">s2p_trials</span><span class="p">:</span> <span class="n">_trialsTiffsSuite2p</span><span class="p">[</span><span class="n">trial</span><span class="p">]</span> <span class="o">=</span> <span class="n">expobj</span><span class="o">.</span><span class="n">TrialsInformation</span><span class="p">[</span><span class="n">trial</span><span class="p">][</span><span class="s1">'paths'</span><span class="p">][</span><span class="s1">'dataPath'</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">s2pResultsPath</span><span class="p">:</span>  <span class="c1"># if s2pResultsPath provided then try to find and pre-load results from provided s2pResultsPath, raise error if cannot find results</span>
        <span class="c1"># search for suite2p results items in expobj.suite2pPath, and auto-assign s2pRunComplete --&gt; True if found successfully</span>
        <span class="n">__suite2p_path_files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">s2pResultsPath</span><span class="p">)</span>
        <span class="n">expobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">s2pResultExists</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">filepath</span> <span class="ow">in</span> <span class="n">__suite2p_path_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">'ops.npy'</span> <span class="ow">in</span> <span class="n">filepath</span><span class="p">:</span>
                <span class="n">expobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">s2pResultExists</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">expobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">s2pResultExists</span><span class="p">:</span>
            <span class="n">expobj</span><span class="o">.</span><span class="n">_suite2p_save_path</span> <span class="o">=</span> <span class="n">s2pResultsPath</span>
            <span class="c1"># todo - why is this re'initing the whole s2p module??? this action should just be to add results to pre-existing module</span>
            <span class="n">expobj</span><span class="o">.</span><span class="n">Suite2p</span> <span class="o">=</span> <span class="n">Suite2pResultsExperiment</span><span class="p">(</span><span class="n">trialsTiffsSuite2p</span><span class="o">=</span><span class="n">expobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">_trialsTiffsSuite2p</span><span class="p">,</span>
                                                      <span class="n">s2pResultsPath</span><span class="o">=</span><span class="n">s2pResultsPath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">"suite2p results could not be found. `suite2pPath` provided was: </span><span class="si">{</span><span class="n">s2pResultsPath</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># no s2pResultsPath provided, so initialize without pre-loading any results</span>
        <span class="n">expobj</span><span class="o">.</span><span class="n">Suite2p</span> <span class="o">=</span> <span class="n">Suite2pResultsExperiment</span><span class="p">(</span><span class="n">trialsTiffsSuite2p</span><span class="o">=</span><span class="n">expobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">_trialsTiffsSuite2p</span><span class="p">)</span>

    <span class="c1"># print(expobj.Suite2p)</span>
    <span class="c1"># adding of suite2p trial level as well in this function as well</span>
    <span class="n">total_frames</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">trial</span> <span class="ow">in</span> <span class="n">s2p_trials</span><span class="p">:</span>
        <span class="n">trialobj</span> <span class="o">=</span> <span class="n">expobj</span><span class="o">.</span><span class="n">load_trial</span><span class="p">(</span><span class="n">trialID</span><span class="o">=</span><span class="n">trial</span><span class="p">)</span>
        <span class="c1"># print(f'n_frames', expobj.Suite2p.n_frames)</span>
        <span class="n">trialobj</span><span class="o">.</span><span class="n">Suite2p</span> <span class="o">=</span> <span class="n">Suite2pResultsTrial</span><span class="p">(</span><span class="n">s2pExp</span><span class="o">=</span><span class="n">expobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="p">,</span> <span class="n">trial_frames</span><span class="o">=</span><span class="p">(</span>
            <span class="n">total_frames</span><span class="p">,</span> <span class="n">total_frames</span> <span class="o">+</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">n_frames</span><span class="p">))</span>  <span class="c1"># use trial obj's current trial key_frames</span>
        <span class="n">trialobj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="n">total_frames</span> <span class="o">+=</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">n_frames</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'|- Finished adding suite2p module to experiment and trials. Located under .Suite2p'</span><span class="p">)</span>
    <span class="n">expobj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span></div>
</pre></div>
<div class="clearer"></div>
</div>
</div>
</div>
<div aria-label="main navigation" class="sphinxsidebar" role="navigation">
<div class="sphinxsidebarwrapper">
<p class="logo"><a href="../../../index.html">
<img alt="Logo" class="logo" src="../../../_static/imagingplus-logo.png"/>
</a></p>
<div id="searchbox" role="search" style="display: none">
<h3 id="searchlabel">Quick search</h3>
<div class="searchformwrapper">
<form action="../../../search.html" class="search" method="get">
<input aria-labelledby="searchlabel" autocapitalize="off" autocomplete="off" autocorrect="off" name="q" spellcheck="false" type="text"/>
<input type="submit" value="Go"/>
</form>
</div>
</div>
<script>$('#searchbox').show(0);</script>
</div>
</div>
<div class="clearer"></div>
</div>
<div aria-label="related navigation" class="related" role="navigation">
<h3>Navigation</h3>
<ul>
<li class="right" style="margin-right: 10px">
<a href="../../../genindex.html" title="General Index">index</a></li>
<li class="right">
<a href="../../../py-modindex.html" title="Python Module Index">modules</a> |</li>
<li class="nav-item nav-item-0"><a href="../../../index.html">imaging+ 0.2-beta documentation</a> »</li>
<li class="nav-item nav-item-1"><a href="../../index.html">Module code</a> »</li>
<li class="nav-item nav-item-this"><a href="">imagingplus.processing.suite2p</a></li>
</ul>
</div>
<div class="footer" role="contentinfo">
        © Copyright 2022, Packer Lab.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
    </div>
</body>
</html>