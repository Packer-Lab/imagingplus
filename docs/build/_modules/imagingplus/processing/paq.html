
<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>imagingplus.processing.paq — imaging+ 0.2-beta documentation</title>
<link href="../../../_static/pygments.css" rel="stylesheet" type="text/css"/>
<link href="../../../_static/sphinxdoc.css" rel="stylesheet" type="text/css"/>
<link href="../../../_static/sg_gallery.css" rel="stylesheet" type="text/css"/>
<script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
<script src="../../../_static/jquery.js"></script>
<script src="../../../_static/underscore.js"></script>
<script src="../../../_static/doctools.js"></script>
<script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
<link href="../../../genindex.html" rel="index" title="Index"/>
<link href="../../../search.html" rel="search" title="Search"/>
</head><body>
<div aria-label="related navigation" class="related" role="navigation">
<h3>Navigation</h3>
<ul>
<li class="right" style="margin-right: 10px">
<a accesskey="I" href="../../../genindex.html" title="General Index">index</a></li>
<li class="right">
<a href="../../../py-modindex.html" title="Python Module Index">modules</a> |</li>
<li class="nav-item nav-item-0"><a href="../../../index.html">imaging+ 0.2-beta documentation</a> »</li>
<li class="nav-item nav-item-1"><a accesskey="U" href="../../index.html">Module code</a> »</li>
<li class="nav-item nav-item-this"><a href="">imagingplus.processing.paq</a></li>
</ul>
</div>
<div class="document">
<div class="documentwrapper">
<div class="bodywrapper">
<div class="body" role="main">
<h1>Source code for imagingplus.processing.paq</h1><div class="highlight"><pre>
<span></span><span class="c1"># new copy of processing/paq.py to use for experimenting with and creating paq as child of temporal cellsdata.</span>

<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">mticker</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">imagingplus.main.subcore</span> <span class="kn">import</span> <span class="n">TemporalData</span>
<span class="kn">from</span> <span class="nn">imagingplus.utils.utils</span> <span class="kn">import</span> <span class="n">threshold_detect</span>


<div class="viewcode-block" id="paq2py"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.paq.paq2py">[docs]</a><span class="k">def</span> <span class="nf">paq2py</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Read PAQ file (from PackIO) into python</span>
<span class="sd">    Lloyd Russell 2015. Minor update for numpy &gt;1.18 by Prajay Shah 2021.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ==========</span>
<span class="sd">    file_path : str, optional</span>
<span class="sd">        full path to file to read in. if none is supplied a load file dialog</span>
<span class="sd">        is opened, buggy on mac osx - Tk/matplotlib. Default: None.</span>
<span class="sd">    plot : bool, optional</span>
<span class="sd">        plot the cellsdata after reading? Default: False.</span>
<span class="sd">    Returns</span>
<span class="sd">    =======</span>
<span class="sd">    cellsdata : ndarray</span>
<span class="sd">        the cellsdata as a m-by-n array where m is the number of channels and n is</span>
<span class="sd">        the number of datapoints</span>
<span class="sd">    chan_names : list of str</span>
<span class="sd">        the names of the channels provided in PackIO</span>
<span class="sd">    hw_chans : list of str</span>
<span class="sd">        the hardware lines corresponding to each channel</span>
<span class="sd">    units : list of str</span>
<span class="sd">        the units of measurement for each channel</span>
<span class="sd">    rate : int</span>
<span class="sd">        the acquisition sample rate, in Hz</span>
<span class="sd">    """</span>

    <span class="c1"># file load gui</span>
    <span class="k">if</span> <span class="n">file_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">Tkinter</span>
        <span class="kn">import</span> <span class="nn">tkFileDialog</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">Tkinter</span><span class="o">.</span><span class="n">Tk</span><span class="p">()</span>
        <span class="n">root</span><span class="o">.</span><span class="n">withdraw</span><span class="p">()</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">tkFileDialog</span><span class="o">.</span><span class="n">askopenfilename</span><span class="p">()</span>
        <span class="n">root</span><span class="o">.</span><span class="n">destroy</span><span class="p">()</span>

    <span class="c1"># open file</span>
    <span class="n">fid</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">'rb'</span><span class="p">)</span>

    <span class="c1"># get sample rate</span>
    <span class="n">rate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'&gt;f'</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># get number of channels</span>
    <span class="n">num_chans</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'&gt;f'</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="c1"># get channel names</span>
    <span class="n">chan_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_chans</span><span class="p">):</span>
        <span class="n">num_chars</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'&gt;f'</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">chan_name</span> <span class="o">=</span> <span class="s1">''</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_chars</span><span class="p">):</span>
            <span class="n">chan_name</span> <span class="o">=</span> <span class="n">chan_name</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'&gt;f'</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">chan_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">chan_name</span><span class="p">)</span>

    <span class="c1"># get channel hardware lines</span>
    <span class="n">hw_chans</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_chans</span><span class="p">):</span>
        <span class="n">num_chars</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'&gt;f'</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">hw_chan</span> <span class="o">=</span> <span class="s1">''</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_chars</span><span class="p">):</span>
            <span class="n">hw_chan</span> <span class="o">=</span> <span class="n">hw_chan</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'&gt;f'</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">hw_chans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hw_chan</span><span class="p">)</span>

    <span class="c1"># get acquisition units</span>
    <span class="n">units</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_chans</span><span class="p">):</span>
        <span class="n">num_chars</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'&gt;f'</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="s1">''</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_chars</span><span class="p">):</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="n">unit</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'&gt;f'</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">units</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>

    <span class="c1"># get cellsdata</span>
    <span class="n">temp_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fromfile</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'&gt;f'</span><span class="p">,</span> <span class="n">count</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">num_datapoints</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temp_data</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_chans</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">temp_data</span><span class="p">,</span> <span class="p">[</span><span class="n">num_datapoints</span><span class="p">,</span> <span class="n">num_chans</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>

    <span class="c1"># close file</span>
    <span class="n">fid</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># plot</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="c1"># import matplotlib</span>
        <span class="c1"># matplotlib.use('QT4Agg')</span>
        <span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="k">as</span> <span class="nn">plt</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">num_chans</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="n">num_chans</span> <span class="o">*</span> <span class="mi">5</span><span class="p">),</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_datapoints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="c1"># ax.set_ylabel(units[idx])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">chan_names</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

            <span class="c1"># -- Prajay edit</span>
            <span class="c1"># change x axis ticks to seconds</span>
            <span class="n">label_format</span> <span class="o">=</span> <span class="s1">'</span><span class="si">{:,.0f}</span><span class="s1">'</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xticks</span><span class="p">()]</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
                <span class="n">labels</span><span class="p">[</span><span class="n">labels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">item</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">item</span> <span class="o">/</span> <span class="n">rate</span><span class="p">))</span>
            <span class="n">ticks_loc</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xticks</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">mticker</span><span class="o">.</span><span class="n">FixedLocator</span><span class="p">(</span><span class="n">ticks_loc</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="n">label_format</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Time (secs)'</span><span class="p">)</span>
            <span class="c1"># --</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># make pandas cellsdata frame using cellsdata in channels</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">chan_names</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">"cellsdata"</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
            <span class="s2">"chan_names"</span><span class="p">:</span> <span class="n">chan_names</span><span class="p">,</span>
            <span class="s2">"hw_chans"</span><span class="p">:</span> <span class="n">hw_chans</span><span class="p">,</span>
            <span class="s2">"units"</span><span class="p">:</span> <span class="n">units</span><span class="p">,</span>
            <span class="s2">"rate"</span><span class="p">:</span> <span class="n">rate</span><span class="p">,</span>
            <span class="s2">"num_datapoints"</span><span class="p">:</span> <span class="n">num_datapoints</span><span class="p">},</span> <span class="n">df</span></div>


<span class="c1"># noinspection DuplicatedCode</span>
<div class="viewcode-block" id="PaqData"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.paq.PaqData">[docs]</a><span class="k">class</span> <span class="nc">PaqData</span><span class="p">(</span><span class="n">TemporalData</span><span class="p">):</span>
    <span class="sd">"""access and storage of cellsdata from .paq files."""</span>

<div class="viewcode-block" id="PaqData.__init__"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.paq.PaqData.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">\- ADDING PAQ DATA from </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">... "</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparse_paq_data</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1">#: array of paq cellsdata that corresponds to</span>

        <span class="k">if</span> <span class="s1">'channels'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="s1">'sampling_rate'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="s1">'paq_data'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">paq_data</span><span class="p">,</span> <span class="n">paq_rate</span><span class="p">,</span> <span class="n">channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paq_read</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">paq_data</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'paq_data'</span><span class="p">]</span>
            <span class="n">channels</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'channels'</span><span class="p">]</span>
            <span class="n">paq_rate</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'sampling_rate'</span><span class="p">]</span>

        <span class="c1"># # todo switch this out in favour of the pandas dataframes below:</span>
        <span class="c1"># for chan_name in channels:</span>
        <span class="c1">#     chan_name_idx = channels.index(chan_name)</span>
        <span class="c1">#     print(f"\t- adding '{chan_name}' channel cellsdata as attribute")</span>
        <span class="c1">#     setattr(self, chan_name, paq_data['cellsdata'][chan_name_idx])</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">paq_data</span><span class="p">[</span><span class="s1">'cellsdata'</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="n">paq_data</span><span class="p">[</span><span class="s1">'cellsdata'</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PaqData</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="o">=</span><span class="n">paq_rate</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># init attr's</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stim_start_times</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1">#: paq clock time of photostimulation trial start</span></div>



<div class="viewcode-block" id="PaqData.import_paqdata"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.paq.PaqData.import_paqdata">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">import_paqdata</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">frame_times_channel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Alternative constructor for PaqData. This is the preferred method for loading in paqdata.</span>

<span class="sd">        :param file_path: path to .paq file</span>
<span class="sd">        :param frame_times_channel: channel to retrieve frame clock times from</span>
<span class="sd">        :param plot: whether to plot output of reading .paq file</span>
<span class="sd">        :return: PaqData object, and raw cellsdata from .paq file in numpy array</span>

<span class="sd">        todo add example in docstring</span>
<span class="sd">        """</span>
        <span class="n">paq_data</span><span class="p">,</span> <span class="n">paq_rate</span><span class="p">,</span> <span class="n">channels</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">paq_read</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">)</span>

        <span class="n">paqData_obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span> <span class="n">sampling_rate</span><span class="o">=</span><span class="n">paq_rate</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">frame_times_channel</span><span class="p">:</span>
            <span class="n">paqData_obj</span><span class="o">.</span><span class="n">getPaqFrameTimes</span><span class="p">(</span><span class="n">frame_times_channel</span><span class="o">=</span><span class="n">frame_times_channel</span><span class="p">)</span>
            <span class="n">paqData_obj</span><span class="o">.</span><span class="n">sparse_paq_data</span> <span class="o">=</span> <span class="n">paqData_obj</span><span class="o">.</span><span class="n">get_sparse_data</span><span class="p">(</span><span class="n">frame_times</span><span class="o">=</span><span class="n">paqData_obj</span><span class="o">.</span><span class="n">frame_times</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">paqData_obj</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">information</span> <span class="o">=</span> <span class="s2">""</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="n">information</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"</span><span class="se">\n\t</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">information</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">"</span><span class="se">\n\t</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="p">[</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="si">}</span><span class="s2">"</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">"imagingplus.processing.Paq.PaqData: </span><span class="si">{</span><span class="n">information</span><span class="si">}</span><span class="s2">"</span>

<div class="viewcode-block" id="PaqData.paq_read"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.paq.PaqData.paq_read">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">paq_read</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Loads .Paq file and saves cellsdata from individual channels.</span>

<span class="sd">        :param file_path: path to the .Paq file for this cellsdata object</span>
<span class="sd">        :param plot: (optional) whether to plot</span>
<span class="sd">        """</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">),</span> <span class="sa">f</span><span class="s1">'File path not found </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s1">'</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="se">\t</span><span class="s1">loading Paq cellsdata from: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="n">paq</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">paq2py</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">)</span>
        <span class="n">paq_rate</span> <span class="o">=</span> <span class="n">paq</span><span class="p">[</span><span class="s1">'rate'</span><span class="p">]</span>
        <span class="n">channels</span> <span class="o">=</span> <span class="n">paq</span><span class="p">[</span><span class="s1">'chan_names'</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t</span><span class="s2"> - loaded </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">paq</span><span class="p">[</span><span class="s1">'chan_names'</span><span class="p">])</span><span class="si">}</span><span class="s2"> channels from .Paq file: </span><span class="si">{</span><span class="n">paq</span><span class="p">[</span><span class="s1">'chan_names'</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">paq</span><span class="p">,</span> <span class="n">paq_rate</span><span class="p">,</span> <span class="n">channels</span></div>

<div class="viewcode-block" id="PaqData.storePaqChannel"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.paq.PaqData.storePaqChannel">[docs]</a>    <span class="k">def</span> <span class="nf">storePaqChannel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chan_name</span><span class="p">):</span>
        <span class="sd">"""add a specific channel's (`chan_name`) cellsdata from the .paq file as attribute of the same name for</span>
<span class="sd">        PaqData object.</span>

<span class="sd">        :param chan_name: name of paq channel to add.</span>
<span class="sd">        """</span>

        <span class="n">paq_data</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">channels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">paq_read</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="p">)</span>
        <span class="n">chan_name_idx</span> <span class="o">=</span> <span class="n">channels</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">chan_name</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t</span><span class="s2">|- adding '</span><span class="si">{</span><span class="n">chan_name</span><span class="si">}</span><span class="s2">' channel cellsdata as attribute"</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chan_name</span><span class="p">,</span> <span class="n">paq_data</span><span class="p">[</span><span class="s1">'cellsdata'</span><span class="p">][</span><span class="n">chan_name_idx</span><span class="p">])</span></div>

    <span class="c1">## refactor these methods to their respective Trial code locations</span>
<div class="viewcode-block" id="PaqData.getPaqFrameTimes"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.paq.PaqData.getPaqFrameTimes">[docs]</a>    <span class="k">def</span> <span class="nf">getPaqFrameTimes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_times_channel</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Retrieve two-photon imaging frame times from .paq signal found in frame_times_channel.</span>

<span class="sd">        :param paq_data: cellsdata loaded from .paq file (use .paq_read method)</span>
<span class="sd">        :param frame_times_channel: channel to retrieve frame clock times from</span>
<span class="sd">        :return: numpy array of frame clock times</span>
<span class="sd">        """</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n\t</span><span class="s2">\- Retrieving two-photon imaging frame times from .paq channel: </span><span class="si">{</span><span class="n">frame_times_channel</span><span class="si">}</span><span class="s2"> ... "</span><span class="p">)</span>

        <span class="c1"># if frame_times_channel not in paq_data['chan_names']:</span>
        <span class="k">if</span> <span class="n">frame_times_channel</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">channels</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">frame_times_channel</span><span class="si">}</span><span class="s1"> not found in .Paq channels. Specify channel containing frame signals.'</span><span class="p">)</span>

        <span class="c1"># find frame times</span>
        <span class="n">clock_voltage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">frame_times_channel</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="n">__frame_clock</span> <span class="o">=</span> <span class="n">threshold_detect</span><span class="p">(</span><span class="n">clock_voltage</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">__frame_clock</span> <span class="o">=</span> <span class="n">__frame_clock</span>

        <span class="c1"># find start and stop __frame_clock times -- there might be multiple 2p imaging starts/stops in the Paq trial (hence multiple frame start and end times)</span>
        <span class="n">frame_start_times</span> <span class="o">=</span> <span class="p">[</span><span class="n">__frame_clock</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>  <span class="c1"># initialize list</span>
        <span class="n">frame_end_times</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame_start_times</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">__frame_clock</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">__frame_clock</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">__frame_clock</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">2e3</span><span class="p">:</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">frame_end_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">__frame_clock</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
                <span class="n">frame_start_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">__frame_clock</span><span class="p">[</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">frame_end_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">__frame_clock</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># handling cases where 2p imaging clock has been started/stopped &gt;1 in the Paq trial</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frame_start_times</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="p">[</span><span class="n">frame_end_times</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">frame_start_times</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span>
                    <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">frame_start_times</span><span class="p">))]</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">diff</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">diff</span><span class="p">))</span>
            <span class="n">frame_start_time_actual</span> <span class="o">=</span> <span class="n">frame_start_times</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">frame_end_time_actual</span> <span class="o">=</span> <span class="n">frame_end_times</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">frame_clock_actual</span> <span class="o">=</span> <span class="p">[</span><span class="n">frame</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">__frame_clock</span> <span class="k">if</span>
                                  <span class="n">frame_start_time_actual</span> <span class="o">&lt;=</span> <span class="n">frame</span> <span class="o">&lt;=</span> <span class="n">frame_end_time_actual</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">frame_start_time_actual</span> <span class="o">=</span> <span class="n">frame_start_times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">frame_end_time_actual</span> <span class="o">=</span> <span class="n">frame_end_times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">frame_clock_actual</span> <span class="o">=</span> <span class="n">__frame_clock</span>

        <span class="k">return</span> <span class="n">frame_clock_actual</span></div>

<div class="viewcode-block" id="PaqData.plot__paq_channel"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.paq.PaqData.plot__paq_channel">[docs]</a>    <span class="k">def</span> <span class="nf">plot__paq_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">"""temp placeholder incase you need specific plotting code compared to plotting with the general temporal cellsdata function"""</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="PaqData.paqProcessingTwoPhotonImaging"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.paq.PaqData.paqProcessingTwoPhotonImaging">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">paqProcessingTwoPhotonImaging</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">paq_path</span><span class="p">,</span> <span class="n">frame_channel</span><span class="p">,</span> <span class="n">plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Alternative constructor for paq module for working with two photon imaging trials.</span>

<span class="sd">        :param paq_path: path to .paq file</span>
<span class="sd">        :param frame_channel: channel to use for measuring frame times from .paq cellsdata</span>
<span class="sd">        :param plot: if True, then plot loaded .paq file.</span>

<span class="sd">        :return: PAQ cellsdata object</span>
<span class="sd">        """</span>

        <span class="n">paq_data_obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">import_paqdata</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="n">paq_path</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">frame_channel</span> <span class="ow">in</span> <span class="n">paq_data_obj</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"frame_channel argument: '</span><span class="si">{</span><span class="n">frame_channel</span><span class="si">}</span><span class="s2">', not found in channels in .paq cellsdata."</span>
        <span class="n">paq_data_obj</span><span class="o">.</span><span class="n">frame_times</span> <span class="o">=</span> <span class="n">paq_data_obj</span><span class="o">.</span><span class="n">getPaqFrameTimes</span><span class="p">(</span><span class="n">frame_times_channel</span><span class="o">=</span><span class="n">frame_channel</span><span class="p">)</span>
        <span class="n">paq_data_obj</span><span class="o">.</span><span class="n">sparse_paq_data</span> <span class="o">=</span> <span class="n">paq_data_obj</span><span class="o">.</span><span class="n">get_sparse_data</span><span class="p">(</span><span class="n">frame_times</span><span class="o">=</span><span class="n">paq_data_obj</span><span class="o">.</span><span class="n">frame_times</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">paq_data_obj</span></div>

<div class="viewcode-block" id="PaqData.paqProcessingAllOptical"><a class="viewcode-back" href="../../../reference.html#imagingplus.processing.paq.PaqData.paqProcessingAllOptical">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">paqProcessingAllOptical</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">paq_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stim_channel</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">frame_channel</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">plot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Alternative constructor for paq module for working with all optical trials.</span>

<span class="sd">        :param paq_path: path to .paq file</span>
<span class="sd">        :param stim_channel: channel to use for photostimulation timing start.</span>
<span class="sd">        :param frame_channel: channel to use for measuring frame times from .paq cellsdata</span>
<span class="sd">        :param plot: if True, plot loaded .paq file.</span>

<span class="sd">        :return: PAQ cellsdata object</span>
<span class="sd">        """</span>

        <span class="n">paq_data_obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">paqProcessingTwoPhotonImaging</span><span class="p">(</span><span class="n">paq_path</span><span class="o">=</span><span class="n">paq_path</span><span class="p">,</span> <span class="n">frame_channel</span><span class="o">=</span><span class="n">frame_channel</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="n">plot</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">stim_channel</span> <span class="ow">in</span> <span class="n">paq_data_obj</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span> <span class="sa">f</span><span class="s2">"stim_channel argument: '</span><span class="si">{</span><span class="n">stim_channel</span><span class="si">}</span><span class="s2">', not found in channels in .paq cellsdata."</span>

        <span class="c1"># find stim times</span>
        <span class="n">stim_volts</span> <span class="o">=</span> <span class="n">paq_data_obj</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">stim_channel</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">stim_start_times</span> <span class="o">=</span> <span class="n">threshold_detect</span><span class="p">(</span><span class="n">stim_volts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">'# of stims found on </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">stim_channel</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">stim_start_times</span><span class="p">)))</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stim_volts</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">stim_start_times</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stim_start_times</span><span class="p">)),</span> <span class="s1">'.'</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">'detected photostim start times from </span><span class="si">{</span><span class="n">stim_channel</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">f</span><span class="s1">'paq clock (sampled at </span><span class="si">{</span><span class="n">paq_data_obj</span><span class="o">.</span><span class="n">sampling_rate</span><span class="si">}</span><span class="s1"> Hz)'</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">stim_channel</span><span class="si">}</span><span class="s2"> volt"</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="n">stim_starts_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">time</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">paq_data_obj</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">stim_channel</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">stim_start_times</span><span class="p">:</span>
                <span class="n">stim_starts_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">stim_starts_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">paq_data_obj</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">'stim_start_times'</span><span class="p">]</span> <span class="o">=</span> <span class="n">stim_starts_</span>

        <span class="k">return</span> <span class="n">paq_data_obj</span></div></div>


    <span class="c1"># # TODO review code</span>
    <span class="c1"># def _1p_stims(self, paq_data, plot: bool = False, optoloopback_channel: str = 'opto_loopback'):</span>
    <span class="c1">#     "find 1p stim times"</span>
    <span class="c1">#     if optoloopback_channel not in paq_data['chan_names']:</span>
    <span class="c1">#         raise KeyError(</span>
    <span class="c1">#             f'{optoloopback_channel} not found in .Paq channels. Specify channel containing 1p stim TTL loopback signals.')</span>
    <span class="c1">#</span>
    <span class="c1">#     opto_loopback_chan = paq_data['chan_names'].index('opto_loopback')</span>
    <span class="c1">#     stim_volts = paq_data['cellsdata'][opto_loopback_chan, :]</span>
    <span class="c1">#     stim_times = threshold_detect(stim_volts, 1)</span>
    <span class="c1">#</span>
    <span class="c1">#     self.stim_times = stim_times</span>
    <span class="c1">#     self.stim_start_times = [self.stim_times[0]]  # initialize ls</span>
    <span class="c1">#     self.stim_end_times = []</span>
    <span class="c1">#     i = len(self.stim_start_times)</span>
    <span class="c1">#     for stim in self.stim_times[1:]:</span>
    <span class="c1">#         if (stim - self.stim_start_times[i - 1]) &gt; 1e5:</span>
    <span class="c1">#             i += 1</span>
    <span class="c1">#             self.stim_start_times.append(stim)</span>
    <span class="c1">#             self.stim_end_times.append(self.stim_times[np.where(self.stim_times == stim)[0] - 1][0])</span>
    <span class="c1">#     self.stim_end_times.append(self.stim_times[-1])</span>
    <span class="c1">#</span>
    <span class="c1">#     print("\nNumber of 1photon stims found: ", len(self.stim_start_times))</span>
    <span class="c1">#</span>
    <span class="c1">#     if plot:</span>
    <span class="c1">#         plt.figure(figsize=(50, 2))</span>
    <span class="c1">#         plt.plot(stim_volts)</span>
    <span class="c1">#         plt.plot(stim_times, np.ones(len(stim_times)), '.')</span>
    <span class="c1">#         plt.suptitle('1p stims from Paq, with detected 1p stim instances as scatter')</span>
    <span class="c1">#         plt.xlim([stim_times[0] - 2e3, stim_times[-1] + 2e3])</span>
    <span class="c1">#         plt.show()</span>
    <span class="c1">#</span>
    <span class="c1">#     # find all stim frames</span>
    <span class="c1">#     self.stim_frames = []</span>
    <span class="c1">#     for stim in range(len(self.stim_start_times)):</span>
    <span class="c1">#         stim_frames_ = [frame for frame, t in enumerate(self._frame_clock_actual) if</span>
    <span class="c1">#                         self.stim_start_times[stim] - 100 / self.paq_rate &lt;= t &lt;= self.stim_end_times[</span>
    <span class="c1">#                             stim] + 100 / self.paq_rate]</span>
    <span class="c1">#</span>
    <span class="c1">#         self.stim_frames.append(stim_frames_)</span>
    <span class="c1">#</span>
    <span class="c1">#     # if &gt;1 1p stims per trial, find the start of all 1p trials</span>
    <span class="c1">#     self.stim_start_frames = [stim_frames[0] for stim_frames in self.stim_frames if len(stim_frames) &gt; 0]</span>
    <span class="c1">#     self.stim_end_frames = [stim_frames[-1] for stim_frames in self.stim_frames if len(stim_frames) &gt; 0]</span>
    <span class="c1">#     self.stim_duration_frames = int(np.mean(</span>
    <span class="c1">#         [self.stim_end_frames[idx] - self.stim_start_frames[idx] for idx in range(len(self.stim_start_frames))]))</span>
    <span class="c1">#</span>
    <span class="c1">#     print(f"\nStim duration of 1photon stim: {self.stim_duration_frames} frames")</span>
    <span class="c1">#</span>
    <span class="c1"># def _shutter_times(self, paq_data, shutter_channel: str = 'shutter_loopback'):</span>
    <span class="c1">#     """find shutter loopback frames from .Paq cellsdata</span>
    <span class="c1">#     :param paq_data:</span>
    <span class="c1">#     :param shutter_channel:</span>
    <span class="c1">#     """</span>
    <span class="c1">#</span>
    <span class="c1">#     if shutter_channel not in paq_data['chan_names']:</span>
    <span class="c1">#         raise KeyError(f'{shutter_channel} not found in .Paq channels. Specify channel containing shutter signals.')</span>
    <span class="c1">#</span>
    <span class="c1">#     shutter_idx = paq_data['chan_names'].index('shutter_loopback')</span>
    <span class="c1">#     shutter_voltage = paq_data['cellsdata'][shutter_idx, :]</span>
    <span class="c1">#</span>
    <span class="c1">#     shutter_times = np.where(shutter_voltage &gt; 4)</span>
    <span class="c1">#     self.shutter_times = shutter_times[0]</span>
    <span class="c1">#     self.shutter_frames = []</span>
    <span class="c1">#     self.shutter_start_frames = []</span>
    <span class="c1">#     self.shutter_end_frames = []</span>
    <span class="c1">#</span>
    <span class="c1">#     shutter_frames_ = [frame for frame, t in enumerate(self.getPaqFrameTimes()) if</span>
    <span class="c1">#                        t in self.shutter_times]</span>
    <span class="c1">#     self.shutter_frames.append(shutter_frames_)</span>
    <span class="c1">#</span>
    <span class="c1">#     shutter_start_frames = [shutter_frames_[0]]</span>
    <span class="c1">#     shutter_end_frames = []</span>
    <span class="c1">#     i = len(shutter_start_frames)</span>
    <span class="c1">#     for frame in shutter_frames_[1:]:</span>
    <span class="c1">#         if (frame - shutter_start_frames[i - 1]) &gt; 5:</span>
    <span class="c1">#             i += 1</span>
    <span class="c1">#             shutter_start_frames.append(frame)</span>
    <span class="c1">#             shutter_end_frames.append(shutter_frames_[shutter_frames_.index(frame) - 1])</span>
    <span class="c1">#     shutter_end_frames.append(shutter_frames_[-1])</span>
    <span class="c1">#     self.shutter_start_frames.append(shutter_start_frames)</span>
    <span class="c1">#     self.shutter_end_frames.append(shutter_end_frames)</span>
    <span class="c1">#</span>
    <span class="c1"># def frames_discard(self, input_array, total_frames, discard_all=False):</span>
    <span class="c1">#     '''</span>
    <span class="c1">#     calculate which 2P imaging frames to discard (or use as bad frames input into suite2p) based on the bad frames</span>
    <span class="c1">#     identified by manually inspecting the Paq files in EphysViewer.m</span>
    <span class="c1">#</span>
    <span class="c1">#     :param input_array: .m file path to read that contains the timevalues for signal to remove</span>
    <span class="c1">#     :param total_frames: the number of frames in the TIFF file of the actual 2p imaging recording</span>
    <span class="c1">#     :param discard_all: bool; if True, then add all 2p imaging frames from this Paq file as bad frames to discard</span>
    <span class="c1">#     :return: array that contains the indices of bad frames (in format ready to input into suite2p processing)</span>
    <span class="c1">#     '''</span>
    <span class="c1">#</span>
    <span class="c1">#     frame_times = self.getPaqFrameTimes()</span>
    <span class="c1">#     frame_times = frame_times[</span>
    <span class="c1">#                   0:total_frames]  # this is necessary as there are more TTL triggers in the Paq file than actual frames (which are all at the end)</span>
    <span class="c1">#</span>
    <span class="c1">#     all_btwn_paired_frames = []</span>
    <span class="c1">#     paired_frames_first = []</span>
    <span class="c1">#     paired_frames_last = []</span>
    <span class="c1">#     if input_array is not None:</span>
    <span class="c1">#         print('\nadding seizure frames loaded up from: ', input_array)</span>
    <span class="c1">#         measurements = io.loadmat(input_array)</span>
    <span class="c1">#         for set_ in range(len(measurements['PairedMeasures'])):</span>
    <span class="c1">#             # calculate the sample value for begin and end of the set</span>
    <span class="c1">#             begin = int(measurements['PairedMeasures'][set_][3][0][0] * self.paq_rate)</span>
    <span class="c1">#             end = int(measurements['PairedMeasures'][set_][5][0][0] * self.paq_rate)</span>
    <span class="c1">#             frames_ = list(np.where(np.logical_and(frame_times &gt;= begin, frame_times &lt;= end))[0])</span>
    <span class="c1">#             if len(frames_) &gt; 0:</span>
    <span class="c1">#                 all_btwn_paired_frames.append(frames_)</span>
    <span class="c1">#                 paired_frames_first.append(frames_[0])</span>
    <span class="c1">#                 paired_frames_last.append(frames_[-1])</span>
    <span class="c1">#</span>
    <span class="c1">#         all_btwn_paired_frames = [item for x in all_btwn_paired_frames for item in x]</span>
    <span class="c1">#</span>
    <span class="c1">#     if discard_all and input_array is None:</span>
    <span class="c1">#         frames_to_discard = list(range(len(frame_times)))</span>
    <span class="c1">#         return frames_to_discard</span>
    <span class="c1">#     elif not discard_all and input_array is not None:</span>
    <span class="c1">#         frames_to_discard = all_btwn_paired_frames</span>
    <span class="c1">#         return frames_to_discard, all_btwn_paired_frames, paired_frames_first, paired_frames_last</span>
    <span class="c1">#     elif discard_all and input_array is not None:</span>
    <span class="c1">#         frames_to_discard = list(range(len(frame_times)))</span>
    <span class="c1">#         return frames_to_discard, all_btwn_paired_frames, paired_frames_first, paired_frames_last</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         raise ReferenceError('something wrong....No frames selected for discarding')</span>
    <span class="c1">#</span>
    <span class="c1"># ## refactor these methods to their respective Trial code locations // END</span>
</pre></div>
<div class="clearer"></div>
</div>
</div>
</div>
<div aria-label="main navigation" class="sphinxsidebar" role="navigation">
<div class="sphinxsidebarwrapper">
<p class="logo"><a href="../../../index.html">
<img alt="Logo" class="logo" src="../../../_static/imagingplus-logo.png"/>
</a></p>
<div id="searchbox" role="search" style="display: none">
<h3 id="searchlabel">Quick search</h3>
<div class="searchformwrapper">
<form action="../../../search.html" class="search" method="get">
<input aria-labelledby="searchlabel" autocapitalize="off" autocomplete="off" autocorrect="off" name="q" spellcheck="false" type="text"/>
<input type="submit" value="Go"/>
</form>
</div>
</div>
<script>$('#searchbox').show(0);</script>
</div>
</div>
<div class="clearer"></div>
</div>
<div aria-label="related navigation" class="related" role="navigation">
<h3>Navigation</h3>
<ul>
<li class="right" style="margin-right: 10px">
<a href="../../../genindex.html" title="General Index">index</a></li>
<li class="right">
<a href="../../../py-modindex.html" title="Python Module Index">modules</a> |</li>
<li class="nav-item nav-item-0"><a href="../../../index.html">imaging+ 0.2-beta documentation</a> »</li>
<li class="nav-item nav-item-1"><a href="../../index.html">Module code</a> »</li>
<li class="nav-item nav-item-this"><a href="">imagingplus.processing.paq</a></li>
</ul>
</div>
<div class="footer" role="contentinfo">
        © Copyright 2022, Packer Lab.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
    </div>
</body>
</html>