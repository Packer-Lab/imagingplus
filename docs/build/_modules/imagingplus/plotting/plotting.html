
<!DOCTYPE html>

<html>
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>imagingplus.plotting.plotting — imaging+ 0.2-beta documentation</title>
<link href="../../../_static/pygments.css" rel="stylesheet" type="text/css"/>
<link href="../../../_static/sphinxdoc.css" rel="stylesheet" type="text/css"/>
<link href="../../../_static/sg_gallery.css" rel="stylesheet" type="text/css"/>
<script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
<script src="../../../_static/jquery.js"></script>
<script src="../../../_static/underscore.js"></script>
<script src="../../../_static/doctools.js"></script>
<script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
<link href="../../../genindex.html" rel="index" title="Index"/>
<link href="../../../search.html" rel="search" title="Search"/>
</head><body>
<div aria-label="related navigation" class="related" role="navigation">
<h3>Navigation</h3>
<ul>
<li class="right" style="margin-right: 10px">
<a accesskey="I" href="../../../genindex.html" title="General Index">index</a></li>
<li class="right">
<a href="../../../py-modindex.html" title="Python Module Index">modules</a> |</li>
<li class="nav-item nav-item-0"><a href="../../../index.html">imaging+ 0.2-beta documentation</a> »</li>
<li class="nav-item nav-item-1"><a accesskey="U" href="../../index.html">Module code</a> »</li>
<li class="nav-item nav-item-this"><a href="">imagingplus.plotting.plotting</a></li>
</ul>
</div>
<div class="document">
<div class="documentwrapper">
<div class="bodywrapper">
<div class="body" role="main">
<h1>Source code for imagingplus.plotting.plotting</h1><div class="highlight"><pre>
<span></span><span class="c1"># library of convenience plotting funcs that are used for making various plots for all optical photostimulation/imaging experiments</span>

<span class="c1"># imports</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">mpl_point_clicker</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">tifffile</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">imagingplus.workflows.TwoPhotonImaging</span> <span class="kn">import</span> <span class="n">TwoPhotonImaging</span>

<span class="kn">from</span> <span class="nn">imagingplus</span> <span class="kn">import</span> <span class="n">Experiment</span>
<span class="kn">from</span> <span class="nn">imagingplus.main.subcore</span> <span class="kn">import</span> <span class="n">TemporalData</span>
<span class="kn">from</span> <span class="nn">imagingplus.utils.utils</span> <span class="kn">import</span> <span class="n">save_to_csv</span>
<span class="kn">from</span> <span class="nn">imagingplus.utils.images</span> <span class="kn">import</span> <span class="n">ImportTiff</span>

<span class="kn">from</span> <span class="nn">imagingplus.workflows.AllOptical</span> <span class="kn">import</span> <span class="n">AllOpticalTrial</span>

<span class="kn">from</span> <span class="nn">imagingplus.plotting._utils</span> <span class="kn">import</span> <span class="n">plotting_decorator</span><span class="p">,</span> <span class="n">make_random_color_array</span><span class="p">,</span> <span class="n">_add_scalebar</span><span class="p">,</span> \
    <span class="n">image_frame_options</span><span class="p">,</span> <span class="n">dataplot_frame_options</span><span class="p">,</span> <span class="n">dataplot_ax_options</span><span class="p">,</span> <span class="n">plot_coordinates</span><span class="p">,</span> <span class="n">heatmap_options</span><span class="p">,</span> <span class="n">image_frame_ops</span>
<span class="kn">from</span> <span class="nn">imagingplus.utils.classes</span> <span class="kn">import</span> <span class="n">ObjectClassError</span>


<span class="c1"># DATA ANALYSIS PLOTTING FUNCS</span>

<div class="viewcode-block" id="plotImg"><a class="viewcode-back" href="../../../reference.html#imagingplus.plotting.plotting.plotImg">[docs]</a><span class="nd">@plotting_decorator</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">plotImg</span><span class="p">(</span><span class="n">img</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">"""Plot image in grayscale.</span>
<span class="sd">    </span>
<span class="sd">    :param img: input image to show</span>
<span class="sd">    :param kwargs:</span>
<span class="sd">        :trialobj: ImagingTrial or SingleImage; object associated with input image.</span>
<span class="sd">        :scalebar_um: int; size of scalebar to plot on image (in um); must provide trialobj parameter.</span>
<span class="sd">    """</span>
    <span class="k">assert</span> <span class="n">img</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">'img to plot must only have 2 dimensions.'</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'fig'</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'ax'</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">'scalebar_um'</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">'trialobj'</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">_add_scalebar</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'must provide trialobj parameter to make scalebar.'</span><span class="p">)</span></div>


<span class="c1"># suite2p cellsdata</span>
<span class="c1"># simple plot of the location of the given cell(s) against a black FOV</span>
<div class="viewcode-block" id="plotRoiLocations"><a class="viewcode-back" href="../../../reference.html#imagingplus.plotting.plotting.plotRoiLocations">[docs]</a><span class="nd">@mpl</span><span class="o">.</span><span class="n">rc_context</span><span class="p">(</span><span class="n">image_frame_ops</span><span class="p">)</span>
<span class="nd">@plotting_decorator</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">plotRoiLocations</span><span class="p">(</span><span class="n">trialobj</span><span class="p">:</span> <span class="n">TwoPhotonImaging</span><span class="p">,</span> <span class="n">suite2p_rois</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'all'</span><span class="p">,</span>
                     <span class="n">background</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    plots an image of the FOV to show the locations of cells given in cells ls.</span>

<span class="sd">    :param trialobj: alloptical or 2p imaging object</span>
<span class="sd">    :param background: either 2dim numpy array to use as the backsplash or None (default; which is a black background)</span>
<span class="sd">    :param suite2p_rois: list of ROIs (suite2p cell IDs) to show coord location, default is 'all' (which is all ROIs)</span>
<span class="sd">    :param edgecolor: specify edgecolor of the scatter plot for cells</span>
<span class="sd">    :param facecolor: specify facecolor of the scatter plot for cells</span>
<span class="sd">    :param cells: list of cells to plot</span>
<span class="sd">    :param title: title for plot</span>
<span class="sd">    :param color_float_list: if given, it will be used to color the cells according a colormap</span>
<span class="sd">    :param cmap: cmap to be used in conjuction with the color_float_array argument</span>
<span class="sd">    :param show_s2p_targets: if True, then will prioritize coloring of cell points based on whether they were photostim targets</span>
<span class="sd">    :param invert_y: if True, invert the reverse the direction of the y axis</span>
<span class="sd">    :param fig: a matplotlib.Figure instance, if provided use this fig for plotting</span>
<span class="sd">    :param ax: a matplotlib.Axes.axes instance, if provided use this ax for plotting</span>
<span class="sd">    :param show: if False, do not display plot (used when the necessity is to return the fig and ax objects to futher manipulation)</span>
<span class="sd">    :returns fig, ax: returns fig and ax object, if show is False</span>
<span class="sd">    """</span>
    <span class="c1"># image_frame_options()</span>

    <span class="c1"># fig = kwargs['fig']</span>
    <span class="c1"># suptitle = kwargs['suptitle'] if 'suptitle' in kwargs else None</span>
    <span class="n">image_frame_options</span><span class="p">()</span> <span class="k">if</span> <span class="s1">'apply_image_frame_options'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">[</span>
        <span class="s1">'apply_image_frame_options'</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'ax'</span><span class="p">]</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'ax'</span><span class="p">)</span>

    <span class="n">facecolors</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'facecolors'</span><span class="p">]</span> <span class="k">if</span> <span class="s1">'facecolors'</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="s1">'none'</span>
    <span class="n">edgecolors</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'edgecolors'</span><span class="p">]</span> <span class="k">if</span> <span class="s1">'edgecolors'</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="s1">'orange'</span>

    <span class="k">if</span> <span class="n">suite2p_rois</span> <span class="o">==</span> <span class="s1">'all'</span><span class="p">:</span>
        <span class="n">suite2p_rois</span> <span class="o">=</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">cell_id</span>

    <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">suite2p_rois</span><span class="p">:</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">stat</span><span class="p">[</span><span class="n">trialobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">cell_id</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cell</span><span class="p">)][</span><span class="s1">'med'</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="n">edgecolors</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="n">facecolors</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">background</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">black</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">trialobj</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">frame_x</span><span class="p">,</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">frame_y</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'uint16'</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">black</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'Greys_r'</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">frame_x</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">frame_y</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">background</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'Greys_r'</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>

    <span class="n">_add_scalebar</span><span class="p">(</span><span class="n">trialobj</span><span class="o">=</span><span class="n">trialobj</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span> <span class="k">if</span> <span class="s1">'scalebar'</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'scalebar'</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">mpl</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">rcdefaults</span><span class="p">()</span></div>


<div class="viewcode-block" id="makeSuite2pPlots"><a class="viewcode-back" href="../../../reference.html#imagingplus.plotting.plotting.makeSuite2pPlots">[docs]</a><span class="nd">@mpl</span><span class="o">.</span><span class="n">rc_context</span><span class="p">(</span><span class="n">image_frame_ops</span><span class="p">)</span>
<span class="nd">@plotting_decorator</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">makeSuite2pPlots</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Experiment</span><span class="p">,</span> <span class="n">TwoPhotonImaging</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Makes four plots that are created by Suite2p output.</span>

<span class="sd">    credit: run_s2p tutorial on Mouseland/Suite2p on github</span>

<span class="sd">    :param obj: Experiment or Trial object to use for creating Suite2p plots.</span>
<span class="sd">    :param axs: a matplotlib.Axes.axes instance (4 cols x 1 rows), if provided use these axes for plotting</span>
<span class="sd">    :param show: if False, do not display plot (used when the necessity is to return the fig and ax objects to futher manipulation)</span>
<span class="sd">    :returns fig, axs: returns fig and ax object, if show is False</span>

<span class="sd">    """</span>

    <span class="n">heatmap_options</span><span class="p">()</span>

    <span class="n">axs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'axs'</span><span class="p">]</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'axs'</span><span class="p">)</span>

    <span class="c1"># f, axs = plt.subplots(figsize=[15, 5], nrows=1, ncols=4)</span>

    <span class="c1"># plt.subplot(1, 4, 1)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">output_ops</span><span class="p">[</span><span class="s1">'meanImgE'</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Registered Image, Mean Enhanced"</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># plt.subplot(1, 4, 2)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">im</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'jet'</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"All ROIs Found"</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># plt.subplot(1, 4, 3)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="o">~</span><span class="n">obj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">iscell</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'jet'</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"All Non-Cell ROIs"</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># plt.subplot(1, 4, 4)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">im</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">iscell</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'jet'</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"All Cell ROIs"</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">_add_scalebar</span><span class="p">(</span><span class="n">trialobj</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">if</span> <span class="s1">'scalebar'</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'scalebar'</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">mpl</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">rcdefaults</span><span class="p">()</span></div>


<div class="viewcode-block" id="plot_flu_trace"><a class="viewcode-back" href="../../../reference.html#imagingplus.plotting.plotting.plot_flu_trace">[docs]</a><span class="nd">@plotting_decorator</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">plot_flu_trace</span><span class="p">(</span><span class="n">trialobj</span><span class="p">:</span> <span class="n">TwoPhotonImaging</span><span class="p">,</span> <span class="n">cell</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">to_plot</span><span class="o">=</span><span class="s1">'raw'</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Plot individual cell's flu or dFF trace, with photostim. timings for that cell. Accesses the object's anndata data storage.</span>

<span class="sd">    :param trialobj: TwoPhotonImaging (or derived) object containing anndata data storage from which to select cell to plot flu trace</span>
<span class="sd">    :param cell: cell index number</span>
<span class="sd">    :param to_plot: select data layer to plot (choose 'raw' to plot main raw data layer, otherwise choose name of the desired layer)</span>
<span class="sd">    :param fig: a matplotlib.Figure instance, if provided use this fig for plotting</span>
<span class="sd">    :param ax: a matplotlib.Axes.axes instance, if provided use this ax for plotting</span>
<span class="sd">    :param show: if False, do not display plot (used when the necessity is to return the fig and ax objects to futher manipulation)</span>
<span class="sd">    :returns fig, ax: returns fig and ax object, if show is False</span>
<span class="sd">    """</span>
    <span class="n">dataplot_frame_options</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'ax'</span><span class="p">]</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'ax'</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'lw'</span><span class="p">,</span> <span class="s1">'linewidth'</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lw</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">lw</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">idx</span> <span class="o">=</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">Suite2p</span><span class="o">.</span><span class="n">cell_id</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">to_plot</span> <span class="o">==</span> <span class="s1">'raw'</span><span class="p">:</span>
        <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">X</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">to_plot</span> <span class="ow">in</span> <span class="p">[</span><span class="o">*</span><span class="n">trialobj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">layers</span><span class="p">]:</span>
            <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="n">to_plot</span><span class="p">][</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">"to_plot processed cellsdata is not found in trialobj.cellsdata.layers. "</span><span class="p">)</span>

    <span class="c1"># make the plot either as just the raw trace or as a dFF trace with the std threshold line drawn as well.</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">lw</span><span class="p">)</span>

    <span class="n">dataplot_ax_options</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">mpl</span><span class="o">.</span><span class="n">pyplot</span><span class="o">.</span><span class="n">rcdefaults</span><span class="p">()</span></div>


<div class="viewcode-block" id="plot__channel"><a class="viewcode-back" href="../../../reference.html#imagingplus.plotting.plotting.plot__channel">[docs]</a><span class="nd">@plotting_decorator</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">plot__channel</span><span class="p">(</span><span class="n">tmdata</span><span class="p">:</span> <span class="n">TemporalData</span><span class="p">,</span> <span class="n">channel</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Plot the saved signal from the specified channel from a PaqData submodule.</span>

<span class="sd">    :param tmdata: TemporalData object</span>
<span class="sd">    :param channel: channel to plot</span>
<span class="sd">    :param kwargs:</span>
<span class="sd">        :x_axis: str; x axis label, if 'time' or "Time" found in x_axis label, will convert x axis to time domain.</span>
<span class="sd">        :x_tick_secs: int; interval to plot x axis ticks</span>
<span class="sd">        :ax: matplotlib axis object to use for plotting.</span>
<span class="sd">    """</span>
    <span class="k">assert</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">tmdata</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s1"> not found in .Paq module cellsdata.'</span>

    <span class="c1"># set any kwargs provided</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'ax'</span><span class="p">]</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'ax'</span><span class="p">)</span>

    <span class="n">kwargs</span><span class="p">[</span><span class="s1">'x_tick_secs'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">120</span> <span class="k">if</span> <span class="s1">'x_tick_secs'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'x_tick_secs'</span><span class="p">]</span>

    <span class="n">lw</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="k">if</span> <span class="s1">'lw'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'lw'</span><span class="p">]</span>
    <span class="n">color</span> <span class="o">=</span> <span class="s1">'black'</span> <span class="k">if</span> <span class="s1">'color'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'color'</span><span class="p">]</span>

    <span class="c1"># collect cellsdata to plot</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">tmdata</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">channel</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="c1"># make plot</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="si">{</span><span class="n">channel</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'tmdata clock'</span><span class="p">)</span>

    <span class="c1"># set axis options</span>
    <span class="n">dataplot_ax_options</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">collection_hz</span><span class="o">=</span><span class="n">tmdata</span><span class="o">.</span><span class="n">sampling_rate</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">'ax'</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="MeanProject"><a class="viewcode-back" href="../../../reference.html#imagingplus.plotting.plotting.MeanProject">[docs]</a><span class="k">def</span> <span class="nf">MeanProject</span><span class="p">(</span><span class="n">tiff_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">frames</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">imstack</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Mean Projection function.</span>
<span class="sd">    Creates, plots and (optionally) saves a Mean Projection image of the loaded tiff. If frames are provided, tiff is cropped to those frames.</span>

<span class="sd">    Note: saves as 8-bit grayscale image.</span>

<span class="sd">    :param tiff_path: path to tiff file to load (if imstack not provided)</span>
<span class="sd">    :param save_path: path to save output image</span>
<span class="sd">    :param plot: if True, show the output image</span>
<span class="sd">    :param imstack: data stack to use as input (if tiff_path not provided)</span>
<span class="sd">    :param frames: crop input stack to specified frames before calculating mean projection.</span>
<span class="sd">    :param kwargs:</span>
<span class="sd">        :trialobj: ImagingTrial or SingleImage; object associated with input image.</span>
<span class="sd">        :scalebar_um: int; size of scalebar to plot on image (in um); must provide trialobj parameter.</span>
<span class="sd">    :return: mean projection image</span>

<span class="sd">    """</span>

    <span class="k">if</span> <span class="n">imstack</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tiff_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># read tiff</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="se">\t</span><span class="s1">\- Creating mean projection, from tiff: </span><span class="si">{</span><span class="n">tiff_path</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="n">im_stack</span> <span class="o">=</span> <span class="n">ImportTiff</span><span class="p">(</span><span class="n">tiff_path</span><span class="o">=</span><span class="n">tiff_path</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="n">frames</span><span class="p">)</span>

        <span class="c1"># if frames:</span>
        <span class="c1">#     im_stack = tf.imread(tiff_path, key=range(frames[0], frames[1]))</span>
        <span class="c1"># else:</span>
        <span class="c1">#     im_stack = tf.imread(tiff_path)</span>
    <span class="k">elif</span> <span class="n">imstack</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tiff_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">im_stack</span> <span class="o">=</span> <span class="n">imstack</span>
        <span class="k">assert</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">'can only project 3D image stacks (implicit dimensions are: Frames x Xpixels x Ypixels)'</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">'values provided for both tiff_path and imstack. Unclear where to source image cellsdata from. Provide only one please.'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">frames</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="se">\t</span><span class="s1"> collecting average image for frames: </span><span class="si">{</span><span class="n">frames</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="n">im_stack</span> <span class="o">=</span> <span class="n">im_stack</span><span class="p">[</span><span class="n">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">frames</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="se">\t</span><span class="s1">\- Averaging </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">im_stack</span><span class="p">)</span><span class="si">}</span><span class="s1"> total frames.'</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># convert to 8-bit</span>
    <span class="kn">from</span> <span class="nn">imagingplus.utils.images</span> <span class="kn">import</span> <span class="n">convert_to_8bit</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">convert_to_8bit</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">'.tif'</span> <span class="ow">in</span> <span class="n">save_path</span><span class="p">:</span>
            <span class="n">save_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'/'</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">'please provide full .tif path to save to. provided value was: </span><span class="si">{</span><span class="n">tiff_path</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t</span><span class="s2">\- Writing tiff to: </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">photometric</span><span class="o">=</span><span class="s1">'minisblack'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Mean Project'</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># just plot for now to make sure that you are doing things correctly so far</span>
        <span class="k">if</span> <span class="s1">'scalebar_um'</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'scalebar_um'</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">'trialobj'</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">_add_scalebar</span><span class="p">(</span><span class="n">trialobj</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">'trialobj'</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">img</span></div>


<div class="viewcode-block" id="MaxProject"><a class="viewcode-back" href="../../../reference.html#imagingplus.plotting.plotting.MaxProject">[docs]</a><span class="k">def</span> <span class="nf">MaxProject</span><span class="p">(</span><span class="n">tiff_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">frames</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="n">imstack</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Maximum projection function.</span>
<span class="sd">    Creates, plots and (optionally) saves an average image of the loaded tiff. If frames are provided, tiff is cropped to those frames.</span>

<span class="sd">    Note: saves as 8-bit grayscale image.</span>

<span class="sd">    :param tiff_path: path to tiff file to load (if imstack not provided)</span>
<span class="sd">    :param save_path: path to save output image</span>
<span class="sd">    :param plot: if True, show the output image</span>
<span class="sd">    :param imstack: data stack to use as input (if tiff_path not provided)</span>
<span class="sd">    :param frames: crop input stack to specified frames before calculating maximum projection.</span>
<span class="sd">    :param kwargs:</span>
<span class="sd">        :trialobj: ImagingTrial or SingleImage; object associated with input image.</span>
<span class="sd">        :scalebar_um: int; size of scalebar to plot on image (in um); must provide trialobj parameter.</span>
<span class="sd">    :return: maximum projection image</span>

<span class="sd">    """</span>

    <span class="k">if</span> <span class="n">imstack</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tiff_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># read tiff</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="se">\t</span><span class="s1">\- Creating max projection, from tiff: </span><span class="si">{</span><span class="n">tiff_path</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="n">im_stack</span> <span class="o">=</span> <span class="n">ImportTiff</span><span class="p">(</span><span class="n">tiff_path</span><span class="o">=</span><span class="n">tiff_path</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="n">frames</span><span class="p">)</span>

        <span class="c1"># if frames:</span>
        <span class="c1">#     im_stack = tf.imread(tiff_path, key=range(frames[0], frames[1]))</span>
        <span class="c1"># else:</span>
        <span class="c1">#     im_stack = tf.imread(tiff_path)</span>

    <span class="k">elif</span> <span class="n">imstack</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tiff_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">im_stack</span> <span class="o">=</span> <span class="n">imstack</span>
        <span class="k">assert</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">'can only project 3D image stacks (implicit dimensions are: Frames x Xpixels x Ypixels)'</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">'values provided for both tiff_path and imstack. Unclear where to source image cellsdata from. Provide only one please.'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">frames</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="se">\t</span><span class="s1"> collecting average image for frames: </span><span class="si">{</span><span class="n">frames</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="n">im_stack</span> <span class="o">=</span> <span class="n">im_stack</span><span class="p">[</span><span class="n">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">frames</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="se">\t</span><span class="s1">\- Max Project </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">im_stack</span><span class="p">)</span><span class="si">}</span><span class="s1"> total frames.'</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># convert to 8-bit</span>
    <span class="kn">from</span> <span class="nn">imagingplus.utils.images</span> <span class="kn">import</span> <span class="n">convert_to_8bit</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">convert_to_8bit</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">'.tif'</span> <span class="ow">in</span> <span class="n">save_path</span><span class="p">:</span>
            <span class="n">save_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'/'</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">'please provide full .tif path to save to. provided value was: </span><span class="si">{</span><span class="n">tiff_path</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t</span><span class="s2">\- Writing tiff to: </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">photometric</span><span class="o">=</span><span class="s1">'minisblack'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Max Project'</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># just plot for now to make sure that you are doing things correctly so far</span>
        <span class="k">if</span> <span class="s1">'scalebar'</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'scalebar'</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">'trialobj'</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">_add_scalebar</span><span class="p">(</span><span class="n">trialobj</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">'trialobj'</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">img</span></div>


<div class="viewcode-block" id="StdevProject"><a class="viewcode-back" href="../../../reference.html#imagingplus.plotting.plotting.StdevProject">[docs]</a><span class="k">def</span> <span class="nf">StdevProject</span><span class="p">(</span><span class="n">tiff_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">frames</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">imstack</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Creates, plots and (optionally) saves an average image of the loaded tiff. If frames are provided, tiff is cropped to those frames.</span>

<span class="sd">    Note: saves as 8-bit grayscale image.</span>

<span class="sd">    :param tiff_path: path to tiff file to load (if imstack not provided)</span>
<span class="sd">    :param imstack: data stack to use as input (if tiff_path not provided)</span>
<span class="sd">    :param frames: crop input stack to specified frames before calculating stdev projection.</span>
<span class="sd">    :param save_path: path to save output image</span>
<span class="sd">    :param plot: if True, show the output image</span>
<span class="sd">    :param kwargs:</span>
<span class="sd">        :trialobj: ImagingTrial or SingleImage; object associated with input image.</span>
<span class="sd">        :scalebar_um: int; size of scalebar to plot on image (in um); must provide trialobj parameter.</span>
<span class="sd">    :return: stdev projection image</span>

<span class="sd">    """</span>

    <span class="k">if</span> <span class="n">imstack</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tiff_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># read tiff</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="se">\t</span><span class="s1">\- Creating std projection, from tiff: </span><span class="si">{</span><span class="n">tiff_path</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="n">im_stack</span> <span class="o">=</span> <span class="n">ImportTiff</span><span class="p">(</span><span class="n">tiff_path</span><span class="o">=</span><span class="n">tiff_path</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="n">frames</span><span class="p">)</span>
        <span class="c1"># if frames:</span>
        <span class="c1">#     im_stack = tf.imread(tiff_path, key=range(frames[0], frames[1]))</span>
        <span class="c1"># else:</span>
        <span class="c1">#     im_stack = tf.imread(tiff_path)</span>
    <span class="k">elif</span> <span class="n">imstack</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tiff_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">im_stack</span> <span class="o">=</span> <span class="n">imstack</span>
        <span class="k">assert</span> <span class="n">im_stack</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">'can only project 3D image stacks (implicit dimensions are: Frames x Xpixels x Ypixels)'</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">'values provided for both tiff_path and imstack. Unclear where to source image cellsdata from. Provide only one please.'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">frames</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="se">\t</span><span class="s1"> collecting image for frames: </span><span class="si">{</span><span class="n">frames</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="n">im_stack</span> <span class="o">=</span> <span class="n">im_stack</span><span class="p">[</span><span class="n">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">frames</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="se">\t</span><span class="s1">\- Std Project </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">im_stack</span><span class="p">)</span><span class="si">}</span><span class="s1"> total frames.'</span><span class="p">)</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">im_stack</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># convert to 8-bit</span>
    <span class="kn">from</span> <span class="nn">imagingplus.utils.images</span> <span class="kn">import</span> <span class="n">convert_to_8bit</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">convert_to_8bit</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">'.tif'</span> <span class="ow">in</span> <span class="n">save_path</span><span class="p">:</span>
            <span class="n">save_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'/'</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">'please provide full .tif path to save to. provided value was: </span><span class="si">{</span><span class="n">tiff_path</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t</span><span class="s2">\- Writing tiff to: </span><span class="si">{</span><span class="n">save_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">imwrite</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">img</span><span class="p">,</span> <span class="n">photometric</span><span class="o">=</span><span class="s1">'minisblack'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s1">'Std Project'</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>  <span class="c1"># just plot for now to make sure that you are doing things correctly so far</span>
        <span class="k">if</span> <span class="s1">'scalebar'</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'scalebar'</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">'trialobj'</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">_add_scalebar</span><span class="p">(</span><span class="n">trialobj</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">'trialobj'</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">img</span></div>


<div class="viewcode-block" id="InspectTiff"><a class="viewcode-back" href="../../../reference.html#imagingplus.plotting.plotting.InspectTiff">[docs]</a><span class="k">def</span> <span class="nf">InspectTiff</span><span class="p">(</span><span class="n">tiff_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">frames</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">imstack</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Plot stdev, max and mean project of input image.</span>

<span class="sd">    :param tiff_path: path to tiff file to load (if imstack not provided)</span>
<span class="sd">    :param imstack: data stack to use as input (if tiff_path not provided)</span>
<span class="sd">    :param frames: crop input stack to specified frames before calculating stdev projection.</span>
<span class="sd">    :param kwargs:</span>
<span class="sd">        :trialobj: ImagingTrial or SingleImage; object associated with input image.</span>
<span class="sd">        :scalebar_um: int; size of scalebar to plot on image (in um); must provide trialobj parameter.</span>

<span class="sd">    """</span>
    <span class="k">if</span> <span class="n">imstack</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tiff_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># read tiff</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="se">\t</span><span class="s1">\- Creating projections from tiff: </span><span class="si">{</span><span class="n">tiff_path</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="se">\t</span><span class="s1">\- Collecting average image for frames: </span><span class="si">{</span><span class="n">frames</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="n">loaded</span> <span class="o">=</span> <span class="n">ImportTiff</span><span class="p">(</span><span class="n">tiff_path</span><span class="o">=</span><span class="n">tiff_path</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="n">frames</span><span class="p">)</span>

        <span class="c1"># if frames:</span>
        <span class="c1">#     loaded = tf.imread(tiff_path, key=range(frames[0], frames[1]))</span>
        <span class="c1"># else:</span>
        <span class="c1">#     loaded = tf.imread(tiff_path)</span>
    <span class="k">elif</span> <span class="n">imstack</span> <span class="ow">and</span> <span class="n">tiff_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">loaded</span> <span class="o">=</span> <span class="n">imstack</span>
        <span class="k">assert</span> <span class="n">loaded</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">'can only project 3D image stacks (implicit dimensions are: Frames x Xpixels x Ypixels)'</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">'values provided for both tiff_path and imstack. Unclear where to source image cellsdata from. Provide only one please.'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">frames</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">loaded</span><span class="p">[</span><span class="n">frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">frames</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">loaded</span>

    <span class="n">_</span> <span class="o">=</span> <span class="n">StdevProject</span><span class="p">(</span><span class="n">imstack</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">MaxProject</span><span class="p">(</span><span class="n">imstack</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">MeanProject</span><span class="p">(</span><span class="n">imstack</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="FrameAverage"><a class="viewcode-back" href="../../../reference.html#imagingplus.plotting.plotting.FrameAverage">[docs]</a><span class="k">def</span> <span class="nf">FrameAverage</span><span class="p">(</span><span class="n">key_frames</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">],</span> <span class="n">tiff_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">imstack</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">peri_frames</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">save_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="sd">"""</span>
<span class="sd">    Creates, plots and/or saves an average image of the specified number of peri-key_frames around the given frame from a multipage imaging TIFF file.</span>

<span class="sd">    :param tiff_path: path to tiff file to load (if imstack not provided)</span>
<span class="sd">    :param imstack: data stack to use as input (if tiff_path not provided)</span>
<span class="sd">    :param key_frames: key frames around which to create peri-frame averages</span>
<span class="sd">    :param peri_frames: number of frames around the key frame to calculate average from</span>
<span class="sd">    :param plot: if True, show the output image</span>
<span class="sd">    :param save_path: path to save output image</span>
<span class="sd">    :return: array of images</span>
<span class="sd">    """</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">Making peri-frame avg image...'</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">key_frames</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">key_frames</span> <span class="o">=</span> <span class="p">[</span><span class="n">key_frames</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">imstack</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tiff_path</span><span class="p">:</span>
        <span class="c1"># read tiff</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="se">\t</span><span class="s1">\- Creating avg img for frame: </span><span class="si">{</span><span class="n">key_frames</span><span class="si">}</span><span class="s1">, from tiff: </span><span class="si">{</span><span class="n">tiff_path</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
        <span class="n">frames_collect</span> <span class="o">=</span> <span class="p">((</span><span class="n">key_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">peri_frames</span> <span class="o">//</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="n">key_frames</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">peri_frames</span> <span class="o">//</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">im_stack</span> <span class="o">=</span> <span class="n">ImportTiff</span><span class="p">(</span><span class="n">tiff_path</span><span class="o">=</span><span class="n">tiff_path</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="n">frames_collect</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">imstack</span> <span class="ow">and</span> <span class="n">tiff_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">im_stack</span> <span class="o">=</span> <span class="n">imstack</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">'values provided for both tiff_path and imstack. Unclear where to source image cellsdata from. Provide only one please.'</span><span class="p">)</span>

    <span class="n">key_frames_adjusted</span> <span class="o">=</span> <span class="p">[</span><span class="n">frame</span> <span class="o">-</span> <span class="p">(</span><span class="n">key_frames</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">peri_frames</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span> <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">key_frames</span><span class="p">]</span>

    <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="n">key_frames_adjusted</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key_frames_adjusted</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">frame</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">im_stack</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">frame</span><span class="si">}</span><span class="s1"> not in range of loaded tiff.'</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">frame</span> <span class="o">&lt;</span> <span class="n">peri_frames</span> <span class="o">//</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">peri_frames_low</span> <span class="o">=</span> <span class="n">frame</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">peri_frames_low</span> <span class="o">=</span> <span class="n">peri_frames</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">peri_frames_high</span> <span class="o">=</span> <span class="n">peri_frames</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">im_sub</span> <span class="o">=</span> <span class="n">im_stack</span><span class="p">[</span><span class="n">frame</span> <span class="o">-</span> <span class="n">peri_frames_low</span><span class="p">:</span> <span class="n">frame</span> <span class="o">+</span> <span class="n">peri_frames_high</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">save_path</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">'.tif'</span> <span class="ow">in</span> <span class="n">save_path</span><span class="p">:</span>
                <span class="n">save_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'/'</span>
            <span class="n">save_path</span> <span class="o">=</span> <span class="n">save_path</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">'/</span><span class="si">{</span><span class="n">frame</span><span class="si">}</span><span class="s1">_frame_avg.tif'</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">save_path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t</span><span class="s2">\- Saving averaged tiff for frame: </span><span class="si">{</span><span class="n">frame</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">avg_sub</span> <span class="o">=</span> <span class="n">MeanProject</span><span class="p">(</span><span class="n">save_path</span><span class="o">=</span><span class="n">save_path</span><span class="p">,</span> <span class="n">imstack</span><span class="o">=</span><span class="n">im_sub</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">avg_sub</span> <span class="o">=</span> <span class="n">MeanProject</span><span class="p">(</span><span class="n">imstack</span><span class="o">=</span><span class="n">im_sub</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">peri_frames</span><span class="si">}</span><span class="s1"> peri-key_frames avg from frame </span><span class="si">{</span><span class="n">frame</span><span class="si">}</span><span class="s1">'</span> <span class="k">if</span> <span class="s1">'title'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="k">else</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span>
            <span class="nd">@plotting_decorator</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            <span class="k">def</span> <span class="nf">make_plot</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'fig'</span><span class="p">],</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'ax'</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">avg_sub</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">'scalebar_um'</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s1">'trialobj'</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                        <span class="n">_add_scalebar</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'must provide trialobj parameter to access for making scalebar.'</span><span class="p">)</span>

            <span class="c1"># make_plot(**kwargs)</span>
            <span class="n">plotImg</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="n">avg_sub</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">avg_sub</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">images</span><span class="p">)</span></div>


<div class="viewcode-block" id="SingleFrame"><a class="viewcode-back" href="../../../reference.html#imagingplus.plotting.plotting.SingleFrame">[docs]</a><span class="nd">@plotting_decorator</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">SingleFrame</span><span class="p">(</span><span class="n">tiff_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">frame_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">title</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">imstack</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    plots an image of a single specified tiff frame after reading using tifffile.</span>

<span class="sd">    :param tiff_path: path to .tiff file to loads</span>
<span class="sd">    :param frame_num: frame # from 2p imaging tiff to show (default is 0 - i.e. the first frame)</span>
<span class="sd">    :param title: (optional) give a string to use as title</span>
<span class="sd">    :return: matplotlib imshow plot</span>
<span class="sd">    """</span>
    <span class="c1"># set any kwargs provided</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'ax'</span><span class="p">]</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'fig'</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">imstack</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">tiff_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">'please provide a tiff path or input to imstack to use for plotting image.'</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">ImportTiff</span><span class="p">(</span><span class="n">tiff_path</span><span class="o">=</span><span class="n">tiff_path</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="n">frame_num</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stack</span> <span class="o">=</span> <span class="n">imstack</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">stack</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">'frame num: </span><span class="si">{</span><span class="n">frame_num</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">'scalebar_um'</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">'trialobj'</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">_add_scalebar</span><span class="p">(</span><span class="n">scalebar_um</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">'scalebar_um'</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">'must provide trialobj parameter to access for making scalebar.'</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">stack</span><span class="p">,</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>


<span class="c1"># plots the raw trace for the Flu mean of the FOV (similar to the ZProject in Fiji)</span>
<div class="viewcode-block" id="plotMeanFovFluTrace"><a class="viewcode-back" href="../../../reference.html#imagingplus.plotting.plotting.plotMeanFovFluTrace">[docs]</a><span class="nd">@plotting_decorator</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">plotMeanFovFluTrace</span><span class="p">(</span><span class="n">trialobj</span><span class="p">:</span> <span class="n">TwoPhotonImaging</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Make plot of mean fluorescence trace averaged over the whole FOV</span>

<span class="sd">    NOTE: this function will use the underlying timing that is found under trialobj.tmdata (if that is defined). If there is a mismatch in the number of frame timestamps collected and</span>
<span class="sd">    the number of imaging frames data, the shorter length will be used for plotting (with no warning printed, as it is often the case that there are dropped frames from the microscope).</span>

<span class="sd">    :param trialobj: TwoPhotonImaging (or derived) object</span>
<span class="sd">    :param kwargs:</span>
<span class="sd">        :ax: matplotlib axis object to use for plotting.</span>
<span class="sd">    """</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">trialobj</span><span class="p">,</span> <span class="s1">'meanFovFluTrace'</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">'Cannot make plot. Missing meanFovFluTrace attribute.'</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">dataplot_frame_options</span><span class="p">()</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'ax'</span><span class="p">]</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'ax'</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'lw'</span><span class="p">,</span> <span class="s1">'linewidth'</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">lw</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">lw</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">meanFovFluTrace</span>
        <span class="k">if</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">tmdata</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">trialobj</span><span class="o">.</span><span class="n">tmdata</span><span class="o">.</span><span class="n">frame_times</span><span class="p">):</span>
                <span class="n">x_range</span> <span class="o">=</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">tmdata</span><span class="o">.</span><span class="n">frame_times</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">)]</span> <span class="o">-</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">tmdata</span><span class="o">.</span><span class="n">frame_times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">trialobj</span><span class="o">.</span><span class="n">tmdata</span><span class="o">.</span><span class="n">frame_times</span><span class="p">):</span>
                <span class="n">x_range</span> <span class="o">=</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">tmdata</span><span class="o">.</span><span class="n">frame_times</span> <span class="o">-</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">tmdata</span><span class="o">.</span><span class="n">frame_times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">data_to_plot</span> <span class="o">=</span> <span class="n">data_to_plot</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">x_range</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x_range</span> <span class="o">=</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">tmdata</span><span class="o">.</span><span class="n">frame_times</span> <span class="o">-</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">tmdata</span><span class="o">.</span><span class="n">frame_times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">time_res</span> <span class="o">=</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">tmdata</span><span class="o">.</span><span class="n">sampling_rate</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_to_plot</span><span class="p">))</span>
            <span class="n">time_res</span> <span class="o">=</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">fps</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\t</span><span class="s2"> \- PLOTTING mean raw flu trace ... "</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_range</span><span class="p">,</span> <span class="n">data_to_plot</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'forestgreen'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">lw</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'frame #s'</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Flu (a.u.)'</span><span class="p">)</span>

        <span class="c1"># set axis options</span>
        <span class="n">dataplot_ax_options</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">collection_hz</span><span class="o">=</span><span class="n">time_res</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="plot_photostim_traces_overlap"><a class="viewcode-back" href="../../../reference.html#imagingplus.plotting.plotting.plot_photostim_traces_overlap">[docs]</a><span class="nd">@plotting_decorator</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">plot_photostim_traces_overlap</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">trialobj</span><span class="p">:</span> <span class="n">AllOpticalTrial</span><span class="p">,</span> <span class="n">exclude_id</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">y_spacing_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                  <span class="n">title</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span> <span class="n">x_axis</span><span class="o">=</span><span class="s1">'Time (seconds)'</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Plot fluorescence traces of alloptical stimulated cells on one plot.</span>

<span class="sd">    :param array: fluorescence traces of alloptical stimulated cells to plot.</span>
<span class="sd">    :param trialobj: AllOptical object to select cells from</span>
<span class="sd">    :param exclude_id: list of cell id's to exclude from plot</span>
<span class="sd">    :param y_spacing_factor: increase to add more space between plotted traces</span>
<span class="sd">    :param title: title of plot</span>
<span class="sd">    :param x_axis: x-axis of plot in units of Frames or Time (seconds)</span>
<span class="sd">    :param kwargs:</span>
<span class="sd">        :ax: matplotlib axis object to use for plotting.</span>


<span class="sd">    """</span>

    <span class="n">len_</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
    <span class="n">dataplot_frame_options</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'ax'</span><span class="p">]</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'ax'</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">len_</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">exclude_id</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">'linewidth'</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">linewidth</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'linewidth'</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">40</span> <span class="o">*</span> <span class="n">y_spacing_factor</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">linewidth</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">stim_start_frames</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;=</span> <span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">j</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">n_frames</span> <span class="o">-</span> <span class="mi">3000</span><span class="p">])</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># change x axis ticks to seconds</span>
    <span class="k">if</span> <span class="s1">'Time'</span> <span class="ow">in</span> <span class="n">x_axis</span> <span class="ow">or</span> <span class="s1">'time'</span> <span class="ow">in</span> <span class="n">x_axis</span><span class="p">:</span>
        <span class="c1"># change x axis ticks to every 30 seconds</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">trialobj</span><span class="o">.</span><span class="n">n_frames</span> <span class="o">//</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">fps</span><span class="p">),</span> <span class="mi">30</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">ticks</span><span class="o">=</span><span class="p">[(</span><span class="n">label</span> <span class="o">*</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">fps</span><span class="p">)</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Time (secs)'</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'top'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'right'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="p">[</span><span class="s1">'left'</span><span class="p">]</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x_axis</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">'y_lim'</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">'y_lim'</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">y_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">len_</span> <span class="o">*</span> <span class="mi">40</span> <span class="o">*</span> <span class="n">y_spacing_factor</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">array</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">y_max</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">((</span><span class="n">title</span> <span class="o">+</span> <span class="s1">' - </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="n">len_</span> <span class="o">+</span> <span class="s1">' cells'</span><span class="p">),</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">'top'</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                 <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">dataplot_ax_options</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>



<span class="c1">### photostim analysis - PLOT avg over photostim. trials traces for the provided traces</span>
<span class="c1"># todo decide which photostim avg plot func to keep</span>
<div class="viewcode-block" id="plot_periphotostim_avg2"><a class="viewcode-back" href="../../../reference.html#imagingplus.plotting.plotting.plot_periphotostim_avg2">[docs]</a><span class="nd">@plotting_decorator</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">plot_periphotostim_avg2</span><span class="p">(</span><span class="n">dataset</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legend_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">avg_with_std</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">title</span><span class="o">=</span><span class="s1">'high quality plot'</span><span class="p">,</span> <span class="n">pre_stim_sec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">TODO fill documentation and add parameters</span>
<span class="sd">    :param dataset:</span>
<span class="sd">    :param fps:</span>
<span class="sd">    :param legend_labels:</span>
<span class="sd">    :param colors:</span>
<span class="sd">    :param avg_with_std:</span>
<span class="sd">    :param title:</span>
<span class="sd">    :param pre_stim_sec:</span>
<span class="sd">    :param ylim:</span>
<span class="sd">    :param fig:</span>
<span class="sd">    :param ax:</span>
<span class="sd">    :param kwargs:</span>
<span class="sd">    """</span>
    <span class="c1"># if 'fig' in kwargs.keys():</span>
    <span class="c1">#     fig = kwargs['fig']</span>
    <span class="c1">#     ax = kwargs['ax']</span>
    <span class="c1"># else:</span>
    <span class="c1">#     if 'figsize' in kwargs.keys():</span>
    <span class="c1">#         fig, ax = plt.subplots(figsize=kwargs['figsize'])</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         fig, ax = plt.subplots(figsize=[5, 4])</span>

    <span class="n">meantraces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">stdtraces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">legend_labels</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">),</span> <span class="nb">print</span><span class="p">(</span><span class="s1">'please provide same number of legend labels as dataset'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">colors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">make_random_color_array</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">legend_labels</span><span class="p">)</span>
        <span class="n">avg_only</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">'-- plotting average +/- std fill for each dataset'</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)):</span>
            <span class="n">meanst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">meantraces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meanst</span><span class="p">)</span>
            <span class="n">stdtraces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">std</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">meanst</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">meantraces</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">"|--- length mismatch in mean traces of datasets... </span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">, shape0 </span><span class="si">{</span><span class="n">meanst</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> and shape1 </span><span class="si">{</span><span class="n">meantraces</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">std</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">stdtraces</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">"|--- length mismatch in std traces of datasets...</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s2">, shape0 </span><span class="si">{</span><span class="n">std</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> and shape1 </span><span class="si">{</span><span class="n">stdtraces</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">list</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
        <span class="n">meanst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">meantraces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meanst</span><span class="p">)</span>
        <span class="n">stdtraces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">std</span><span class="p">)</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'black'</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="ne">AttributeError</span><span class="p">(</span>
            <span class="s1">'please provide the cellsdata to plot in a ls format, each different cellsdata group as a ls item...'</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">'xlabel'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'xlabel'</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="s1">'key_frames'</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'xlabel'</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">'Frames'</span> <span class="ow">not</span> <span class="ow">in</span> \
            <span class="n">kwargs</span><span class="p">[</span>
                <span class="s1">'xlabel'</span><span class="p">]:</span>
        <span class="c1">## change xaxis to time (secs)</span>
        <span class="k">if</span> <span class="n">fps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pre_stim_sec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">x_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">meantraces</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">fps</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="n">meantraces</span><span class="p">[</span>
                        <span class="mi">0</span><span class="p">]))</span> <span class="o">-</span> <span class="n">pre_stim_sec</span>  <span class="c1"># x scale, but in time domain (transformed from key_frames based on the provided fps)</span>
                <span class="k">if</span> <span class="s1">'xlabel'</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">'xlabel'</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Time post stim (secs)'</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">'need to provide a pre_stim_sec value to the function call!'</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="ne">AttributeError</span><span class="p">(</span><span class="s1">'need to provide fps value to convert xaxis in units of time (secs)'</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s1">'key_frames'</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'xlabel'</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">'Frames'</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'xlabel'</span><span class="p">]:</span>
        <span class="n">x_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">meanst</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Frames'</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">meantraces</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">avg_with_std</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">meantraces</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_range</span><span class="p">):</span>  <span class="c1">## TEMP FIX</span>
                <span class="n">mismatch</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x_range</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">meantraces</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                <span class="n">meantraces</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">meantraces</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">mismatch</span><span class="p">)</span>
                <span class="n">stdtraces</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stdtraces</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">mismatch</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s1">'|------ adding </span><span class="si">{</span><span class="n">mismatch</span><span class="si">}</span><span class="s1"> zeros to mean and std-fill traces to make the arrays the same length, new length of plot array: </span><span class="si">{</span><span class="n">meantraces</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s1"> '</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_range</span><span class="p">,</span> <span class="n">meantraces</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_range</span><span class="p">,</span> <span class="n">meantraces</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">stdtraces</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">meantraces</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">stdtraces</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span>
                            <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_range</span><span class="p">,</span> <span class="n">meantraces</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">trace</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_range</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">legend_labels</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">'fontsize'</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">fontsize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'fontsize'</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fontsize</span> <span class="o">=</span> <span class="s1">'medium'</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">legend_labels</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ylim</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">if</span> <span class="s1">'ylabel'</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">'ylabel'</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="s1">'savepath'</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">'savepath'</span><span class="p">])</span></div>

    <span class="c1"># # finalize plot, set title, and show or return axes</span>
    <span class="c1"># ax.set_title(title)</span>
    <span class="c1"># if 'show' in kwargs.keys():</span>
    <span class="c1">#     fig.show() if kwargs['show'] else None</span>
    <span class="c1"># else:</span>
    <span class="c1">#     fig.show()</span>
    <span class="c1">#</span>
    <span class="c1"># if 'fig' in kwargs.keys():</span>
    <span class="c1">#     return fig, ax</span>


<span class="c1">### photostim analysis - PLOT avg over all photstim. trials traces from PHOTOSTIM TARGETTED cells</span>
<div class="viewcode-block" id="plot_periphotostim_avg"><a class="viewcode-back" href="../../../reference.html#imagingplus.plotting.plotting.plot_periphotostim_avg">[docs]</a><span class="nd">@plotting_decorator</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">plot_periphotostim_avg</span><span class="p">(</span><span class="n">arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">trialobj</span><span class="p">:</span> <span class="n">AllOpticalTrial</span><span class="p">,</span> <span class="n">pre_stim_sec</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">post_stim_sec</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">''</span><span class="p">,</span>
                           <span class="n">avg_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">x_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">y_label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    plot trace across all stims</span>
<span class="sd">    :param arr: Flu traces to plot (will be plotted as individual traces unless avg_only is True) dimensions should be cells x stims x key_frames</span>
<span class="sd">    :param trialobj: instance object of AllOpticalTrial</span>
<span class="sd">    :param pre_stim_sec: seconds of array to plot for pre-stim period</span>
<span class="sd">    :param post_stim_sec: seconds of array to plot for post-stim period</span>
<span class="sd">    :param title: title to use for plot</span>
<span class="sd">    :param avg_only: if True, only plot the mean trace calculated from the traces provided in arr</span>
<span class="sd">    :param x_label: x axis label</span>
<span class="sd">    :param y_label: y axis label</span>
<span class="sd">    :param kwargs:</span>
<span class="sd">        options include:</span>
<span class="sd">            'stim_duration': photostimulation duration in secs</span>
<span class="sd">            'y_lims': tuple, y min and max of the plot</span>
<span class="sd">            'edgecolor': str, edgecolor of the individual traces behind the mean trace</span>
<span class="sd">            'savepath': str, path to save plot to</span>

<span class="sd">    :param fig: a matplotlib.Figure instance, if provided use this fig for plotting</span>
<span class="sd">    :param ax: a matplotlib.Axes.axes instance, if provided use this ax for plotting</span>
<span class="sd">    :param show: if False, do not display plot (used when the necessity is to return the fig and ax objects to futher manipulation)</span>
<span class="sd">    :returns fig, ax: returns fig and ax object, if show is False</span>

<span class="sd">    """</span>

    <span class="n">fps</span> <span class="o">=</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">fps</span>  <span class="c1"># key_frames per second rate of the imaging cellsdata collection for the cellsdata to be plotted</span>
    <span class="n">exp_prestim</span> <span class="o">=</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">pre_stim_frames</span>  <span class="c1"># key_frames of pre-stim cellsdata collected for each trace for this trialobj (should be same as what's under trialobj.pre_stim_sec)</span>
    <span class="k">if</span> <span class="s1">'stim_duration'</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">stim_duration</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'stim_duration'</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">stim_duration</span> <span class="o">=</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">twopstim</span><span class="o">.</span><span class="n">stim_dur</span> <span class="o">/</span> <span class="mi">1000</span>  <span class="c1"># seconds of stimulation duration</span>

    <span class="n">dataplot_frame_options</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'ax'</span><span class="p">]</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'ax'</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="c1"># x range in time (secs)</span>
    <span class="n">x_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">fps</span><span class="p">,</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span>
        <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">pre_stim_sec</span>  <span class="c1"># x scale, but in time domain (transformed from key_frames based on the provided fps)</span>

    <span class="n">len_</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="n">flu_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># ax.margins(x=0.07)</span>

    <span class="k">if</span> <span class="s1">'alpha'</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'alpha'</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.2</span>

    <span class="k">if</span> <span class="n">x_label</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="s1">'Frames'</span> <span class="ow">in</span> <span class="n">x_label</span> <span class="ow">or</span> <span class="s1">'key_frames'</span> <span class="ow">in</span> <span class="n">x_label</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x_time</span>  <span class="c1"># set the x plotting range</span>
        <span class="k">if</span> <span class="n">x_label</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x_label</span> <span class="o">=</span> <span class="n">x_label</span> <span class="o">+</span> <span class="s1">'post-stimulation relative'</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_label</span> <span class="o">=</span> <span class="s1">'Time (secs post-stimulation)'</span>

        <span class="k">if</span> <span class="n">avg_only</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># ax.axvspan(exp_prestim/fps, (exp_prestim + stim_duration + 1) / fps, alpha=alpha, color='plum', zorder = 3)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="mi">0</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">fps</span><span class="p">,</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">stim_duration</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">fps</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'plum'</span><span class="p">,</span>
                       <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># note that we are setting 0 as the stimulation time</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="mi">0</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">fps</span><span class="p">,</span> <span class="mi">0</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">fps</span> <span class="o">+</span> <span class="n">stim_duration</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'plum'</span><span class="p">,</span>
                       <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># note that we are setting 0 as the stimulation time</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">exp_prestim</span><span class="p">,</span> <span class="n">exp_prestim</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">stim_duration</span> <span class="o">*</span> <span class="n">fps</span><span class="p">),</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'tomato'</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">avg_only</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">cell_trace</span> <span class="ow">in</span> <span class="n">arr</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">'color'</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cell_trace</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">'color'</span><span class="p">],</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
                    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cell_trace</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">flu_avg</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'black'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">2.3</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># plot average trace</span>

    <span class="k">if</span> <span class="s1">'y_lims'</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">'y_lims'</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">pre_stim_sec</span> <span class="ow">and</span> <span class="n">post_stim_sec</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x_label</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="s1">'Frames'</span> <span class="ow">in</span> <span class="n">x_label</span> <span class="ow">or</span> <span class="s1">'key_frames'</span> <span class="ow">in</span> <span class="n">x_label</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="n">pre_stim_sec</span><span class="p">,</span>
                        <span class="n">stim_duration</span> <span class="o">+</span> <span class="n">post_stim_sec</span><span class="p">)</span>  <span class="c1"># remember that x axis is set to be relative to the stim time (i.e. stim is at t = 0)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">exp_prestim</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">pre_stim_sec</span> <span class="o">*</span> <span class="n">fps</span><span class="p">),</span>
                        <span class="n">exp_prestim</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">stim_duration</span> <span class="o">*</span> <span class="n">fps</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">post_stim_sec</span> <span class="o">*</span> <span class="n">fps</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># set axis labels</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">x_label</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">y_label</span><span class="p">)</span>

    <span class="k">if</span> <span class="s1">'savepath'</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">'savepath'</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">((</span><span class="n">title</span> <span class="o">+</span> <span class="s1">' - </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="n">len_</span> <span class="o">+</span> <span class="s1">' traces'</span><span class="p">),</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">'top'</span><span class="p">,</span>
                     <span class="n">pad</span><span class="o">=</span><span class="n">pad</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">dataplot_ax_options</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<span class="c1"># alloptical trial</span>
<span class="c1">### plot the location of all SLM targets, along with option for plotting the mean img of the current trial</span>

<div class="viewcode-block" id="plot_SLMtargets_Locs"><a class="viewcode-back" href="../../../reference.html#imagingplus.plotting.plotting.plot_SLMtargets_Locs">[docs]</a><span class="nd">@mpl</span><span class="o">.</span><span class="n">rc_context</span><span class="p">(</span><span class="n">image_frame_ops</span><span class="p">)</span>
<span class="nd">@plotting_decorator</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="k">def</span> <span class="nf">plot_SLMtargets_Locs</span><span class="p">(</span><span class="n">trialobj</span><span class="p">:</span> <span class="n">AllOpticalTrial</span><span class="p">,</span> <span class="n">targets_coords</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'all'</span><span class="p">,</span>
                         <span class="n">background</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    plot SLM target coordinate locations</span>

<span class="sd">    :param trialobj:</span>
<span class="sd">    :param targets_coords: ls containing (x,y) coordinates of targets to plot</span>
<span class="sd">    :param background:</span>
<span class="sd">    :param kwargs:</span>
<span class="sd">    :param fig: a matplotlib.Figure instance, if provided use this fig for plotting</span>
<span class="sd">    :param ax: a matplotlib.Axes.axes instance, if provided use this ax for plotting</span>
<span class="sd">    :param show: if False, do not display plot (used when the necessity is to return the fig and ax objects to futher manipulation)</span>
<span class="sd">    :returns fig, ax: returns fig and ax object, if show is False</span>

<span class="sd">    """</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">trialobj</span><span class="p">)</span> <span class="o">==</span> <span class="n">AllOpticalTrial</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ObjectClassError</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="s1">'plot_SLMtargets_Locs'</span><span class="p">,</span> <span class="n">valid_class</span><span class="o">=</span><span class="p">[</span><span class="n">AllOpticalTrial</span><span class="p">],</span>
                               <span class="n">invalid_class</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">trialobj</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'ax'</span><span class="p">]</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'fig'</span><span class="p">]</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'ax'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">background</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">background</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">trialobj</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">frame_x</span><span class="p">,</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">frame_y</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">'uint16'</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">background</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">background</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">)</span>

    <span class="n">colors</span> <span class="o">=</span> <span class="n">make_random_color_array</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trialobj</span><span class="o">.</span><span class="n">twopstim</span><span class="o">.</span><span class="n">target_coords</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">targets_coords</span> <span class="ow">is</span> <span class="s1">'all'</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">trialobj</span><span class="o">.</span><span class="n">twopstim</span><span class="o">.</span><span class="n">target_coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">trialobj</span><span class="o">.</span><span class="n">twopstim</span><span class="o">.</span><span class="n">target_coords</span><span class="p">)):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">trialobj</span><span class="o">.</span><span class="n">twopstim</span><span class="o">.</span><span class="n">target_coords</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">trialobj</span><span class="o">.</span><span class="n">twopstim</span><span class="o">.</span><span class="n">target_coords</span><span class="p">[</span><span class="n">i</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">],</span>
                           <span class="n">edgecolors</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">facecolors</span><span class="o">=</span><span class="s1">'none'</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">'SLM Group </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
                <span class="c1"># for (x, y) in trialobj.twopstim.target_coords[i]:</span>
                <span class="c1">#     ax.scatter(x=x, y=y, edgecolors=colors[i], facecolors='none', linewidths=2.0)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">'edgecolors'</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">edgecolors</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'edgecolors'</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">edgecolors</span> <span class="o">=</span> <span class="s1">'yellowgreen'</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="n">trialobj</span><span class="o">.</span><span class="n">twopstim</span><span class="o">.</span><span class="n">target_coords_all</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">edgecolors</span><span class="o">=</span><span class="n">edgecolors</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s1">'none'</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">targets_coords</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">'edgecolors'</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">edgecolors</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'edgecolors'</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">edgecolors</span> <span class="o">=</span> <span class="s1">'yellowgreen'</span>
        <span class="n">plot_coordinates</span><span class="p">(</span><span class="n">coords</span><span class="o">=</span><span class="n">targets_coords</span><span class="p">,</span> <span class="n">frame_x</span><span class="o">=</span><span class="n">trialobj</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">frame_x</span><span class="p">,</span> <span class="n">frame_y</span><span class="o">=</span><span class="n">trialobj</span><span class="o">.</span><span class="n">imparams</span><span class="o">.</span><span class="n">frame_y</span><span class="p">,</span>
                         <span class="n">edgecolors</span><span class="o">=</span><span class="n">edgecolors</span><span class="p">,</span>
                         <span class="n">background</span><span class="o">=</span><span class="n">background</span><span class="p">,</span> <span class="n">fig</span><span class="o">=</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'upper right'</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="s1">'white'</span><span class="p">,</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">margins</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">_add_scalebar</span><span class="p">(</span><span class="n">trialobj</span><span class="o">=</span><span class="n">trialobj</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

    <span class="c1"># fig.tight_layout()</span>

    <span class="k">if</span> <span class="s1">'title'</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">'title'</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">'title'</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">'SLM targets location - </span><span class="si">{</span><span class="n">trialobj</span><span class="o">.</span><span class="n">t_series_name</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span></div>


<span class="c1"># alloptical trial plotting</span>


<div class="viewcode-block" id="plot_s2pMasks"><a class="viewcode-back" href="../../../reference.html#imagingplus.plotting.plotting.plot_s2pMasks">[docs]</a><span class="k">def</span> <span class="nf">plot_s2pMasks</span><span class="p">():</span>
    <span class="sd">""" Creates some images of SLM targets to suite2p cells.</span>

<span class="sd">    """</span>
    <span class="k">pass</span></div>


<span class="c1"># todo need to find new place for this:</span>
<div class="viewcode-block" id="export_klicker_to_csv"><a class="viewcode-back" href="../../../reference.html#imagingplus.plotting.plotting.export_klicker_to_csv">[docs]</a><span class="k">def</span> <span class="nf">export_klicker_to_csv</span><span class="p">(</span><span class="n">klicker</span><span class="p">:</span> <span class="n">mpl_point_clicker</span><span class="o">.</span><span class="n">clicker</span><span class="p">,</span> <span class="n">csv_path</span><span class="p">):</span>
    <span class="sd">"""Save point cellsdata from mplpointclicker klicker to .csv</span>
<span class="sd">    :param klicker: mplpointclicker klicker object</span>
<span class="sd">    :param csv_path: path to save csv file of klicker points</span>
<span class="sd">    """</span>
    <span class="n">_columns</span> <span class="o">=</span> <span class="p">[</span><span class="o">*</span><span class="n">klicker</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="o">*</span><span class="n">klicker</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()]:</span>
        <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">klicker</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()[</span><span class="n">i</span><span class="p">][:,</span>
                  <span class="mi">0</span><span class="p">]</span>  <span class="c1"># take just the x coord of the clicked point from klicker (i.e. time value)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">save_to_csv</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">csv_path</span><span class="p">)</span></div>
</pre></div>
<div class="clearer"></div>
</div>
</div>
</div>
<div aria-label="main navigation" class="sphinxsidebar" role="navigation">
<div class="sphinxsidebarwrapper">
<p class="logo"><a href="../../../index.html">
<img alt="Logo" class="logo" src="../../../_static/imagingplus-logo.png"/>
</a></p>
<div id="searchbox" role="search" style="display: none">
<h3 id="searchlabel">Quick search</h3>
<div class="searchformwrapper">
<form action="../../../search.html" class="search" method="get">
<input aria-labelledby="searchlabel" autocapitalize="off" autocomplete="off" autocorrect="off" name="q" spellcheck="false" type="text"/>
<input type="submit" value="Go"/>
</form>
</div>
</div>
<script>$('#searchbox').show(0);</script>
</div>
</div>
<div class="clearer"></div>
</div>
<div aria-label="related navigation" class="related" role="navigation">
<h3>Navigation</h3>
<ul>
<li class="right" style="margin-right: 10px">
<a href="../../../genindex.html" title="General Index">index</a></li>
<li class="right">
<a href="../../../py-modindex.html" title="Python Module Index">modules</a> |</li>
<li class="nav-item nav-item-0"><a href="../../../index.html">imaging+ 0.2-beta documentation</a> »</li>
<li class="nav-item nav-item-1"><a href="../../index.html">Module code</a> »</li>
<li class="nav-item nav-item-this"><a href="">imagingplus.plotting.plotting</a></li>
</ul>
</div>
<div class="footer" role="contentinfo">
        © Copyright 2022, Packer Lab.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.4.0.
    </div>
</body>
</html>